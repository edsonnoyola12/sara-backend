# Arquitectura de SARA CRM

## Diagrama General

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USUARIOS                                        │
├──────────────────┬───────────────────┬──────────────────────────────────────┤
│   Lead (WhatsApp) │  Team (WhatsApp)  │           CRM Web                    │
└────────┬─────────┴─────────┬─────────┴──────────────┬───────────────────────┘
         │                   │                         │
         ▼                   ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        META WHATSAPP CLOUD API                               │
│                    (Webhook → sara-backend.workers.dev)                      │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CLOUDFLARE WORKERS                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        src/index.ts                                  │    │
│  │  • Router HTTP (239 endpoints)                                       │    │
│  │  • CRONs (3 triggers)                                                │    │
│  │  • Autenticación API_SECRET                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                 │                                            │
│  ┌──────────────────────────────┼──────────────────────────────────────┐    │
│  │                              ▼                                       │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │    │
│  │  │  whatsapp.ts    │  │ aiConversation  │  │ metaWhatsApp        │  │    │
│  │  │  (Handler)      │──│ Service.ts      │──│ Service.ts          │  │    │
│  │  │  11K líneas     │  │ (IA + Prompts)  │  │ (Envío mensajes)    │  │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │    │
│  │           │                    │                     │               │    │
│  │  ┌────────┴────────┬──────────┴─────────┬───────────┴────────┐     │    │
│  │  ▼                 ▼                    ▼                    ▼     │    │
│  │  ceoCommands    vendorCommands    asesorCommands    creditFlow    │    │
│  │  Service        Service           Service           Service       │    │
│  └──────────────────────────────────────────────────────────────────┘    │
│                                 │                                            │
│  ┌──────────────────────────────┼──────────────────────────────────────┐    │
│  │                              ▼                                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │    │
│  │  │ SARA_CACHE  │  │ ClaudeAPI   │  │ Google Cal  │  │ Veo 3      │  │    │
│  │  │ (KV)        │  │ (Anthropic) │  │ (Calendar)  │  │ (Videos)   │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            SUPABASE                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   leads     │  │ team_members│  │appointments │  │ properties          │ │
│  │   (7+)      │  │   (20)      │  │   (N)       │  │   (36)              │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ monthly_    │  │ vendor_     │  │ mortgage_   │  │ conversation_       │ │
│  │ goals       │  │ monthly_    │  │ applications│  │ history             │ │
│  │             │  │ goals       │  │             │  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Flujo de Mensaje Entrante

```
Lead envía "Hola"
       │
       ▼
┌──────────────────┐
│ Meta Webhook     │
│ POST /webhook    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ Validar firma    │────▶│ Rechazar si      │
│ (opcional)       │ NO  │ firma inválida   │
└────────┬─────────┘     └──────────────────┘
         │ OK
         ▼
┌──────────────────┐     ┌──────────────────┐
│ ¿Es team member? │────▶│ Procesar como    │
│                  │ SÍ  │ COMANDO          │
└────────┬─────────┘     └──────────────────┘
         │ NO
         ▼
┌──────────────────┐
│ getOrCreateLead  │
│ (Supabase)       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ ¿Bridge activo?  │────▶│ Reenviar a       │
│                  │ SÍ  │ team member      │
└────────┬─────────┘     └──────────────────┘
         │ NO
         ▼
┌──────────────────┐
│ aiConversation   │
│ Service          │
│ (Claude API)     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Enviar respuesta │
│ (Meta API)       │
└──────────────────┘
```

---

## Flujo de Comando (Team Member)

```
Vendedor envía "citas"
       │
       ▼
┌──────────────────┐
│ Meta Webhook     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Identificar      │
│ team member      │
│ por teléfono     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ detectCommand()  │
│ (por rol)        │
└────────┬─────────┘
         │
    ┌────┴────┬────────────┬────────────┐
    ▼         ▼            ▼            ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│CEO     │ │Vendor  │ │Asesor  │ │Agencia │
│Commands│ │Commands│ │Commands│ │Commands│
└────┬───┘ └────┬───┘ └────┬───┘ └────┬───┘
     │          │          │          │
     └──────────┴──────────┴──────────┘
                    │
                    ▼
            ┌──────────────────┐
            │ Enviar respuesta │
            │ al team member   │
            └──────────────────┘
```

---

## Flujo de Video Veo 3

```
Lead califica para video
       │
       ▼
┌──────────────────┐
│ Insertar en      │
│ pending_videos   │
└────────┬─────────┘
         │
         ▼ (CRON cada 2 min)
┌──────────────────┐
│ Generar prompt   │
│ personalizado    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Veo 3 API        │
│ (Google)         │
│ ~2 min           │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Descargar video  │
│ (Buffer)         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ uploadVideoFrom  │
│ Buffer() → Meta  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ sendWhatsApp     │
│ VideoById()      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Marcar como      │
│ sent=true        │
└──────────────────┘
```

---

## Flujo de Crédito Hipotecario

```
Lead: "Me interesa un crédito"
       │
       ▼
┌──────────────────┐
│ Detectar intent  │
│ de crédito       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Iniciar flujo    │
│ credit_flow      │
└────────┬─────────┘
         │
    ┌────┴────────────────────────────────┐
    │  Preguntas de calificación          │
    │  1. ¿Trabajas formal/informal?      │
    │  2. ¿Ingresos mensuales?            │
    │  3. ¿Historial crediticio?          │
    │  4. ¿Ahorro para enganche?          │
    └────┬────────────────────────────────┘
         │
         ▼
┌──────────────────┐     ┌──────────────────┐
│ ¿Califica?       │────▶│ Mensaje de       │
│                  │ NO  │ no calificación  │
└────────┬─────────┘     └──────────────────┘
         │ SÍ
         ▼
┌──────────────────┐
│ Crear mortgage_  │
│ application      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Asignar asesor   │
│ (round-robin)    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Notificar a      │
│ asesor + lead    │
└──────────────────┘
```

---

## CRONs

| Cron | Schedule | Función |
|------|----------|---------|
| Check leads | `*/2 * * * *` | Leads sin asignar, pricing |
| Follow-ups | `0 14 * * 1-5` | Envío de follow-ups pendientes |
| Nocturno | `0 1 * * *` | Limpieza, estadísticas |
