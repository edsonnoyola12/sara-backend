import { SupabaseService } from '../services/supabase';
import { OpenAIService } from '../services/openai';
import { TwilioService } from '../services/twilio';

const VIDEO_SERVER_URL = 'https://sara-videos.onrender.com';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERFACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AIAnalysis {
  intent: string;
  extracted_data: {
    nombre?: string;
    fecha?: string;
    hora?: string;
    desarrollo?: string;
    desarrollos?: string[];  // MÃºltiples desarrollos
    modelos?: string[];      // Modelos/casas especÃ­ficas
    num_recamaras?: number;
    necesita_credito?: boolean;
    // CAMPOS DE CRÃ‰DITO - OpenAI extrae aunque tenga typos
    banco_preferido?: string;      // "Scotiabank" aunque escriba "soctia"
    ingreso_mensual?: number;      // 67000 aunque escriba "67 mil"
    enganche_disponible?: number;  // 234000 aunque escriba "234m1l"
    modalidad_contacto?: string;   // "telefonica"|"videollamada"|"presencial"
    quiere_asesor?: boolean;       // true si dice "sÃ­", "va", "sale", etc
  };
  response: string;
  send_gps?: boolean;
  send_video_desarrollo?: boolean;
  send_contactos?: boolean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASE PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export class WhatsAppHandler {
  // Normaliza telefono mexicano a formato Twilio: +521XXXXXXXXXX
  private formatPhoneMX(phone: string): string {
    const digits = phone.replace(/\D/g, '');
    if (digits.length === 10) {
      return 'whatsapp:+521' + digits;
    } else if (digits.length === 12 && digits.startsWith('52')) {
      return 'whatsapp:+521' + digits.slice(2);
    } else if (digits.length === 13 && digits.startsWith('521')) {
      return 'whatsapp:+' + digits;
    } else {
      return 'whatsapp:+521' + digits.slice(-10);
    }
  }


  constructor(
    private supabase: SupabaseService,
    private openai: OpenAIService,
    private twilio: TwilioService,
    private calendar: any
  ) {}

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LISTAS DE DESARROLLOS Y MODELOS CONOCIDOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  private readonly DESARROLLOS_CONOCIDOS = [
    'Monte Verde', 'Monte Real', 'Los Encinos', 'Miravalle', 'Andes', 'Distrito Falco'
  ];
  
  private readonly MODELOS_CONOCIDOS = [
    // Los Encinos
    'Ascendente', 'Descendente', 'Encino Blanco', 'Encino Verde', 'Encino Dorado',
    // Andes
    'Gardenia', 'Dalia', 'Lavanda', 'Azalea', 'Magnolia',
    // Distrito Falco
    'Calandria', 'ColibrÃ­', 'Colibri', 'Chipre', 'Mirlo',
    // Monte Verde
    'Pino', 'Roble', 'Cedro',
    // Monte Real
    'Real I', 'Real II', 'Real III',
    // Miravalle
    'Bilbao', 'Vizcaya', 'Navarra'
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PARSEAR MÃšLTIPLES DESARROLLOS Y MODELOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private parsearDesarrollosYModelos(texto: string): { desarrollos: string[], modelos: string[] } {
    const textoLower = texto.toLowerCase();
    const desarrollos: string[] = [];
    const modelos: string[] = [];
    
    // Buscar desarrollos mencionados
    for (const dev of this.DESARROLLOS_CONOCIDOS) {
      if (textoLower.includes(dev.toLowerCase())) {
        desarrollos.push(dev);
      }
    }
    
    // Buscar modelos/casas especÃ­ficas mencionadas
    for (const modelo of this.MODELOS_CONOCIDOS) {
      if (textoLower.includes(modelo.toLowerCase())) {
        modelos.push(modelo);
      }
    }
    
    return { desarrollos, modelos };
  }

  // Obtener propiedades para mÃºltiples desarrollos
  private getPropsParaDesarrollos(desarrollos: string[], properties: any[]): any[] {
    const props: any[] = [];
    const seen = new Set<string>();
    
    for (const dev of desarrollos) {
      const propsDelDesarrollo = properties.filter(p => 
        p.development?.toLowerCase().includes(dev.toLowerCase())
      );
      for (const prop of propsDelDesarrollo) {
        if (!seen.has(prop.id)) {
          seen.add(prop.id);
          props.push(prop);
        }
      }
    }
    return props;
  }

  // Obtener propiedades para modelos especÃ­ficos
  private getPropsParaModelos(modelos: string[], properties: any[]): any[] {
    const props: any[] = [];
    const seen = new Set<string>();
    
    for (const modelo of modelos) {
      const propDelModelo = properties.find(p => 
        p.model?.toLowerCase().includes(modelo.toLowerCase()) ||
        p.name?.toLowerCase().includes(modelo.toLowerCase())
      );
      if (propDelModelo && !seen.has(propDelModelo.id)) {
        seen.add(propDelModelo.id);
        props.push(propDelModelo);
      }
    }
    return props;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MÃ‰TODO PRINCIPAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async handleIncomingMessage(from: string, body: string, rawRequest?: any): Promise<void> {
    try {
      const trimmedBody = (body || '').trim();
      
      // Filtrar status callbacks de Twilio
      if (rawRequest?.SmsStatus || rawRequest?.MessageStatus || rawRequest?.EventType) {
        console.log('â­ï¸ Ignorando status callback');
        return;
      }
      
      // Filtrar mensajes vacÃ­os o status
      const ignoredMessages = ['OK', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'QUEUED'];
      if (!trimmedBody || ignoredMessages.includes(trimmedBody.toUpperCase())) {
        console.log('â­ï¸ Ignorando:', trimmedBody);
        return;
      }

      console.log('ğŸ“± Mensaje de:', from, '-', body);
      const cleanPhone = from.replace('whatsapp:', '').replace('+', '');

      // Obtener datos
      const [lead, properties, teamMembers] = await Promise.all([
        this.getOrCreateLead(cleanPhone),
        this.getAllProperties(),
        this.getAllTeamMembers()
      ]);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // DETECTAR SI ES VENDEDOR/ASESOR
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const vendedor = teamMembers.find((tm: any) => {
        if (!tm.phone) return false;
        const tmPhone = tm.phone.replace(/\D/g, '').slice(-10);
        const msgPhone = cleanPhone.replace(/\D/g, '').slice(-10);
        return tmPhone === msgPhone;
      });

      if (vendedor) {
        // Detectar rol especÃ­fico
        const rol = vendedor.role?.toLowerCase() || 'vendedor';
        
        if (rol.includes('asesor') || rol.includes('hipoteca') || rol.includes('credito')) {
          console.log('ğŸ¦ MODO ASESOR HIPOTECARIO detectado:', vendedor.name);
          await this.handleAsesorMessage(from, body, vendedor, teamMembers);
          return;
        }
        
        console.log('ğŸ‘” MODO VENDEDOR detectado:', vendedor.name);
        await this.handleVendedorMessage(from, body, vendedor, teamMembers);
        return;
      }

      // Si el lead estÃ¡ en encuesta, manejar encuesta
      if (lead.survey_step > 0) {
        console.log('ğŸ“‹ Lead en encuesta, step:', lead.survey_step);
        await this.handleSurveyResponse(from, body, lead);
        return;
      }

      // REFERIDO desde cliente: "Referido Juan 5512345678"
      const refClientMatch = body.match(/^r[eÃ©i]f[eÃ©i]r[iÃ­]?do\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+)\s+(\d{10,})/i);
      if (refClientMatch && lead.status === 'delivered') {
        const nombreRef = refClientMatch[1].trim();
        const telRef = refClientMatch[2].replace(/\D/g, '').slice(-10);
        
        // Crear lead referido
        await this.supabase.client.from('leads').insert({
          name: nombreRef,
          phone: '521' + telRef,
          source: 'referido',
          referrer_id: lead.id,
          assigned_to: lead.assigned_to,
          status: 'new',
          score: 80,
          notes: { referido_por: lead.name, fecha_referido: new Date().toISOString() }
        });
        
        // Notificar al vendedor
        if (lead.assigned_to) {
          const { data: vendedorData } = await this.supabase.client
            .from('team_members')
            .select('phone, name')
            .eq('id', lead.assigned_to)
            .single();
          if (vendedorData?.phone) {
            await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(vendedorData.phone),
              'ğŸ *REFERIDO NUEVO*\n\n' +
              'Tu cliente *' + (lead.name || 'Cliente') + '* te refirio a:\n' +
              'ğŸ‘¤ ' + nombreRef + '\n' +
              'ğŸ“± ' + telRef + '\n\n' +
              'Contactalo pronto.');
          }
        }
        
        // Confirmar al cliente
        await this.twilio.sendWhatsAppMessage(from,
          'ğŸ‰ *Gracias por tu referido!*\n\n' +
          'Ya registramos a *' + nombreRef + '* y tu asesor lo contactara pronto.\n\n' +
          'Cuando compre, recibiras tus beneficios del Programa Embajador. ğŸ');
        
        // Mensaje al referido
        await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(telRef),
          'ğŸ‘‹ Hola *' + nombreRef.split(' ')[0] + '*!\n\n' +
          'Tu amigo *' + (lead.name?.split(' ')[0] || '') + '* te recomendo con Grupo Santa Rita para ayudarte a encontrar tu casa ideal. ğŸ \n\n' +
          'Pronto te contactara uno de nuestros asesores.\n\n' +
          'Responde *SI* si quieres ver opciones de casas.');
        
        console.log('ğŸ Referido registrado:', nombreRef, telRef);
        return;
      }

      // Analizar con IA
      const analysis = await this.analyzeWithAI(body, lead, properties);
      console.log('ğŸ§  AI Analysis:', JSON.stringify(analysis, null, 2));

      // Si la IA detectÃ³ nombre y el lead no lo tenÃ­a, actualizar en memoria
      if (analysis.extracted_data?.nombre && !lead.name) {
        lead.name = analysis.extracted_data.nombre;
        console.log('âœ… Nombre actualizado en memoria:', lead.name);
      }

      // Ejecutar
      await this.executeAIDecision(analysis, from, cleanPhone, lead, properties, teamMembers, body);

    } catch (error) {
      console.error('âŒ Error:', error);
      await this.twilio.sendWhatsAppMessage(from, 'Disculpa, tuve un problema tÃ©cnico. Â¿Puedes repetir tu mensaje? ğŸ™');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODO ASISTENTE VENDEDOR
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ENCUESTA DE SATISFACCIÃ“N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  private async handleSurveyResponse(from: string, body: string, lead: any): Promise<void> {
    const mensaje = body.toLowerCase().trim();
    const step = lead.survey_step;
    const isDelivered = lead.status === 'delivered';
    
    // DELIVERED: Steps 1-6
    // FALLEN: Steps 10-15
    
    // Step 1 o 10: Espera "SÃ" para comenzar
    if (step === 1 || step === 10) {
      if (mensaje.includes('si') || mensaje.includes('sÃ­') || mensaje === 'ok' || mensaje === 'dale') {
        const nextStep = isDelivered ? 2 : 11;
        const pregunta = isDelivered 
          ? 'Â¡Gracias! ğŸ™Œ\n\n*Pregunta 1 de 5*\nÂ¿CuÃ¡ndo es tu cumpleaÃ±os?\n(ej: 15 marzo)'
          : 'Â¡Gracias por tu tiempo! ğŸ™\n\n*Pregunta 1 de 5*\nÂ¿QuÃ© fue lo que no te convenciÃ³?';
        
        await this.supabase.client.from('leads').update({ survey_step: nextStep }).eq('id', lead.id);
        await this.twilio.sendWhatsAppMessage(from, pregunta);
      } else {
        await this.twilio.sendWhatsAppMessage(from, 'Responde *SÃ* cuando estÃ©s listo para continuar ğŸ™');
      }
      return;
    }
    
    // DELIVERED Step 2: CumpleaÃ±os
    if (step === 2) {
      const fechaMatch = body.match(/(\d{1,2})\s*(de\s*)?(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|\d{1,2})/i);
      let birthday = null;
      if (fechaMatch) {
        const dia = fechaMatch[1].padStart(2, '0');
        const mesTexto = fechaMatch[3].toLowerCase();
        const meses: Record<string, string> = { enero:'01', febrero:'02', marzo:'03', abril:'04', mayo:'05', junio:'06', julio:'07', agosto:'08', septiembre:'09', octubre:'10', noviembre:'11', diciembre:'12' };
        const mes = meses[mesTexto] || mesTexto.padStart(2, '0');
        birthday = '2000-' + mes + '-' + dia;
      }
      await this.supabase.client.from('leads').update({ birthday, survey_step: 3 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 2 de 5*\nÂ¿CuÃ¡l es tu email?');
      return;
    }
    
    // DELIVERED Step 3: Email
    if (step === 3) {
      const emailMatch = body.match(/([^\s]+@[^\s]+\.[^\s]+)/i);
      const email = emailMatch ? emailMatch[1].toLowerCase() : null;
      await this.supabase.client.from('leads').update({ email, survey_step: 4 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 3 de 5*\nDel 1 al 10, Â¿cÃ³mo calificarÃ­as tu experiencia con nosotros?');
      return;
    }
    
    // DELIVERED Step 4: Rating
    if (step === 4) {
      const rating = parseInt(body.match(/\d+/)?.[0] || '0');
      await this.supabase.client.from('leads').update({ survey_rating: rating || null, survey_step: 5 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 4 de 5*\nÂ¿QuÃ© fue lo que mÃ¡s te gustÃ³ del proceso?');
      return;
    }
    
    // DELIVERED Step 5: Feedback
    if (step === 5) {
      await this.supabase.client.from('leads').update({ survey_feedback: body, survey_step: 6 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 
        '*Pregunta 5 de 5*\nğŸ *Programa Embajador*\n\n' +
        'Si recomiendas a alguien y compra, recibirÃ¡s regalos, promociones y beneficios exclusivos.\n\n' +
        'Â¿Conoces a alguien buscando casa?\n' +
        'Comparte: *Nombre y TelÃ©fono*\n\n' +
        'Si no conoces a nadie, responde *No*');
      return;
    }
    
    // DELIVERED Step 6: Referido
    if (step === 6) {
      if (!mensaje.includes('no')) {
        const refMatch = body.match(/([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+)\s+(\d{10})/);
        if (refMatch) {
          const nombreRef = refMatch[1].trim();
          const telRef = refMatch[2];
          await this.supabase.client.from('leads').insert({
            name: nombreRef,
            phone: '52' + telRef.slice(-10),
            source: 'referido',
            referrer_id: lead.id,
            assigned_to: lead.assigned_to,
            status: 'new',
            score: 80,
            notes: { referido_por: lead.name, fecha_referido: new Date().toISOString() }
          });
          await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(telRef),
            'ğŸ‘‹ Â¡Hola *' + nombreRef.split(' ')[0] + '*!\n\n' +
            'Tu amigo *' + (lead.name?.split(' ')[0] || '') + '* te recomendÃ³ con nosotros para ayudarte a encontrar tu casa ideal. ğŸ \n\n' +
            'Tenemos opciones increÃ­bles para ti.\n\n' +
            'Pronto te contactarÃ¡ uno de nuestros asesores. Â¿Mientras tanto, te gustarÃ­a ver informaciÃ³n de nuestras propiedades?\n\n' +
            'Responde *SÃ* para conocer mÃ¡s.');
        }
      }
      await this.supabase.client.from('leads').update({ survey_completed: true, survey_step: 0 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 
        'ğŸ™ *Â¡Muchas gracias ' + (lead.name?.split(' ')[0] || '') + '!*\n\n' +
        'Tu opiniÃ³n es muy valiosa para nosotros.\n\n' +
        'ğŸ *Programa Embajador*\n' +
        'Cuando conozcas a alguien buscando casa, mandanos:\n' +
        '*Referido Nombre Telefono*\n\n' +
        'Ejemplo: _Referido Juan 5512345678_\n\n' +
        'Y participas por premios automaticamente.\n\n' +
        'Disfruta tu nuevo hogar. ğŸ â¤ï¸');
      return;
    }
    
    // FALLEN Step 11: QuÃ© no convenciÃ³
    if (step === 11) {
      await this.supabase.client.from('leads').update({ 
        survey_feedback: body, 
        survey_step: 12,
        notes: { ...(lead.notes || {}), no_convencio: body }
      }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 2 de 5*\nÂ¿Hay algo que podrÃ­amos haber hecho diferente?');
      return;
    }
    
    // FALLEN Step 12: QuÃ© mejorar
    if (step === 12) {
      await this.supabase.client.from('leads').update({ 
        survey_step: 13,
        notes: { ...(lead.notes || {}), que_mejorar: body }
      }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 3 de 5*\nDel 1 al 10, Â¿cÃ³mo calificarÃ­as la atenciÃ³n recibida?');
      return;
    }
    
    // FALLEN Step 13: Rating
    if (step === 13) {
      const rating = parseInt(body.match(/\d+/)?.[0] || '0');
      await this.supabase.client.from('leads').update({ survey_rating: rating || null, survey_step: 14 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, '*Pregunta 4 de 5*\nÂ¿CuÃ¡ndo es tu cumpleaÃ±os?\nPor si en el futuro hay algo especial para ti ğŸ\n(ej: 15 marzo)');
      return;
    }
    
    // FALLEN Step 14: CumpleaÃ±os
    if (step === 14) {
      const fechaMatch = body.match(/(\d{1,2})\s*(de\s*)?(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|\d{1,2})/i);
      let birthday = null;
      if (fechaMatch) {
        const dia = fechaMatch[1].padStart(2, '0');
        const mesTexto = fechaMatch[3].toLowerCase();
        const meses: Record<string, string> = { enero:'01', febrero:'02', marzo:'03', abril:'04', mayo:'05', junio:'06', julio:'07', agosto:'08', septiembre:'09', octubre:'10', noviembre:'11', diciembre:'12' };
        const mes = meses[mesTexto] || mesTexto.padStart(2, '0');
        birthday = '2000-' + mes + '-' + dia;
      }
      await this.supabase.client.from('leads').update({ birthday, survey_step: 15 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 
        '*Pregunta 5 de 5*\nğŸ *Programa Embajador*\n\n' +
        'Aunque no compraste, puedes ganar. Si recomiendas a alguien y compra, recibirÃ¡s regalos, promociones y beneficios exclusivos.\n\n' +
        'Â¿Conoces a alguien buscando casa?\n' +
        'Comparte: *Nombre y TelÃ©fono*\n\n' +
        'Si no conoces a nadie, responde *No*');
      return;
    }
    
    // FALLEN Step 15: Referido
    if (step === 15) {
      if (!mensaje.includes('no')) {
        const refMatch = body.match(/([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘\s]+)\s+(\d{10})/);
        if (refMatch) {
          const nombreRef = refMatch[1].trim();
          const telRef = refMatch[2];
          await this.supabase.client.from('leads').insert({
            name: nombreRef,
            phone: '52' + telRef.slice(-10),
            source: 'referido',
            referrer_id: lead.id,
            assigned_to: lead.assigned_to,
            status: 'new',
            score: 80,
            notes: { referido_por: lead.name, fecha_referido: new Date().toISOString() }
          });
          await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(telRef),
            'ğŸ‘‹ Â¡Hola *' + nombreRef.split(' ')[0] + '*!\n\n' +
            'Tu amigo *' + (lead.name?.split(' ')[0] || '') + '* te recomendÃ³ con nosotros para ayudarte a encontrar tu casa ideal. ğŸ \n\n' +
            'Tenemos opciones increÃ­bles para ti.\n\n' +
            'Pronto te contactarÃ¡ uno de nuestros asesores.');
        }
      }
      await this.supabase.client.from('leads').update({ survey_completed: true, survey_step: 0 }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 
        'ğŸ™ *Â¡Gracias ' + (lead.name?.split(' ')[0] || '') + '!*\n\n' +
        'Apreciamos mucho tu tiempo y retroalimentaciÃ³n.\n\n' +
        'Si en el futuro buscas una casa, aquÃ­ estaremos para ti. ğŸ ');
      return;
    }
  }

  private async handleVendedorMessage(from: string, body: string, vendedor: any, teamMembers: any[]): Promise<void> {
    const mensaje = body.toLowerCase().trim();
    const nombreVendedor = vendedor.name?.split(' ')[0] || 'crack';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECTAR INTENCIÃ“N DEL VENDEDOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // RESPUESTA A MOTIVO DE CAÃDA (1, 2, 3, 4)
    if (['1', '2', '3', '4'].includes(mensaje.trim())) {
      await this.vendedorMotivoRespuesta(from, mensaje.trim(), vendedor);
      return;
    }

    // MOTIVO PERSONALIZADO (despuÃ©s de elegir 4)
    const { data: leadPendiente } = await this.supabase.client
      .from('leads')
      .select('id, notes')
      .eq('assigned_to', vendedor.id)
      .eq('status', 'fallen')
      .order('updated_at', { ascending: false })
      .limit(1)
      .single();
    
    if (leadPendiente?.notes?.pending_custom_reason) {
      await this.vendedorMotivoCustom(from, body, vendedor);
      return;
    }

    // FUNNEL: ReservÃ³/ApartÃ³
    if (mensaje.includes('reserv') || mensaje.includes('reserb') || mensaje.includes('apart')) {
      await this.vendedorCambiarEtapa(from, body, vendedor, 'reserved', 'ğŸ“ RESERVADO');
      return;
    }

    // FUNNEL: CerrÃ³/EscriturÃ³
    if ((mensaje.includes('cerr') && !mensaje.includes('encerr')) || mensaje.includes('escritur')) {
      await this.vendedorCambiarEtapa(from, body, vendedor, 'closed', 'âœï¸ CERRADO');
      return;
    }

    // FUNNEL: Entregado
    if ((mensaje.includes('entreg') || mensaje.includes('entrg') || mensaje.includes('enterg')) && !mensaje.includes('entrega a')) {
      await this.vendedorCambiarEtapa(from, body, vendedor, 'delivered', 'ğŸ”‘ ENTREGADO');
      return;
    }

    // FUNNEL: Se cayÃ³
    if (mensaje.includes('se cay') || mensaje.includes('cayo') || mensaje.includes('cayÃ³') || mensaje.includes('cancelÃ³')) {
      await this.vendedorCambiarEtapa(from, body, vendedor, 'fallen', 'âŒ CAÃDO');
      return;
    }

    // HIPOTECA: Manda a banco
    if ((mensaje.includes('manda') || mensaje.includes('envia') || mensaje.includes('envÃ­a')) && 
        (mensaje.includes('bbva') || mensaje.includes('santander') || mensaje.includes('banorte') || 
         mensaje.includes('hsbc') || mensaje.includes('infonavit') || mensaje.includes('fovissste') ||
         mensaje.includes('banamex') || mensaje.includes('scotiabank') || mensaje.includes('banregio'))) {
      await this.vendedorEnviarABanco(from, body, vendedor);
      return;
    }

    // HIPOTECA: Â¿CÃ³mo va el crÃ©dito?
    if ((mensaje.includes('cÃ³mo va') || mensaje.includes('como va') || mensaje.includes('estatus') || mensaje.includes('status')) && 
        (mensaje.includes('crÃ©dit') || mensaje.includes('credit') || mensaje.includes('hipoteca') || mensaje.includes('banco'))) {
      await this.vendedorConsultarCredito(from, body, vendedor);
      return;
    }

    // POST-VENTA: Cumple Juan 15/03
    const cumpleMatch = body.match(/^cumple\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘0-9\s]+)\s+(\d{1,2})[\/\-](\d{1,2})$/i);
    if (cumpleMatch) {
      const nombreCliente = cumpleMatch[1].trim();
      const dia = cumpleMatch[2].padStart(2, '0');
      const mes = cumpleMatch[3].padStart(2, '0');
      
      const { data: lead } = await this.supabase.client
        .from('leads')
        .select('*')
        .eq('assigned_to', vendedor.id)
        .eq('status', 'delivered')
        .ilike('name', '%' + nombreCliente + '%')
        .single();
      
      if (!lead) {
        await this.twilio.sendWhatsAppMessage(from, 'âŒ No encontrÃ© cliente entregado "' + nombreCliente + '"');
        return;
      }
      
      await this.supabase.client.from('leads').update({ birthday: '2000-' + mes + '-' + dia }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 'ğŸ‚ CumpleaÃ±os de *' + lead.name + '* guardado: *' + dia + '/' + mes + '*');
      return;
    }

    // POST-VENTA: Email Juan correo@ejemplo.com
    const emailMatch = body.match(/^email\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘0-9\s]+)\s+([^\s]+@[^\s]+)$/i);
    if (emailMatch) {
      const nombreCliente = emailMatch[1].trim();
      const correo = emailMatch[2].toLowerCase();
      
      const { data: lead } = await this.supabase.client
        .from('leads')
        .select('*')
        .eq('assigned_to', vendedor.id)
        .eq('status', 'delivered')
        .ilike('name', '%' + nombreCliente + '%')
        .single();
      
      if (!lead) {
        await this.twilio.sendWhatsAppMessage(from, 'âŒ No encontrÃ© cliente entregado "' + nombreCliente + '"');
        return;
      }
      
      await this.supabase.client.from('leads').update({ email: correo }).eq('id', lead.id);
      await this.twilio.sendWhatsAppMessage(from, 'ğŸ“§ Email de *' + lead.name + '* guardado: *' + correo + '*');
      return;
    }

    // REFERIDOS: Vendedor registra referido "Referido Juan 5512345678 por Pedro"
    const refVendMatch = body.match(/^referido\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘0-9\s]+)\s+(\d{10})\s+por\s+([a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘0-9\s]+)$/i);
    if (refVendMatch) {
      const nombreReferido = refVendMatch[1].trim();
      const telReferido = refVendMatch[2];
      const nombreReferidor = refVendMatch[3].trim();
      
      // Buscar cliente referidor
      const { data: referidor } = await this.supabase.client
        .from('leads')
        .select('*')
        .eq('status', 'delivered')
        .ilike('name', '%' + nombreReferidor + '%')
        .single();
      
      // Crear lead referido
      const { data: nuevoLead } = await this.supabase.client
        .from('leads')
        .insert({
          name: nombreReferido,
          phone: '52' + telReferido.slice(-10),
          source: 'referido',
          referrer_id: referidor?.id || null,
          assigned_to: vendedor.id,
          status: 'new',
          score: 80,
          notes: { referido_por: nombreReferidor, fecha_referido: new Date().toISOString() }
        })
        .select()
        .single();
      
      // Mensaje al referido
      await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(telReferido),
        'ğŸ‘‹ Â¡Hola *' + nombreReferido.split(' ')[0] + '*!\n\n' +
        'Tu amigo *' + nombreReferidor.split(' ')[0] + '* te recomendÃ³ con nosotros para ayudarte a encontrar tu casa ideal. ğŸ \n\n' +
        'Tenemos opciones increÃ­bles para ti.\n\n' +
        'Pronto te contactarÃ¡ uno de nuestros asesores. Â¿Mientras tanto, te gustarÃ­a ver informaciÃ³n de nuestras propiedades?\n\n' +
        'Responde *SÃ* para conocer mÃ¡s.');
      
      await this.twilio.sendWhatsAppMessage(from,
        'âœ… *Referido registrado*\n\n' +
        '*' + nombreReferido + '* - ' + telReferido + '\n' +
        'ğŸ‘¤ Por: ' + nombreReferidor + '\n\n' +
        'Ya le enviamos mensaje de bienvenida.');
      return;
    }

    // 0. RESPUESTA A CONFIRMACIÃ“N: "1", "sÃ­", "si manda"
    if ((mensaje === '1' || mensaje === 'si' || mensaje === 'sÃ­' || mensaje.includes('si manda') || mensaje.includes('sÃ­ manda')) && await this.hayConfirmacionPendiente(vendedor.id)) {
      await this.enviarConfirmacionAlLead(from, vendedor, nombreVendedor);
      return;
    }

    // 0.1 RESPUESTA NEGATIVA: "2", "no"
    if ((mensaje === '2' || mensaje === 'no' || mensaje.includes('yo le aviso')) && await this.hayConfirmacionPendiente(vendedor.id)) {
      await this.cancelarConfirmacionPendiente(from, vendedor, nombreVendedor);
      return;
    }

    // 0.2 AYUDA CONTEXTUAL: "Â¿CÃ³mo agendo cita?" "Â¿CÃ³mo cancelo?"
    if (mensaje.includes('cÃ³mo ') || mensaje.includes('como ') || mensaje.includes('como hago') || mensaje.includes('cÃ³mo hago') || mensaje.includes('como agendo') || mensaje.includes('como cancelo') || mensaje.includes('como creo')) {
      await this.vendedorAyudaContextual(from, body, nombreVendedor);
      return;
    }

    // 1. AGENDAR CITA: "Cita maÃ±ana 5pm con Juan 5512345678 en Distrito Falco"
    const esAgendarCita = mensaje.includes('cita') && (
      mensaje.includes('maÃ±ana') || mensaje.includes('pasado') ||
      mensaje.includes('lunes') || mensaje.includes('martes') ||
      mensaje.includes('miÃ©rcoles') || mensaje.includes('miercoles') ||
      mensaje.includes('jueves') || mensaje.includes('viernes') ||
      mensaje.includes('sÃ¡bado') || mensaje.includes('sabado') ||
      mensaje.includes('domingo') || mensaje.includes(' en ') ||
      /\d{1,2}\s*(am|pm)/i.test(mensaje) || mensaje.includes(' con ')
    );
    if (esAgendarCita) {
      await this.vendedorAgendarCitaCompleta(from, body, vendedor, nombreVendedor);
      return;
    }

    // 1.1 Â¿QuÃ© citas tengo hoy?
    if (mensaje.includes('cita') && (mensaje.includes('tengo') || mensaje.includes('mis citas') || mensaje.includes('agenda'))) {
      await this.vendedorCitasHoy(from, vendedor, nombreVendedor);
      return;
    }

    // 2. Â¿CÃ³mo va mi meta? / Â¿CuÃ¡nto llevo?
    if (mensaje.includes('meta') || mensaje.includes('llevo') || mensaje.includes('avance') || mensaje.includes('ventas')) {
      await this.vendedorMetaAvance(from, vendedor, nombreVendedor);
      return;
    }

    // 3. Â¿CuÃ¡ntos leads tengo?
    if (mensaje.includes('lead') || mensaje.includes('prospectos') || mensaje.includes('clientes nuevos')) {
      await this.vendedorResumenLeads(from, vendedor, nombreVendedor);
      return;
    }

    // 4. Â¿QuÃ© pendientes tengo?
    if (mensaje.includes('pendiente') || mensaje.includes('follow') || mensaje.includes('seguimiento')) {
      await this.vendedorPendientes(from, vendedor, nombreVendedor);
      return;
    }

    // 5. Briefing / Buenos dÃ­as
    if (mensaje.includes('briefing') || mensaje.includes('buenos dÃ­as') || mensaje.includes('buen dia') || mensaje === 'hola') {
      await this.vendedorBriefing(from, vendedor, nombreVendedor);
      return;
    }

    // 6. Ayuda / Â¿QuÃ© puedes hacer?
    if (mensaje.includes('ayuda') || mensaje.includes('help') || mensaje.includes('quÃ© puedes') || mensaje.includes('comandos')) {
      await this.vendedorAyuda(from, nombreVendedor);
      return;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMANDOS DE ACTUALIZACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // 7. CerrÃ© venta con [nombre]
    if (mensaje.includes('cerrÃ©') || mensaje.includes('cerre') || mensaje.includes('vendÃ­') || mensaje.includes('vendi')) {
      await this.vendedorCerrarVenta(from, body, vendedor, nombreVendedor);
      return;
    }

    // 8. [Nombre] pasÃ³ a [etapa]
    if (mensaje.includes('pasÃ³ a') || mensaje.includes('paso a') || mensaje.includes('cambiar a') || mensaje.includes('mover a')) {
      await this.vendedorCambiarEtapa(from, body, vendedor, nombreVendedor);
      return;
    }

    // 9. [Nombre] cancelÃ³
    if (mensaje.includes('cancelÃ³') || mensaje.includes('cancelo') || mensaje.includes('ya no') || mensaje.includes('perdÃ­') || mensaje.includes('perdi')) {
      await this.vendedorCancelarLead(from, body, vendedor, nombreVendedor);
      return;
    }

    // 10. Agendar cita con [nombre] [fecha] [hora]
    if (mensaje.includes('agendar') || mensaje.includes('agenda') || mensaje.includes('programar')) {
      await this.vendedorAgendarCita(from, body, vendedor, nombreVendedor);
      return;
    }

    // 12. CREAR LEAD: "Crear Ana GarcÃ­a 5512345678"
    if (mensaje.startsWith('crear ') && mensaje.match(/\d{10}/)) {
      await this.vendedorCrearLead(from, body, vendedor, nombreVendedor);
      return;
    }

    // 13. CANCELAR CITA: "Cancelar cita con Ana"
    if (mensaje.includes('cancelar cita') || mensaje.includes('cancela cita')) {
      await this.vendedorCancelarCita(from, body, vendedor, nombreVendedor);
      return;
    }

    // 14. REAGENDAR CITA: "Reagendar Ana para lunes 3pm"
    if (mensaje.includes('reagendar') || mensaje.includes('mover cita') || mensaje.includes('cambiar cita')) {
      await this.vendedorReagendarCita(from, body, vendedor, nombreVendedor);
      return;
    }

    // 15. AGENDAR CITA COMPLETA: "Cita con Ana maÃ±ana 10am en Distrito Falco"
    if ((mensaje.includes('cita con') || mensaje.includes('agendar')) && (mensaje.includes('am') || mensaje.includes('pm') || mensaje.includes(':') || mensaje.includes('maÃ±ana') || mensaje.includes('lunes') || mensaje.includes('martes') || mensaje.includes('miercoles') || mensaje.includes('jueves') || mensaje.includes('viernes') || mensaje.includes('sabado'))) {
      await this.vendedorAgendarCitaCompleta(from, body, vendedor, nombreVendedor);
      return;
    }

    // 16. Agregar nota: "Nota Juan: le interesa jardÃ­n"
    if (mensaje.includes('nota ') || mensaje.includes('apunte ') || mensaje.includes('anotar ')) {
      await this.vendedorAgregarNota(from, body, vendedor, nombreVendedor);
      return;
    }

    // 12. Ver notas: "Notas de Juan" o "Info de MarÃ­a"
    if ((mensaje.includes('notas de') || mensaje.includes('info de') || mensaje.includes('quÃ© sÃ© de'))) {
      await this.vendedorVerNotas(from, body, vendedor, nombreVendedor);
      return;
    }

    // Default: Si no matcheÃ³ nada, usar IA para clasificar
    await this.vendedorIntentIA(from, body, vendedor, nombreVendedor);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FUNCIONES DEL ASISTENTE VENDEDOR
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorCitasHoy(from: string, vendedor: any, nombre: string): Promise<void> {
    const hoy = new Date();
    const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()).toISOString();
    const finHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() + 1).toISOString();

    const { data: citas } = await this.supabase.client
      .from('appointments')
      .select('*, leads(name, phone)')
      .eq('team_member_id', vendedor.id)
      .gte('date', inicioHoy)
      .lt('date', finHoy)
      .order('date', { ascending: true });

    if (!citas || citas.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, 
        `â˜€ï¸ *Buenos dÃ­as ${nombre}!*

Hoy no tienes citas agendadas. Â¡Buen momento para hacer follow-up a tus leads! ğŸ’ª`
      );
      return;
    }

    let respuesta = `â˜€ï¸ *Buenos dÃ­as ${nombre}!*

ğŸ“… *Tus citas de hoy:*
`;
    
    citas.forEach((cita: any, i: number) => {
      const hora = new Date(cita.date).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
      const clienteNombre = cita.leads?.name || 'Cliente';
      const desarrollo = cita.property_development || '';
      respuesta += `
${i + 1}. *${hora}* - ${clienteNombre}`;
      if (desarrollo) respuesta += `
   ğŸ“ ${desarrollo}`;
    });

    respuesta += `

Â¡Ã‰xito hoy! ğŸ”¥`;
    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

  private async vendedorMetaAvance(from: string, vendedor: any, nombre: string): Promise<void> {
    // Obtener cierres del mes actual
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString();

    const { data: cierres, count } = await this.supabase.client
      .from('leads')
      .select('*', { count: 'exact' })
      .eq('assigned_to', vendedor.id)
      .eq('status', 'sold')
      .gte('updated_at', inicioMes);

    const { count: citasAgendadas } = await this.supabase.client
      .from('appointments')
      .select('*', { count: 'exact', head: true })
      .eq('team_member_id', vendedor.id)
      .gte('date', inicioMes);

    const metaMensual = vendedor.monthly_goal || 3; // Default 3 cierres
    const cierresMes = count || 0;
    const porcentaje = Math.round((cierresMes / metaMensual) * 100);

    let emoji = 'ğŸ”´';
    let mensaje = 'Necesitas acelerar';
    if (porcentaje >= 100) { emoji = 'ğŸŸ¢'; mensaje = 'Â¡Vas arriba! ğŸ‰'; }
    else if (porcentaje >= 70) { emoji = 'ğŸŸ¡'; mensaje = 'Vas bien, sigue asÃ­'; }
    else if (porcentaje >= 50) { emoji = 'ğŸŸ '; mensaje = 'A medio camino'; }

    const respuesta = `ğŸ“Š *Tu avance ${nombre}:*

${emoji} *${porcentaje}%* de tu meta mensual

âœ… Cierres: *${cierresMes}* de ${metaMensual}
ğŸ“… Citas este mes: *${citasAgendadas || 0}*

${mensaje}`;

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

  private async vendedorResumenLeads(from: string, vendedor: any, nombre: string): Promise<void> {
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .in('status', ['new', 'contacted', 'scheduled']);

    const hot = leads?.filter((l: any) => l.lead_category?.toUpperCase() === 'HOT').length || 0;
    const warm = leads?.filter((l: any) => l.lead_category?.toUpperCase() === 'WARM').length || 0;
    const cold = leads?.filter((l: any) => l.lead_category?.toUpperCase() === 'COLD').length || 0;
    const total = leads?.length || 0;

    const respuesta = `ğŸ“‹ *Tus leads activos ${nombre}:*

ğŸ”¥ HOT: *${hot}* ${hot > 0 ? 'â† Â¡Atender YA!' : ''}
ğŸŸ¡ WARM: *${warm}*
â„ï¸ COLD: *${cold}*
â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Total: *${total}* leads

${hot > 0 ? 'ğŸ’¡ _Tip: Los HOT tienen alta probabilidad de cierre. Â¡LlÃ¡malos hoy!_' : ''}`;

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

  private async vendedorPendientes(from: string, vendedor: any, nombre: string): Promise<void> {
    // Leads sin contactar en mÃ¡s de 3 dÃ­as
    const hace3Dias = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString();

    const { data: pendientes } = await this.supabase.client
      .from('leads')
      .select('name, phone, temperature, updated_at')
      .eq('assigned_to', vendedor.id)
      .in('status', ['new', 'contacted'])
      .lt('updated_at', hace3Dias)
      .order('temperature', { ascending: false })
      .limit(5);

    if (!pendientes || pendientes.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, 
        `âœ… *${nombre}, no tienes pendientes urgentes!*

Todos tus leads han sido contactados recientemente. Â¡Sigue asÃ­! ğŸ’ª`
      );
      return;
    }

    let respuesta = `â° *Pendientes de follow-up ${nombre}:*
`;

    pendientes.forEach((lead: any, i: number) => {
      const temp = lead.temperature === 'HOT' ? 'ğŸ”¥' : lead.temperature === 'WARM' ? 'ğŸŸ¡' : 'â„ï¸';
      const dias = Math.floor((Date.now() - new Date(lead.updated_at).getTime()) / (1000 * 60 * 60 * 24));
      respuesta += `
${i + 1}. ${temp} *${lead.name || 'Sin nombre'}*`;
      respuesta += `
   ğŸ“± ${lead.phone} â€¢ ${dias} dÃ­as sin contacto`;
    });

    respuesta += `

ğŸ’¡ _Llama primero a los ğŸ”¥_`;
    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }


  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODO ASISTENTE ASESOR HIPOTECARIO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async handleAsesorMessage(from: string, body: string, asesor: any, teamMembers: any[]): Promise<void> {
    const mensaje = body.toLowerCase().trim();
    const nombreAsesor = asesor.name?.split(' ')[0] || 'crack';

    // 1. Briefing
    if (mensaje.includes('briefing') || mensaje.includes('buenos dÃ­as') || mensaje.includes('buen dia') || mensaje === 'hola') {
      await this.asesorBriefing(from, asesor, nombreAsesor);
      return;
    }

    // 2. Respuestas de estatus: "Aprobado Juan", "Rechazado Juan", etc.
    const respuestaMatch = body.match(/^(aprobado|rechazado|documentos|en proceso)\s+(.+)$/i);
    if (respuestaMatch) {
      const accion = respuestaMatch[1].toLowerCase();
      const nombreCliente = respuestaMatch[2].trim();
      
      const { data: solicitud } = await this.supabase.client
        .from('mortgage_applications')
        .select('*, leads!mortgage_applications_lead_id_fkey(assigned_to, team_members!leads_assigned_to_fkey(phone, name))')
        .eq('assigned_advisor_id', asesor.id)
        .ilike('lead_name', '%' + nombreCliente + '%')
        .in('status', ['pending', 'in_review', 'sent_to_bank'])
        .single();
      
      if (!solicitud) {
        await this.twilio.sendWhatsAppMessage(from, 
          'âŒ No encontrÃ© crÃ©dito activo para "' + nombreCliente + '".');
        return;
      }
      
      let nuevoStatus = solicitud.status;
      let emoji = 'ğŸ“‹';
      
      if (accion === 'aprobado') { nuevoStatus = 'approved'; emoji = 'âœ…'; }
      else if (accion === 'rechazado') { nuevoStatus = 'rejected'; emoji = 'âŒ'; }
      else if (accion === 'documentos') { nuevoStatus = 'pending'; emoji = 'ğŸ“„'; }
      else if (accion === 'en proceso') { nuevoStatus = 'in_review'; emoji = 'â³'; }
      
      await this.supabase.client
        .from('mortgage_applications')
        .update({ 
          status: nuevoStatus, 
          updated_at: new Date().toISOString(),
          advisor_reminder_sent: false,
          escalated_to_vendor: false
        })
        .eq('id', solicitud.id);
      
      // Notificar al vendedor
      const vendedor = solicitud.leads?.team_members;
      if (vendedor?.phone) {
        const vPhone = vendedor.phone.replace(/[^0-9]/g, '');
        const vFormatted = vPhone.startsWith('52') ? vPhone : '52' + vPhone.slice(-10);
        await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(vFormatted),
          emoji + ' *ActualizaciÃ³n de crÃ©dito*\n\n' +
          '*' + solicitud.lead_name + '*\n' +
          'ğŸ¦ ' + (solicitud.bank || 'Sin banco') + '\n' +
          'ğŸ“Š Estatus: *' + nuevoStatus + '*\n' +
          'ğŸ‘” Asesor: ' + asesor.name);
      }
      
      await this.twilio.sendWhatsAppMessage(from,
        emoji + ' Actualizado *' + solicitud.lead_name + '* a *' + nuevoStatus + '*. Se notificÃ³ al vendedor.');
      return;
    }

    // 3. Mis leads
    if (mensaje.includes('lead') || mensaje.includes('cliente') || mensaje.includes('prospectos')) {
      await this.asesorMisLeads(from, asesor, nombreAsesor);
      return;
    }

    // 3. Pendientes
    if (mensaje.includes('pendiente') || mensaje.includes('seguimiento')) {
      await this.asesorPendientes(from, asesor, nombreAsesor);
      return;
    }

    // 4. Citas
    if (mensaje.includes('cita') && (mensaje.includes('hoy') || mensaje.includes('tengo'))) {
      await this.asesorCitasHoy(from, asesor, nombreAsesor);
      return;
    }

    // 5. FUNNEL: "Juan pasÃ³ a revisiÃ³n/banco/aprobado"
    if (mensaje.includes('pasÃ³ a') || mensaje.includes('paso a') || mensaje.includes('enviar a') || mensaje.includes('enviado a')) {
      await this.asesorMoverFunnel(from, body, asesor, nombreAsesor);
      return;
    }

    // 6. Aprobado: "Aprobado Juan" o "Juan aprobado"
    if (mensaje.includes('aprobado') || mensaje.includes('aprobÃ³')) {
      await this.asesorAprobar(from, body, asesor, nombreAsesor);
      return;
    }

    // 7. Rechazado ON: "Rechazado on Juan" (puede reintentar)
    if (mensaje.includes('rechazado on') || mensaje.includes('rechazar on')) {
      await this.asesorRechazarOn(from, body, asesor, nombreAsesor);
      return;
    }

    // 8. Rechazado OFF: "Rechazado off Juan" (definitivo)
    if (mensaje.includes('rechazado off') || mensaje.includes('rechazar off') || mensaje.includes('rechazado definitivo')) {
      await this.asesorRechazarOff(from, body, asesor, nombreAsesor);
      return;
    }

    // 9. Agendar cita: "Cita maÃ±ana 10am con Juan en oficina"
    if ((mensaje.includes('cita') && (mensaje.includes('maÃ±ana') || mensaje.includes('lunes') || mensaje.includes('martes') || mensaje.includes('miÃ©rcoles') || mensaje.includes('jueves') || mensaje.includes('viernes'))) || mensaje.includes('agendar')) {
      await this.asesorAgendarCita(from, body, asesor, nombreAsesor);
      return;
    }

    // 7. Nota
    if (mensaje.includes('nota ') || mensaje.includes('apunte ')) {
      await this.asesorAgregarNota(from, body, asesor, nombreAsesor);
      return;
    }

    // 8. Ayuda
    await this.asesorAyuda(from, nombreAsesor);
  }

  private async asesorBriefing(from: string, asesor: any, nombre: string): Promise<void> {
    const hoy = new Date().toISOString().split('T')[0];

    const { data: citas } = await this.supabase.client
      .from('appointments')
      .select('*')
      .eq('asesor_id', asesor.id)
      .eq('status', 'scheduled')
      .eq('scheduled_date', hoy);

    const { data: pendientes } = await this.supabase.client
      .from('leads')
      .select('name, phone')
      .eq('needs_credit', true)
      .is('mortgage_status', null)
      .limit(5);

    let resp = `â˜€ï¸ *Buenos dÃ­as ${nombre}!*\n\n`;
    resp += citas?.length ? `ğŸ“… *Citas hoy:* ${citas.length}\n` : `ğŸ“… Sin citas hoy\n`;
    resp += pendientes?.length ? `â³ *Pendientes:* ${pendientes.length}\n` : ``;
    resp += `\nğŸ’¡ Escribe *"ayuda"* para comandos`;

    await this.twilio.sendWhatsAppMessage(from, resp);
  }

  private async asesorMisLeads(from: string, asesor: any, nombre: string): Promise<void> {
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('name, phone, mortgage_status')
      .eq('needs_credit', true)
      .limit(10);

    const pendientes = leads?.filter((l: any) => !l.mortgage_status).length || 0;
    const aprobados = leads?.filter((l: any) => l.mortgage_status === 'precalificado').length || 0;

    let resp = `ğŸ“‹ *Leads ${nombre}:*\n\nâ³ Pendientes: *${pendientes}*\nâœ… Aprobados: *${aprobados}*`;
    await this.twilio.sendWhatsAppMessage(from, resp);
  }

  private async asesorPendientes(from: string, asesor: any, nombre: string): Promise<void> {
    const hace7Dias = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

    const { data: pend } = await this.supabase.client
      .from('leads')
      .select('name, phone')
      .eq('needs_credit', true)
      .is('mortgage_status', null)
      .lt('updated_at', hace7Dias)
      .limit(5);

    if (!pend?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âœ… *${nombre}*, sin pendientes urgentes! ğŸ’ª`);
      return;
    }

    let resp = `â° *Pendientes ${nombre}:*\n`;
    pend.forEach((l: any, i: number) => { resp += `${i+1}. ${l.name}\n`; });
    await this.twilio.sendWhatsAppMessage(from, resp);
  }

  private async asesorCitasHoy(from: string, asesor: any, nombre: string): Promise<void> {
    const hoy = new Date().toISOString().split('T')[0];

    const { data: citas } = await this.supabase.client
      .from('appointments')
      .select('*')
      .eq('asesor_id', asesor.id)
      .eq('scheduled_date', hoy);

    if (!citas?.length) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“… Sin citas hoy ${nombre}`);
      return;
    }

    let resp = `ğŸ“… *Citas hoy:*\n`;
    citas.forEach((c: any) => { resp += `â€¢ ${c.scheduled_time} - ${c.lead_name}\n`; });
    await this.twilio.sendWhatsAppMessage(from, resp);
  }

  private async asesorPrecalificar(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/(?:precalific|aprobado)[oa]?\s+(?:a\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"PrecalificÃ³ Juan"*`);
      return;
    }

    const nombreLead = match[1].trim();
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name')
      .eq('needs_credit', true)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    await this.supabase.client
      .from('leads')
      .update({ mortgage_status: 'precalificado', updated_at: new Date().toISOString() })
      .eq('id', leads[0].id);

    await this.twilio.sendWhatsAppMessage(from, `âœ… *${leads[0].name}* PRECALIFICADO! ğŸ‰`);
  }

  private async asesorRechazar(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/(?:rechaz|no calific)[oa]?\s+(?:a\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Rechazado Juan"*`);
      return;
    }

    const nombreLead = match[1].trim();
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name')
      .eq('needs_credit', true)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    await this.supabase.client
      .from('leads')
      .update({ mortgage_status: 'rechazado', updated_at: new Date().toISOString() })
      .eq('id', leads[0].id);

    await this.twilio.sendWhatsAppMessage(from, `âŒ *${leads[0].name}* marcado como RECHAZADO`);
  }

  private async asesorAgregarNota(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/(?:nota|apunte)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?):\s*(.+)/i);
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Nota Juan: necesita docs"*`);
      return;
    }

    const nombreLead = match[1].trim();
    const texto = match[2].trim();

    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, notes')
      .ilike('name', '%' + nombreLead + '%');

    if (!leads?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    const lead = leads[0];
    const notas = lead.notes || {};
    const hist = notas.historial || [];
    hist.push({ fecha: new Date().toISOString(), texto, autor: nombre + ' (Asesor)' });

    await this.supabase.client
      .from('leads')
      .update({ notes: { ...notas, historial: hist }, updated_at: new Date().toISOString() })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Nota agregada a *${lead.name}*`);
  }

  private async asesorAyuda(from: string, nombre: string): Promise<void> {
    const ayuda = `ğŸ¦ *Comandos Asesor*

ğŸ“Š *CONSULTAS:*
- *briefing* - Resumen del dÃ­a
- *mis leads* - Ver leads
- *pendientes* - Sin seguimiento
- *citas hoy* - Tus citas

ğŸ“ *ACTUALIZAR:*
- *PrecalificÃ³ Juan*
- *Rechazado Juan*
- *Nota Juan: texto*

Â¿En quÃ© te ayudo ${nombre}?`;

    await this.twilio.sendWhatsAppMessage(from, ayuda);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FUNNEL HIPOTECARIO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async asesorMoverFunnel(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    // "Juan pasÃ³ a revisiÃ³n" o "Enviar Juan a BBVA"
    const matchReview = body.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s*(?:pasÃ³ a|paso a)\s*(revisiÃ³n|revision|revisar)/i);
    const matchBank = body.match(/(?:enviar|enviado)\s+(?:a\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s+(?:a|al?)\s+(bbva|santander|banorte|hsbc|banamex|infonavit|fovissste|banregio|scotiabank)/i);
    const matchBankAlt = body.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s*(?:pasÃ³ a|paso a|enviado a)\s*(banco|bbva|santander|banorte|hsbc|banamex|infonavit|fovissste|banregio|scotiabank)/i);

    let nombreLead = '';
    let nuevaEtapa = '';
    let banco = '';

    if (matchReview) {
      nombreLead = matchReview[1].trim();
      nuevaEtapa = 'in_review';
    } else if (matchBank) {
      nombreLead = matchBank[1].trim();
      nuevaEtapa = 'sent_to_bank';
      banco = matchBank[2].toUpperCase();
    } else if (matchBankAlt) {
      nombreLead = matchBankAlt[1].trim();
      nuevaEtapa = 'sent_to_bank';
      banco = matchBankAlt[2].toUpperCase();
    } else {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe:\nâ€¢ *"Juan pasÃ³ a revisiÃ³n"*\nâ€¢ *"Enviar Juan a BBVA"*`);
      return;
    }

    // Buscar solicitud
    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('*')
      .ilike('lead_name', '%' + nombreLead + '%');

    if (!solicitudes?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© solicitud de *${nombreLead}*`);
      return;
    }

    const sol = solicitudes[0];
    const updateData: any = { 
      status: nuevaEtapa, 
      updated_at: new Date().toISOString() 
    };

    if (nuevaEtapa === 'in_review') {
      updateData.in_review_at = new Date().toISOString();
    } else if (nuevaEtapa === 'sent_to_bank') {
      updateData.sent_to_bank_at = new Date().toISOString();
      if (banco) updateData.bank = banco;
    }

    await this.supabase.client
      .from('mortgage_applications')
      .update(updateData)
      .eq('id', sol.id);

    const etapaTexto = nuevaEtapa === 'in_review' ? 'EN REVISIÃ“N ğŸ“‹' : `ENVIADO A ${banco || 'BANCO'} ğŸ¦`;
    await this.twilio.sendWhatsAppMessage(from, `âœ… *${sol.lead_name}* movido a *${etapaTexto}*`);
  }

  private async asesorAprobar(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/(?:aprobado|aprobÃ³)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)|([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s+(?:aprobado|aprobÃ³)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Aprobado Juan"* o *"Juan aprobado"*`);
      return;
    }

    const nombreLead = (match[1] || match[2]).trim();

    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('*')
      .ilike('lead_name', '%' + nombreLead + '%');

    if (!solicitudes?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© solicitud de *${nombreLead}*`);
      return;
    }

    const sol = solicitudes[0];

    await this.supabase.client
      .from('mortgage_applications')
      .update({ 
        status: 'approved', 
        decision_at: new Date().toISOString(),
        updated_at: new Date().toISOString() 
      })
      .eq('id', sol.id);

    // Notificar al vendedor si existe
    if (sol.lead_id) {
      const { data: lead } = await this.supabase.client
        .from('leads')
        .select('assigned_to')
        .eq('id', sol.lead_id)
        .single();

      if (lead?.assigned_to) {
        const { data: vendedor } = await this.supabase.client
          .from('team_members')
          .select('phone, name')
          .eq('id', lead.assigned_to)
          .single();

        if (vendedor?.phone) {
          const vendedorPhone = vendedor.phone.replace(/\D/g, '');
          await this.twilio.sendWhatsAppMessage(
            `whatsapp:+${vendedorPhone}`,
            `ğŸ‰ *Â¡Buenas noticias!*\n\n*${sol.lead_name}* fue APROBADO por ${sol.bank || 'el banco'}!\n\nğŸ’° Monto: $${sol.requested_amount?.toLocaleString() || 'N/A'}\n\nÂ¡Coordina la firma! ğŸ `
          );
        }
      }
    }

    await this.twilio.sendWhatsAppMessage(from, `ğŸ‰ *${sol.lead_name}* APROBADO!\n\nVendedor notificado âœ…`);
  }

  private async asesorRechazarOn(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/rechazado? on\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Rechazado on Juan"*\n(Puede reintentar despuÃ©s)`);
      return;
    }

    const nombreLead = match[1].trim();

    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('*')
      .ilike('lead_name', '%' + nombreLead + '%');

    if (!solicitudes?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© solicitud de *${nombreLead}*`);
      return;
    }

    const sol = solicitudes[0];

    await this.supabase.client
      .from('mortgage_applications')
      .update({ 
        status: 'rejected_on', 
        decision_at: new Date().toISOString(),
        status_notes: 'Rechazado ON - Puede reintentar',
        updated_at: new Date().toISOString() 
      })
      .eq('id', sol.id);

    await this.twilio.sendWhatsAppMessage(from, `âš ï¸ *${sol.lead_name}* marcado *RECHAZADO ON*\n\nPuede reintentar en el futuro.`);
  }

  private async asesorRechazarOff(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    const match = body.match(/rechazado? (?:off|definitivo)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Rechazado off Juan"*\n(Definitivo, sin opciÃ³n)`);
      return;
    }

    const nombreLead = match[1].trim();

    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('*')
      .ilike('lead_name', '%' + nombreLead + '%');

    if (!solicitudes?.length) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© solicitud de *${nombreLead}*`);
      return;
    }

    const sol = solicitudes[0];

    await this.supabase.client
      .from('mortgage_applications')
      .update({ 
        status: 'rejected_off', 
        decision_at: new Date().toISOString(),
        status_notes: 'Rechazado OFF - Definitivo',
        updated_at: new Date().toISOString() 
      })
      .eq('id', sol.id);

    // Notificar al vendedor
    if (sol.lead_id) {
      const { data: lead } = await this.supabase.client
        .from('leads')
        .select('assigned_to')
        .eq('id', sol.lead_id)
        .single();

      if (lead?.assigned_to) {
        const { data: vendedor } = await this.supabase.client
          .from('team_members')
          .select('phone')
          .eq('id', lead.assigned_to)
          .single();

        if (vendedor?.phone) {
          const vendedorPhone = vendedor.phone.replace(/\D/g, '');
          await this.twilio.sendWhatsAppMessage(
            `whatsapp:+${vendedorPhone}`,
            `âŒ *${sol.lead_name}* fue rechazado definitivamente.\n\nBusca otras opciones de pago o propiedad.`
          );
        }
      }
    }

    await this.twilio.sendWhatsAppMessage(from, `âŒ *${sol.lead_name}* RECHAZADO OFF (definitivo)\n\nVendedor notificado.`);
  }

  private async asesorAgendarCita(from: string, body: string, asesor: any, nombre: string): Promise<void> {
    // Extraer telÃ©fono si viene
    const matchTelefono = body.match(/(\d{10})/);
    const telefono = matchTelefono ? matchTelefono[1] : null;

    // Extraer nombre - mÃ¡s flexible
    let nombreLead = '';
    const matchNombreConTel = body.match(/(?:con|para)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s+\d{10}/i);
    const matchNombreSinTel = body.match(/(?:cita|agendar).*?(?:con|para)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s+(?:maÃ±ana|hoy|lunes|martes|miÃ©rcoles|jueves|viernes|\d))/i);
    
    if (matchNombreConTel) {
      nombreLead = matchNombreConTel[1].trim();
    } else if (matchNombreSinTel) {
      nombreLead = matchNombreSinTel[1].trim();
    }

    const matchFecha = body.match(/(maÃ±ana|hoy|lunes|martes|miÃ©rcoles|miercoles|jueves|viernes|sÃ¡bado|sabado|domingo)/i);
    const matchHora = body.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
    const matchLugar = body.match(/(?:en|lugar:?)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s*$|\s+\d)/i);

    if (!nombreLead || !matchHora) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Cita maÃ±ana 10am con Juan 5512345678 en oficina"*`);
      return;
    }

    const lugar = matchLugar ? matchLugar[1].trim() : 'Oficina';

    // Buscar solicitud o lead existente
    let leadPhone = telefono || '';
    let leadName = nombreLead;
    let leadId = null;

    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('lead_id, lead_name, lead_phone')
      .ilike('lead_name', '%' + nombreLead + '%');

    if (solicitudes?.length) {
      leadName = solicitudes[0].lead_name;
      leadPhone = solicitudes[0].lead_phone || leadPhone;
      leadId = solicitudes[0].lead_id;
    } else if (telefono) {
      // No existe, buscar por telÃ©fono o crear lead nuevo
      const { data: leadExistente } = await this.supabase.client
        .from('leads')
        .select('id, name, phone')
        .eq('phone', telefono)
        .single();

      if (leadExistente) {
        leadId = leadExistente.id;
        leadName = leadExistente.name || nombreLead;
        leadPhone = leadExistente.phone;
        console.log('ğŸ“± Lead encontrado por telÃ©fono:', leadName);
      } else {
        // Crear lead nuevo
        const { data: nuevoLead, error: errorLead } = await this.supabase.client
          .from('leads')
          .insert({
            name: nombreLead,
            phone: telefono,
            status: 'new',
            lead_category: 'WARM',
            source: 'asesor_referido',
            needs_credit: true,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .select()
          .single();

        if (nuevoLead) {
          leadId = nuevoLead.id;
          leadPhone = telefono;
          console.log('âœ… Lead creado por asesor:', nombreLead);
        }
      }
    }

    // Calcular fecha
    const fecha = new Date();
    if (matchFecha) {
      const dia = matchFecha[1].toLowerCase();
      if (dia === 'maÃ±ana') {
        fecha.setDate(fecha.getDate() + 1);
      } else if (dia !== 'hoy') {
        const dias = ['domingo', 'lunes', 'martes', 'miÃ©rcoles', 'miercoles', 'jueves', 'viernes', 'sÃ¡bado', 'sabado'];
        const targetDay = dias.indexOf(dia) % 7;
        const currentDay = fecha.getDay();
        let daysToAdd = targetDay - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7;
        fecha.setDate(fecha.getDate() + daysToAdd);
      }
    }

    // Hora
    let hora = parseInt(matchHora[1]);
    const minutos = matchHora[2] ? parseInt(matchHora[2]) : 0;
    const ampm = matchHora[3].toLowerCase();
    if (ampm === 'pm' && hora < 12) hora += 12;
    if (ampm === 'am' && hora === 12) hora = 0;
    fecha.setHours(hora, minutos, 0, 0);

    const horaDB = fecha.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });

    // Crear cita
    const { error } = await this.supabase.client
      .from('appointments')
      .insert({
        lead_name: leadName,
        lead_phone: leadPhone,
        property_name: lugar,
        asesor_id: asesor.id,
        asesor_name: asesor.name,
        scheduled_date: fecha.toISOString().split('T')[0],
        scheduled_time: horaDB,
        status: 'scheduled',
        appointment_type: 'hipoteca',
        duration_minutes: 60
      });

    if (error) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ Error: ${error.message}`);
      return;
    }

    // Google Calendar
    try {
      const endFecha = new Date(fecha.getTime() + 60 * 60 * 1000);
      const formatDate = (d: Date) => {
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:00`;
      };

      await this.calendar.createEvent({
        summary: `ğŸ¦ Hipoteca - ${leadName}`,
        description: `Cliente: ${leadName}\nTelÃ©fono: ${leadPhone}\nLugar: ${lugar}`,
        location: lugar,
        start: { dateTime: formatDate(fecha), timeZone: 'America/Mexico_City' },
        end: { dateTime: formatDate(endFecha), timeZone: 'America/Mexico_City' }
      });
    } catch (e) {
      console.error('Error GCal:', e);
    }

    const fechaStr = fecha.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });
    const horaStr = fecha.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

    await this.twilio.sendWhatsAppMessage(from, `âœ… *Cita agendada:*\n\nğŸ“… ${fechaStr}, ${horaStr}\nğŸ‘¤ ${leadName}\nğŸ“ ${lugar}\n\nğŸ“† Agregada a tu calendario`);
  }



  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MOTIVO DE CAÃDA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorMotivoRespuesta(from: string, opcion: string, vendedor: any): Promise<void> {
    // Buscar lead con pending_fallen_reason
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .eq('status', 'fallen')
      .order('updated_at', { ascending: false })
      .limit(1);

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `No encontrÃ© un lead caÃ­do reciente.`);
      return;
    }

    const lead = leads[0];
    const motivos: any = {
      '1': 'Rechazaron crÃ©dito',
      '2': 'Se arrepintiÃ³',
      '3': 'Problemas de precio'
    };

    // Si elige 4, pedir motivo personalizado
    if (opcion === '4') {
      const notasActuales = lead.notes || {};
      notasActuales.pending_custom_reason = true;
      
      await this.supabase.client
        .from('leads')
        .update({ notes: notasActuales })
        .eq('id', lead.id);

      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Â¿CuÃ¡l fue el motivo? EscrÃ­belo:`);
      return;
    }

    const motivo = motivos[opcion] || 'Otro';

    // Guardar motivo en notes
    const notasActuales = lead.notes || {};
    notasActuales.fallen_reason = motivo;
    notasActuales.fallen_date = new Date().toISOString();
    delete notasActuales.pending_fallen_reason;

    await this.supabase.client
      .from('leads')
      .update({ 
        notes: notasActuales,
        fallen_reason: motivo,
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Guardado: *${lead.name}* se cayÃ³ por *${motivo}*`);
  }

  private async vendedorMotivoCustom(from: string, motivo: string, vendedor: any): Promise<void> {
    // Buscar lead esperando motivo custom
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .eq('status', 'fallen')
      .order('updated_at', { ascending: false })
      .limit(1);

    if (!leads || leads.length === 0 || !leads[0].notes?.pending_custom_reason) {
      return; // No hay lead esperando motivo
    }

    const lead = leads[0];
    const notasActuales = lead.notes || {};
    notasActuales.fallen_reason = motivo;
    notasActuales.fallen_date = new Date().toISOString();
    delete notasActuales.pending_custom_reason;
    delete notasActuales.pending_fallen_reason;

    await this.supabase.client
      .from('leads')
      .update({ 
        notes: notasActuales,
        fallen_reason: motivo,
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Guardado: *${lead.name}* se cayÃ³ por *${motivo}*`);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FUNNEL VENDEDOR - CAMBIO DE ETAPAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorCambiarEtapa(from: string, body: string, vendedor: any, nuevaEtapa: string, etapaTexto: string): Promise<void> {
    // Extraer nombre del lead
    const match = body.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±A-ZÃÃ‰ÃÃ“ÃšÃ‘0-9 ]+)\s+(?:reserv|apart|cerr|escritur|entreg|se cay|cayo|cayÃ³|cancel)/i) ||
                  body.match(/(?:reserv|apart|cerr|escritur|entreg|se cay|cayo|cayÃ³|cancel)[oÃ³a]*\s+(?:a\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe el nombre: *"Juan reservÃ³"* o *"ReservÃ³ Juan"*`);
      return;
    }

    const nombreLead = match[1].trim();

    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, phone, status')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}* en tus leads`);
      return;
    }

    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads:\n`;
      leads.forEach((l: any, i: number) => {
        msg += `${i+1}. ${l.name} (...${l.phone?.slice(-4)}) - ${l.status}\n`;
      });
      msg += `\nEscribe el nombre completo.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];

    // Actualizar etapa
    await this.supabase.client
      .from('leads')
      .update({ 
        status: nuevaEtapa,
        status_changed_at: new Date().toISOString(),
        stalled_alert_sent: false,
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    let respuesta = `âœ… *${lead.name}* movido a ${etapaTexto}`;

    // Si es entregado, es VENTA REAL
    if (nuevaEtapa === 'delivered') {
      await this.supabase.client
        .from('leads')
        .update({ 
          delivery_date: new Date().toISOString().split('T')[0],
          survey_step: 1
        })
        .eq('id', lead.id);
      
      // Enviar encuesta al cliente
      const leadPhone = lead.phone.replace(/[^0-9]/g, '');
      const leadFormatted = leadPhone.startsWith('52') ? leadPhone : '52' + leadPhone.slice(-10);
      await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(leadFormatted),
        'ğŸ âœ¨ *Â¡Felicidades ' + (lead.name?.split(' ')[0] || '') + '!*\n\n' +
        'Bienvenido a nuestra familia. Estamos muy felices de haberte acompaÃ±ado en este paso tan importante.\n\n' +
        'Queremos mantenernos cerca de ti para:\n' +
        'ğŸ‚ Celebrar tus fechas especiales\n' +
        'ğŸ‰ Invitarte a eventos exclusivos\n' +
        'ğŸ’¡ Compartirte tips para tu nuevo hogar\n' +
        'ğŸ Darte beneficios especiales\n\n' +
        'Â¿Me regalas 1 minuto? ğŸ™\n' +
        'Responde *SÃ* para continuar');
      
      respuesta = `ğŸ‰ğŸ”‘ *Â¡VENTA CERRADA!*\n\n*${lead.name}* recibiÃ³ sus llaves!\n\nÂ¡Felicidades! ğŸ†\n\nğŸ“¤ Ya le enviÃ© la encuesta de satisfacciÃ³n.`;
    }

    // Si se cayÃ³, preguntar motivo al vendedor Y enviar encuesta al lead
    if (nuevaEtapa === 'fallen') {
      respuesta = `âŒ *${lead.name}* marcado como CAÃDO\n\nÂ¿Por quÃ© se cayÃ³?\n1. Rechazaron crÃ©dito\n2. Se arrepintiÃ³\n3. Problemas de precio\n4. Otro`;
      
      await this.supabase.client
        .from('leads')
        .update({ 
          notes: { ...(lead.notes || {}), pending_fallen_reason: true },
          survey_step: 10
        })
        .eq('id', lead.id);
      
      // Enviar encuesta al lead caÃ­do
      if (lead.phone) {
        const leadPhone = lead.phone.replace(/[^0-9]/g, '');
        const leadFormatted = leadPhone.startsWith('52') ? leadPhone : '52' + leadPhone.slice(-10);
        await this.twilio.sendWhatsAppMessage(this.formatPhoneMX(leadFormatted),
          'Hola *' + (lead.name?.split(' ')[0] || '') + '*,\n\n' +
          'Lamentamos que no se haya concretado en esta ocasiÃ³n. Tu opiniÃ³n nos ayuda mucho a mejorar.\n\n' +
          'Â¿Me regalas 1 minuto? ğŸ™\n' +
          'Responde *SÃ* para continuar');
        
        respuesta += '\n\nğŸ“¤ Ya le enviÃ© encuesta de retroalimentaciÃ³n al cliente.';
      }
    }

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HIPOTECA - ENVIAR A BANCO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorEnviarABanco(from: string, body: string, vendedor: any): Promise<void> {
    // Extraer nombre y banco
    const bancos = ['bbva', 'santander', 'banorte', 'hsbc', 'infonavit', 'fovissste', 'banamex', 'scotiabank', 'banregio'];
    let bancoEncontrado = '';
    for (const b of bancos) {
      if (body.toLowerCase().includes(b)) {
        bancoEncontrado = b.toUpperCase();
        break;
      }
    }

    const matchNombre = body.match(/(?:manda|envia|envÃ­a)\s+(?:a\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s+(?:a\s+)?(?:bbva|santander|banorte|hsbc|infonavit|fovissste|banamex|scotiabank|banregio)/i);
    
    if (!matchNombre) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ“ Escribe: *"Manda Juan a BBVA"*`);
      return;
    }

    const nombreLead = matchNombre[1].trim();

    // Buscar lead
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    const lead = leads[0];

    // Buscar asesor de ese banco
    const { data: asesores } = await this.supabase.client
      .from('team_members')
      .select('*')
      .eq('role', 'asesor')
      .eq('active', true)
      .ilike('name', '%' + bancoEncontrado + '%');

    let asesorAsignado = asesores?.[0] || null;

    // Si no hay asesor especÃ­fico del banco, buscar cualquier asesor
    if (!asesorAsignado) {
      const { data: cualquierAsesor } = await this.supabase.client
        .from('team_members')
        .select('*')
        .eq('role', 'asesor')
        .eq('active', true)
        .limit(1);
      asesorAsignado = cualquierAsesor?.[0];
    }

    // Crear solicitud hipotecaria
    const { data: solicitud, error } = await this.supabase.client
      .from('mortgage_applications')
      .insert({
        lead_id: lead.id,
        lead_name: lead.name,
        lead_phone: lead.phone,
        bank: bancoEncontrado,
        status: 'pending',
        pending_at: new Date().toISOString(),
        assigned_advisor_id: asesorAsignado?.id,
        assigned_advisor_name: asesorAsignado?.name,
        requested_amount: lead.budget,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .select()
      .single();

    if (error) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ Error: ${error.message}`);
      return;
    }

    // Actualizar lead
    await this.supabase.client
      .from('leads')
      .update({ 
        needs_credit: true,
        credit_status: 'active',
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    // Notificar al asesor si existe
    if (asesorAsignado?.phone) {
      const asesorPhone = asesorAsignado.phone.replace(/\D/g, '');
      await this.twilio.sendWhatsAppMessage(
        `whatsapp:+${asesorPhone.startsWith('52') ? '' : '52'}${asesorPhone.slice(-10)}`,
        `ğŸ†• *Nueva solicitud de crÃ©dito*\n\nğŸ‘¤ ${lead.name}\nğŸ“± ${lead.phone}\nğŸ¦ ${bancoEncontrado}\nğŸ’° ${lead.budget ? '$' + lead.budget.toLocaleString() : 'Por definir'}\n\nVendedor: ${vendedor.name}`
      );
    }

    await this.twilio.sendWhatsAppMessage(from, 
      `âœ… *${lead.name}* enviado a *${bancoEncontrado}*\n\nğŸ¦ Asesor: ${asesorAsignado?.name || 'Por asignar'}\nğŸ“‹ Solicitud creada\n\nTe avisarÃ© cuando haya novedades.`
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HIPOTECA - CONSULTAR ESTADO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorConsultarCredito(from: string, body: string, vendedor: any): Promise<void> {
    // Extraer nombre
    const matchNombre = body.match(/(?:cÃ³mo va|como va|estatus|status).*?(?:de\s+)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\?|$)/i) ||
                        body.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±A-ZÃÃ‰ÃÃ“ÃšÃ‘0-9 ]+).*?(?:cÃ³mo va|como va|crÃ©dit|hipoteca)/i);
    
    let nombreLead = '';
    if (matchNombre) {
      nombreLead = matchNombre[1].replace(/(?:el\s+)?(?:crÃ©dit|credit|hipoteca|banco).*$/i, '').trim();
    }

    // Si no hay nombre, mostrar todos los crÃ©ditos activos
    if (!nombreLead || nombreLead.length < 2) {
      const { data: solicitudes } = await this.supabase.client
        .from('mortgage_applications')
        .select('*')
        .in('status', ['pending', 'in_review', 'sent_to_bank'])
        .order('updated_at', { ascending: false })
        .limit(10);

      if (!solicitudes || solicitudes.length === 0) {
        await this.twilio.sendWhatsAppMessage(from, `ğŸ“‹ No hay crÃ©ditos en proceso actualmente.`);
        return;
      }

      let resp = `ğŸ“‹ *CrÃ©ditos en proceso:*\n\n`;
      solicitudes.forEach((s: any) => {
        const emoji = s.status === 'pending' ? 'â³' : s.status === 'in_review' ? 'ğŸ“‹' : 'ğŸ¦';
        resp += `${emoji} *${s.lead_name}* - ${s.bank}\n   ${s.status === 'pending' ? 'Pendiente' : s.status === 'in_review' ? 'En revisiÃ³n' : 'En banco'}\n`;
      });
      resp += `\nğŸ’¡ Escribe *"Â¿CÃ³mo va crÃ©dito de Juan?"* para detalle`;

      await this.twilio.sendWhatsAppMessage(from, resp);
      return;
    }

    // Buscar solicitudes del lead
    const { data: solicitudes } = await this.supabase.client
      .from('mortgage_applications')
      .select('*')
      .ilike('lead_name', '%' + nombreLead + '%')
      .order('created_at', { ascending: false });

    if (!solicitudes || solicitudes.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© solicitudes de crÃ©dito para *${nombreLead}*`);
      return;
    }

    let resp = `ğŸ“‹ *CrÃ©ditos de ${solicitudes[0].lead_name}:*\n\n`;

    solicitudes.forEach((s: any) => {
      let emoji = 'â³';
      let estadoTexto = 'Pendiente';
      
      switch(s.status) {
        case 'pending': emoji = 'â³'; estadoTexto = 'Pendiente docs'; break;
        case 'in_review': emoji = 'ğŸ“‹'; estadoTexto = 'En revisiÃ³n'; break;
        case 'sent_to_bank': emoji = 'ğŸ¦'; estadoTexto = 'En banco'; break;
        case 'approved': emoji = 'âœ…'; estadoTexto = 'APROBADO'; break;
        case 'rejected_on': emoji = 'âš ï¸'; estadoTexto = 'Rechazado (puede reintentar)'; break;
        case 'rejected_off': emoji = 'âŒ'; estadoTexto = 'Rechazado definitivo'; break;
      }

      resp += `${emoji} *${s.bank}*: ${estadoTexto}\n`;
      if (s.status_notes) resp += `   ğŸ“ ${s.status_notes}\n`;
    });

    // Preguntar al asesor si hay solicitud activa
    const solicitudActiva = solicitudes.find((s: any) => ['pending', 'in_review', 'sent_to_bank'].includes(s.status));
    if (solicitudActiva && solicitudActiva.assigned_advisor_id) {
      resp += `\nÂ¿Quieres que le pregunte al asesor?\n*1.* SÃ­, pregÃºntale\n*2.* No, estÃ¡ bien`;
      
      // Guardar estado para siguiente mensaje
      const { data: lead } = await this.supabase.client
        .from('leads')
        .select('id, notes')
        .ilike('name', '%' + nombreLead + '%')
        .single();
      
      if (lead) {
        await this.supabase.client
          .from('leads')
          .update({ 
            notes: { 
              ...(lead.notes || {}), 
              pending_credit_inquiry: solicitudActiva.id 
            } 
          })
          .eq('id', lead.id);
      }
    }

    await this.twilio.sendWhatsAppMessage(from, resp);
  }

  private async vendedorBriefing(from: string, vendedor: any, nombre: string): Promise<void> {
    // Combinar citas + leads + meta en un solo briefing
    const hoy = new Date();
    const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()).toISOString();
    const finHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() + 1).toISOString();

    const [citasRes, leadsRes] = await Promise.all([
      this.supabase.client.from('appointments')
        .select('*, leads(name)')
        .eq('team_member_id', vendedor.id)
        .gte('date', inicioHoy)
        .lt('date', finHoy)
        .order('date', { ascending: true }),
      this.supabase.client.from('leads')
        .select('*')
        .eq('assigned_to', vendedor.id)
        .in('status', ['new', 'contacted', 'scheduled'])
    ]);

    const citas = citasRes.data || [];
    const leads = leadsRes.data || [];
    const hot = leads.filter((l: any) => l.lead_category?.toUpperCase() === 'HOT').length;

    let respuesta = `â˜€ï¸ *Buenos dÃ­as ${nombre}!*

`;

    // Citas
    if (citas.length > 0) {
      respuesta += `ğŸ“… *${citas.length} cita(s) hoy:*
`;
      citas.slice(0, 3).forEach((cita: any) => {
        const hora = new Date(cita.date).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
        respuesta += `â€¢ ${hora} - ${cita.leads?.name || 'Cliente'}
`;
      });
      if (citas.length > 3) respuesta += `  _+${citas.length - 3} mÃ¡s..._
`;
    } else {
      respuesta += `ğŸ“… Sin citas hoy
`;
    }

    // Leads HOT
    respuesta += `
ğŸ”¥ *${hot} leads HOT* esperando`;
    if (hot > 0) respuesta += ` â† Â¡Atender!`;

    respuesta += `
ğŸ“Š *${leads.length} leads* activos total`;

    respuesta += `

Â¡A vender! ğŸ’ª`;

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FUNCIONES DE ACTUALIZACIÃ“N DEL VENDEDOR
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorCerrarVenta(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Extraer nombre del lead del mensaje
    const match = body.match(/cerr[eÃ©].*(?:con|a|el lead|la lead|cliente)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, 
        `ğŸ¤” No entendÃ­ el nombre del cliente.

Escribe asÃ­:
*"CerrÃ© venta con Juan GarcÃ­a"*`
      );
      return;
    }

    const nombreLead = match[1].trim();
    
    // Buscar el lead
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .ilike('name', `%${nombreLead}%`)
      .limit(1);

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No encontrÃ© a *${nombreLead}* en tus leads.

Â¿EstÃ¡ bien escrito el nombre?`
      );
      return;
    }

    const lead = leads[0];
    
    // Actualizar a vendido
    await this.supabase.client
      .from('leads')
      .update({ 
        status: 'sold',
        lead_category: 'CLOSED',
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from,
      `ğŸ‰ *Â¡VENTA CERRADA!*

âœ… *${lead.name}* actualizado a VENDIDO

Â¡Felicidades ${nombre}! ğŸ†`
    );
  }


  private async vendedorCancelarLead(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Extraer nombre
    const match = body.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)\s+(?:cancel[oÃ³]|ya no|se perdiÃ³|perdi)/i) ||
                  body.match(/(?:cancel[oÃ³]|perdÃ­|perdi).*(?:a|con|el lead)?\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ¤” No entendÃ­.

Escribe asÃ­:
*"Juan GarcÃ­a cancelÃ³"*
o
*"PerdÃ­ a MarÃ­a LÃ³pez"*`
      );
      return;
    }

    const nombreLead = match[1].trim();

    // Buscar TODOS los leads que coincidan
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .ilike('name', `%${nombreLead}%`);

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No encontrÃ© a *${nombreLead}* en tus leads.`
      );
      return;
    }

    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads con ese nombre:\n\n`;
      leads.forEach((l: any, i: number) => {
        const tel = l.phone?.slice(-4) || '????';
        msg += `${i + 1}. ${l.name} (...${tel})\n`;
      });
      msg += `\nEscribe el nombre completo.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];

    // Pedir motivo
    await this.supabase.client
      .from('leads')
      .update({ 
        status: 'cancelled',
        lead_category: 'LOST',
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from,
      `ğŸ“ *${lead.name}* marcado como CANCELADO.

Â¿CuÃ¡l fue el motivo?
1. ComprÃ³ otra casa
2. Ya no le interesa
3. Sin presupuesto
4. No contestÃ³
5. Otro`
    );
  }

  private async vendedorAgendarCita(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Extraer: agendar cita con [nombre] [fecha/dÃ­a] [hora]
    const match = body.match(/agendar?.*(?:con|a)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s+(?:para\s+)?(?:el\s+)?)?(?:maÃ±ana|hoy|lunes|martes|miÃ©rcoles|jueves|viernes|sÃ¡bado|domingo)?/i);

    if (!match) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ¤” No entendÃ­.

Escribe asÃ­:
*"Agendar cita con Juan GarcÃ­a maÃ±ana 10am"*`
      );
      return;
    }

    const nombreLead = match[1].trim();

    // Buscar lead
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', vendedor.id)
      .ilike('name', `%${nombreLead}%`)
      .limit(1);

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No encontrÃ© a *${nombreLead}* en tus leads.`
      );
      return;
    }

    const lead = leads[0];
    
    // Por ahora solo confirmar - despuÃ©s agregaremos fecha/hora parsing
    await this.twilio.sendWhatsAppMessage(from,
      `ğŸ“… Â¿Para cuÃ¡ndo quieres la cita con *${lead.name}*?

Responde con fecha y hora:
*"MaÃ±ana 10am"*
*"Viernes 3pm"*`
    );
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // NOTAS POR LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorAgregarNota(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Formato: "Nota Juan: le interesa jardÃ­n" o "Apunte MarÃ­a: presupuesto 2M"
    const match = body.match(/(?:nota|apunte|anotar)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?):\s*(.+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“ Para agregar nota escribe:

*"Nota Juan: le interesa jardÃ­n"*
*"Apunte MarÃ­a: presupuesto 2M"*`
      );
      return;
    }

    const nombreLead = match[1].trim();
    const textoNota = match[2].trim();

    // Buscar TODOS los leads que coincidan
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, notes, phone')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No encontrÃ© a *${nombreLead}* en tus leads.`
      );
      return;
    }

    // Si hay mÃºltiples, pedir que especifique
    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads con ese nombre:

`;
      leads.forEach((l, i) => {
        const tel = l.phone?.slice(-4) || '????';
        msg += `${i + 1}. ${l.name} (...${tel})
`;
      });
      msg += `
Escribe el nombre completo para continuar.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];
    
    // Agregar nota al JSON existente
    const notasActuales = lead.notes || {};
    const historialNotas = notasActuales.historial || [];
    
    historialNotas.push({
      fecha: new Date().toISOString(),
      texto: textoNota,
      autor: vendedor.name || nombre
    });

    await this.supabase.client
      .from('leads')
      .update({ 
        notes: { ...notasActuales, historial: historialNotas },
        updated_at: new Date().toISOString()
      })
      .eq('id', lead.id);

    await this.twilio.sendWhatsAppMessage(from,
      `âœ… Nota guardada para *${lead.name}*:

_"${textoNota}"_

ğŸ“ Total: ${historialNotas.length} nota(s)`
    );
  }

  private async vendedorVerNotas(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Formato: "Notas de Juan" o "Info de MarÃ­a"
    const match = body.match(/(?:notas de|info de|quÃ© sÃ© de)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“ Para ver notas escribe:

*"Notas de Juan"*
*"Info de MarÃ­a"*`
      );
      return;
    }

    const nombreLead = match[1].trim();

    // Buscar TODOS los leads que coincidan
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, notes, phone, lead_category, banco_preferido, enganche_disponible, status')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No encontrÃ© a *${nombreLead}* en tus leads.`
      );
      return;
    }

    // Si hay mÃºltiples, pedir que especifique
    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads con ese nombre:

`;
      leads.forEach((l, i) => {
        const tel = l.phone?.slice(-4) || '????';
        msg += `${i + 1}. ${l.name} (...${tel})
`;
      });
      msg += `
Escribe el nombre completo para continuar.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];
    const notas = lead.notes?.historial || [];
    
    let respuesta = `ğŸ“‹ *Info de ${lead.name}*

`;
    respuesta += `ğŸ“± ${lead.phone}
`;
    respuesta += `ğŸ·ï¸ ${lead.lead_category || 'Sin categorÃ­a'} | ${lead.status || 'nuevo'}
`;
    
    if (lead.banco_preferido) respuesta += `ğŸ¦ ${lead.banco_preferido}
`;
    if (lead.enganche_disponible) respuesta += `ğŸ’° Enganche: $${lead.enganche_disponible.toLocaleString()}
`;
    
    if (notas.length > 0) {
      respuesta += `
ğŸ“ *Notas (${notas.length}):*
`;
      notas.slice(-5).forEach((n: any, i: number) => {
        const fecha = new Date(n.fecha).toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
        respuesta += `${i + 1}. _${n.texto}_ (${fecha})
`;
      });
      if (notas.length > 5) respuesta += `_...y ${notas.length - 5} mÃ¡s_`;
    } else {
      respuesta += `
ğŸ“ Sin notas aÃºn`;
    }

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AYUDA CONTEXTUAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorAyudaContextual(from: string, body: string, nombre: string): Promise<void> {
    const msg = body.toLowerCase();
    
    if (msg.includes('cita') && (msg.includes('agend') || msg.includes('crear') || msg.includes('hago'))) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“… *Para agendar cita escribe:*\n\n"Cita con [nombre] [dÃ­a] [hora] en [desarrollo]"\n\n*Ejemplos:*\nâ€¢ "Cita con Ana maÃ±ana 10am en Distrito Falco"\nâ€¢ "Agendar Juan viernes 3pm en Los Encinos"\n\n*Si el lead es nuevo:*\nâ€¢ "Crear Ana GarcÃ­a 5512345678"`
      );
      return;
    }
    
    if (msg.includes('cancel')) {
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ *Para cancelar cita escribe:*\n\n"Cancelar cita con [nombre]"\n\n*Ejemplo:*\nâ€¢ "Cancelar cita con Ana"`
      );
      return;
    }
    
    if (msg.includes('reagend') || msg.includes('mover') || msg.includes('cambiar')) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ”„ *Para reagendar cita escribe:*\n\n"Reagendar [nombre] para [dÃ­a] [hora]"\n\n*Ejemplo:*\nâ€¢ "Reagendar Ana para lunes 3pm"`
      );
      return;
    }
    
    if (msg.includes('nota') || msg.includes('apunte')) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“ *Para agregar nota escribe:*\n\n"Nota [nombre]: [texto]"\n\n*Ejemplos:*\nâ€¢ "Nota Juan: le interesa jardÃ­n"\nâ€¢ "Apunte MarÃ­a: presupuesto 2M"\n\n*Para ver notas:*\nâ€¢ "Notas de Juan"`
      );
      return;
    }
    
    if (msg.includes('cerr') || msg.includes('venta') || msg.includes('vend')) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ‰ *Para cerrar venta escribe:*\n\n"CerrÃ© venta con [nombre]"\n\n*Ejemplo:*\nâ€¢ "CerrÃ© venta con Juan GarcÃ­a"`
      );
      return;
    }
    
    if (msg.includes('etapa') || msg.includes('avanz') || msg.includes('mover lead')) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“Š *Para cambiar etapa escribe:*\n\n"[nombre] pasÃ³ a [etapa]"\n\n*Etapas:* contactado, cita agendada, visitÃ³, negociaciÃ³n, cierre\n\n*Ejemplo:*\nâ€¢ "Juan pasÃ³ a negociaciÃ³n"`
      );
      return;
    }
    
    if (msg.includes('lead') && msg.includes('crear')) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ‘¤ *Para crear lead nuevo escribe:*\n\n"Crear [nombre] [telÃ©fono]"\n\n*Ejemplo:*\nâ€¢ "Crear Ana GarcÃ­a 5512345678"`
      );
      return;
    }
    
    // Default: mostrar todo
    await this.twilio.sendWhatsAppMessage(from,
      `ğŸ¤” Â¿QuÃ© necesitas saber ${nombre}?\n\nâ€¢ Â¿CÃ³mo agendo cita?\nâ€¢ Â¿CÃ³mo cancelo cita?\nâ€¢ Â¿CÃ³mo agrego nota?\nâ€¢ Â¿CÃ³mo cierro venta?\nâ€¢ Â¿CÃ³mo cambio etapa?\nâ€¢ Â¿CÃ³mo creo lead?\n\nPregÃºntame cualquiera ğŸ‘†`
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CREAR LEAD NUEVO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorCrearLead(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Formato: "Crear Ana GarcÃ­a 5512345678"
    const match = body.match(/crear\s+(.+?)\s+(\d{10})/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ‘¤ Formato: *"Crear Ana GarcÃ­a 5512345678"*`
      );
      return;
    }

    const nombreLead = match[1].trim();
    const telefono = match[2];

    // Verificar si ya existe
    const { data: existente } = await this.supabase.client
      .from('leads')
      .select('id, name')
      .eq('phone', telefono)
      .limit(1);

    if (existente && existente.length > 0) {
      await this.twilio.sendWhatsAppMessage(from,
        `âš ï¸ Ya existe un lead con ese telÃ©fono:\n*${existente[0].name}*`
      );
      return;
    }

    // Crear lead
    const { data: nuevoLead, error } = await this.supabase.client
      .from('leads')
      .insert({
        name: nombreLead,
        phone: telefono,
        assigned_to: vendedor.id,
        status: 'new',
        lead_category: 'WARM',
        source: 'vendedor_whatsapp',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .select()
      .single();

    if (error) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ Error al crear lead: ${error.message}`);
      return;
    }

    await this.twilio.sendWhatsAppMessage(from,
      `âœ… *Lead creado:*\n\nğŸ‘¤ ${nombreLead}\nğŸ“± ${telefono}\nğŸ·ï¸ WARM\n\nYa puedes agendar cita con este lead.`
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // AGENDAR CITA COMPLETA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorAgendarCitaCompleta(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    // Parsear: "Cita maÃ±ana 5pm con Spiderman Canseco 5512345678 en Distrito Falco"
    // Extraer telÃ©fono si viene
    const matchTelefono = body.match(/(\d{10})/);
    const telefono = matchTelefono ? matchTelefono[1] : null;
    
    // Extraer nombre - mÃ¡s flexible
    let nombreLead = '';
    const matchNombreConTel = body.match(/(?:con|para)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)\s+\d{10}/i);
    const matchNombreSinTel = body.match(/(?:cita con|agendar|para)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s+(?:maÃ±ana|hoy|lunes|martes|miÃ©rcoles|miercoles|jueves|viernes|sÃ¡bado|sabado|domingo|para el|para|el|a las|\d))/i);
    
    if (matchNombreConTel) {
      nombreLead = matchNombreConTel[1].trim();
    } else if (matchNombreSinTel) {
      nombreLead = matchNombreSinTel[1].trim();
    }
    
    const matchNombre = { 1: nombreLead }; // Para compatibilidad con cÃ³digo abajo
    const matchHora = body.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
    const matchDia = body.match(/(maÃ±ana|hoy|lunes|martes|miÃ©rcoles|miercoles|jueves|viernes|sÃ¡bado|sabado|domingo)/i);
    const matchDesarrollo = body.match(/(?:en|desarrollo)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)$/i);

    if (!matchNombre) {
      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ“… Escribe asÃ­:\n*"Cita con Ana maÃ±ana 10am en Distrito Falco"*`
      );
      return;
    }

    // nombreLead ya definido arriba
    
    // Buscar lead
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, phone')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      // Buscar por telÃ©fono si tenemos
      if (telefono) {
        const { data: leadPorTel } = await this.supabase.client
          .from('leads')
          .select('*')
          .eq('phone', telefono)
          .single();
        
        if (leadPorTel) {
          // Lead ya existe con ese telÃ©fono, usarlo
          console.log('ğŸ“± Lead encontrado por telÃ©fono:', leadPorTel.name);
          leads = [leadPorTel];
        } else {
          // No existe, CREAR AUTOMÃTICAMENTE
          const { data: nuevoLead, error } = await this.supabase.client
            .from('leads')
            .insert({
              name: nombreLead,
              phone: telefono,
              assigned_to: vendedor.id,
              status: 'scheduled',
              lead_category: 'COLD',
              source: 'vendedor_calle',
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            })
            .select()
            .single();

          if (error || !nuevoLead) {
            await this.twilio.sendWhatsAppMessage(from, `âŒ Error creando lead: ${error?.message}`);
            return;
          }
          
          console.log('âœ… Lead creado automÃ¡ticamente:', nuevoLead.name);
          leads = [nuevoLead];
        }
      } else {
        // No tiene telÃ©fono, pedir
        await this.twilio.sendWhatsAppMessage(from,
          `ğŸ“± No encontrÃ© a *${nombreLead}*. Incluye el telÃ©fono:\n\n*"Cita maÃ±ana 5pm con ${nombreLead} 55XXXXXXXX en Distrito Falco"*`
        );
        return;
      }
    }

    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads:\n\n`;
      leads.forEach((l: any, i: number) => {
        msg += `${i + 1}. ${l.name} (...${l.phone?.slice(-4) || '????'})\n`;
      });
      msg += `\nEscribe nombre completo.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];

    // Calcular fecha
    let fecha = new Date();
    if (matchDia) {
      const dia = matchDia[1].toLowerCase();
      if (dia === 'maÃ±ana') {
        fecha.setDate(fecha.getDate() + 1);
      } else if (dia !== 'hoy') {
        const dias: any = { 'lunes': 1, 'martes': 2, 'miÃ©rcoles': 3, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sÃ¡bado': 6, 'sabado': 6, 'domingo': 0 };
        const targetDay = dias[dia];
        const currentDay = fecha.getDay();
        let daysToAdd = targetDay - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7;
        fecha.setDate(fecha.getDate() + daysToAdd);
      }
    }

    // Calcular hora
    if (matchHora) {
      let hora = parseInt(matchHora[1]);
      const minutos = matchHora[2] ? parseInt(matchHora[2]) : 0;
      const ampm = matchHora[3].toLowerCase();
      if (ampm === 'pm' && hora < 12) hora += 12;
      if (ampm === 'am' && hora === 12) hora = 0;
      fecha.setHours(hora, minutos, 0, 0);
    }

    const desarrollo = matchDesarrollo ? matchDesarrollo[1].trim() : 'Por definir';

    // Crear cita
    const horaForDB = fecha.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', hour12: false });
    const { error, data: citaCreada } = await this.supabase.client
      .from('appointments')
      .insert({
        lead_id: lead.id,
        lead_phone: lead.phone,
        lead_name: lead.name,
        property_id: null,
        property_name: desarrollo,
        vendedor_id: vendedor.id,
        vendedor_name: nombre,
        scheduled_date: fecha.toISOString().split('T')[0],
        scheduled_time: horaForDB,
        status: 'scheduled',
        appointment_type: 'visita',
        duration_minutes: 60
      });

    if (error) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ Error: ${error.message}`);
      return;
    }

    // Crear evento en Google Calendar
    try {
      const endFecha = new Date(fecha.getTime() + 60 * 60 * 1000); // +1 hora
      
      const formatDate = (d: Date) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}:00`;
      };

      const eventData = {
        summary: `ğŸ  Visita ${desarrollo} - ${lead.name}`,
        description: `ğŸ‘¤ Cliente: ${lead.name}\nğŸ“± TelÃ©fono: ${lead.phone}\nğŸ  Desarrollo: ${desarrollo}\nğŸ“ Agendada via WhatsApp`,
        location: desarrollo,
        start: { dateTime: formatDate(fecha), timeZone: 'America/Mexico_City' },
        end: { dateTime: formatDate(endFecha), timeZone: 'America/Mexico_City' },
        attendees: vendedor?.email ? [{ email: vendedor.email }] : []
      };

      const eventResult = await this.calendar.createEvent(eventData);
      console.log('ğŸ“… Evento Google Calendar creado:', eventResult?.id || 'OK');
      
      // Guardar ID del evento en la cita
      if (citaCreada?.id && eventResult?.id) {
        await this.supabase.client
          .from('appointments')
          .update({ google_event_vendedor_id: eventResult.id })
          .eq('id', citaCreada.id);
      }
    } catch (calError) {
      console.error('âŒ Error Google Calendar:', calError);
      // No bloqueamos el flujo si falla el calendario
    }

    // Actualizar status del lead
    await this.supabase.client
      .from('leads')
      .update({ status: 'scheduled', updated_at: new Date().toISOString() })
      .eq('id', lead.id);

    const fechaStr = fecha.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });
    const horaStr = fecha.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

    await this.twilio.sendWhatsAppMessage(from,
      `âœ… *Cita agendada:*\n\nğŸ“… ${fechaStr}, ${horaStr}\nğŸ‘¤ ${lead.name} (...${lead.phone?.slice(-4)})\nğŸ  ${desarrollo}\n\nÂ¿Le mando confirmaciÃ³n a ${lead.name}?\n*1.* SÃ­, mÃ¡ndale\n*2.* No, yo le aviso`
    );
    
    // Guardar estado para la siguiente respuesta
    await this.supabase.client
      .from('leads')
      .update({ 
        notes: { 
          ...(lead.notes || {}), 
          pending_confirmation: { lead_id: lead.id, phone: lead.phone, fecha: fechaStr, hora: horaStr, desarrollo } 
        }
      })
      .eq('id', lead.id);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CANCELAR CITA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorCancelarCita(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    const match = body.match(/cancelar cita (?:con|de)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+)/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ Escribe: *"Cancelar cita con Ana"*`);
      return;
    }

    const nombreLead = match[1].trim();

    // Buscar lead
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, phone')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads:\n\n`;
      leads.forEach((l: any, i: number) => {
        msg += `${i + 1}. ${l.name} (...${l.phone?.slice(-4) || '????'})\n`;
      });
      msg += `\nEscribe nombre completo.`;
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];

    // Buscar cita pendiente
    const { data: citas } = await this.supabase.client
      .from('appointments')
      .select('*')
      .eq('lead_id', lead.id)
      .eq('status', 'scheduled')
      .order('date', { ascending: true })
      .limit(1);

    if (!citas || citas.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âš ï¸ ${lead.name} no tiene citas pendientes.`);
      return;
    }

    const cita = citas[0];
    const fechaCita = new Date(cita.date);
    const fechaStr = fechaCita.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });
    const horaStr = fechaCita.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

    // Cancelar
    await this.supabase.client
      .from('appointments')
      .update({ status: 'cancelled', updated_at: new Date().toISOString() })
      .eq('id', cita.id);

    await this.twilio.sendWhatsAppMessage(from,
      `âŒ *Cita cancelada:*\n\nğŸ‘¤ ${lead.name}\nğŸ“… Era: ${fechaStr}, ${horaStr}\n\nÂ¿Le aviso a ${lead.name}?\n*1.* SÃ­, mÃ¡ndale\n*2.* No, yo le aviso`
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // REAGENDAR CITA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorReagendarCita(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    const match = body.match(/reagendar\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+?)(?:\s+para)?\s+(maÃ±ana|hoy|lunes|martes|miÃ©rcoles|miercoles|jueves|viernes|sÃ¡bado|sabado|domingo)?\s*(\d{1,2})?(?::(\d{2}))?\s*(am|pm)?/i);
    
    if (!match) {
      await this.twilio.sendWhatsAppMessage(from, `ğŸ”„ Escribe: *"Reagendar Ana para lunes 3pm"*`);
      return;
    }

    const nombreLead = match[1].trim();
    const diaStr = match[2];
    const horaNum = match[3];
    const ampm = match[5];

    // Buscar lead
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, phone')
      .eq('assigned_to', vendedor.id)
      .ilike('name', '%' + nombreLead + '%');

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âŒ No encontrÃ© a *${nombreLead}*`);
      return;
    }

    if (leads.length > 1) {
      let msg = `ğŸ¤” EncontrÃ© ${leads.length} leads:\n\n`;
      leads.forEach((l: any, i: number) => {
        msg += `${i + 1}. ${l.name} (...${l.phone?.slice(-4) || '????'})\n`;
      });
      await this.twilio.sendWhatsAppMessage(from, msg);
      return;
    }

    const lead = leads[0];

    // Buscar cita existente
    const { data: citas } = await this.supabase.client
      .from('appointments')
      .select('*')
      .eq('lead_id', lead.id)
      .eq('status', 'scheduled')
      .limit(1);

    if (!citas || citas.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, `âš ï¸ ${lead.name} no tiene citas pendientes para reagendar.`);
      return;
    }

    const cita = citas[0];
    const fechaAnterior = new Date(cita.date);

    // Calcular nueva fecha
    let nuevaFecha = new Date();
    if (diaStr) {
      const dia = diaStr.toLowerCase();
      if (dia === 'maÃ±ana') {
        nuevaFecha.setDate(nuevaFecha.getDate() + 1);
      } else if (dia !== 'hoy') {
        const dias: any = { 'lunes': 1, 'martes': 2, 'miÃ©rcoles': 3, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sÃ¡bado': 6, 'sabado': 6, 'domingo': 0 };
        const targetDay = dias[dia];
        const currentDay = nuevaFecha.getDay();
        let daysToAdd = targetDay - currentDay;
        if (daysToAdd <= 0) daysToAdd += 7;
        nuevaFecha.setDate(nuevaFecha.getDate() + daysToAdd);
      }
    }

    if (horaNum && ampm) {
      let hora = parseInt(horaNum);
      if (ampm.toLowerCase() === 'pm' && hora < 12) hora += 12;
      if (ampm.toLowerCase() === 'am' && hora === 12) hora = 0;
      nuevaFecha.setHours(hora, 0, 0, 0);
    }

    // Actualizar cita
    await this.supabase.client
      .from('appointments')
      .update({ date: nuevaFecha.toISOString(), updated_at: new Date().toISOString() })
      .eq('id', cita.id);

    const fechaAnteriorStr = fechaAnterior.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' });
    const horaAnteriorStr = fechaAnterior.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    const fechaNuevaStr = nuevaFecha.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'short' });
    const horaNuevaStr = nuevaFecha.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

    await this.twilio.sendWhatsAppMessage(from,
      `âœ… *Cita reagendada:*\n\nğŸ‘¤ ${lead.name}\nğŸ“… Antes: ${fechaAnteriorStr}, ${horaAnteriorStr}\nğŸ“… Ahora: ${fechaNuevaStr}, ${horaNuevaStr}\n\nÂ¿Le aviso del cambio?\n*1.* SÃ­\n*2.* No`
    );
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IA HÃBRIDA - Clasificar intent cuando no matchea palabras
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async vendedorIntentIA(from: string, body: string, vendedor: any, nombre: string): Promise<void> {
    try {
      const prompt = `Eres un clasificador de intents para un asistente de vendedores inmobiliarios.

El vendedor escribiÃ³: "${body}"

Clasifica en UNO de estos intents:
- ayuda_citas: pregunta CÃ“MO agendar/cancelar/reagendar citas
- ayuda_notas: pregunta CÃ“MO agregar notas
- ayuda_ventas: pregunta CÃ“MO cerrar ventas o cambiar etapas
- ayuda_general: pregunta quÃ© puede hacer el asistente
- briefing: saludo o quiere resumen del dÃ­a
- ver_citas: quiere VER sus citas de hoy
- ver_meta: quiere ver su avance/meta
- ver_leads: quiere ver sus leads
- agendar_cita: quiere AGENDAR una cita (incluye nombre y/o fecha)
- cancelar_cita: quiere CANCELAR una cita
- reagendar_cita: quiere MOVER/CAMBIAR fecha de cita
- cerrar_venta: reporta que CERRÃ“ una venta
- cambiar_etapa: quiere mover lead en el funnel
- agregar_nota: quiere AGREGAR una nota a un lead
- ver_notas: quiere VER notas/info de un lead
- crear_lead: quiere crear un lead nuevo
- no_entiendo: no es ninguna de las anteriores

Responde SOLO con el intent, nada mÃ¡s.`;

      const response = await this.openai.chat([
        { role: 'system', content: 'Responde solo con el intent exacto, sin explicaciones.' },
        { role: 'user', content: prompt }
      ], { max_tokens: 20, temperature: 0 });

      const intent = response.trim().toLowerCase().replace(/[^a-z_]/g, '');
      console.log('ğŸ¤– IA Intent detectado:', intent, 'para mensaje:', body);

      // Ejecutar segÃºn intent
      switch (intent) {
        case 'ayuda_citas':
          await this.twilio.sendWhatsAppMessage(from,
            `ğŸ“… *Para agendar cita escribe:*\n\n"Cita con [nombre] [dÃ­a] [hora] en [desarrollo]"\n\n*Ejemplos:*\nâ€¢ "Cita con Ana maÃ±ana 10am en Distrito Falco"\nâ€¢ "Agendar Juan viernes 3pm"\n\n*Para cancelar:* "Cancelar cita con Ana"\n*Para mover:* "Reagendar Ana para lunes 3pm"`
          );
          break;
        case 'ayuda_notas':
          await this.twilio.sendWhatsAppMessage(from,
            `ğŸ“ *Para agregar nota escribe:*\n\n"Nota [nombre]: [texto]"\n\n*Ejemplos:*\nâ€¢ "Nota Juan: le interesa jardÃ­n"\nâ€¢ "Apunte MarÃ­a: presupuesto 2M"\n\n*Para ver notas:* "Notas de Juan"`
          );
          break;
        case 'ayuda_ventas':
          await this.twilio.sendWhatsAppMessage(from,
            `ğŸ‰ *Para cerrar venta:*\n"CerrÃ© venta con [nombre]"\n\n*Para cambiar etapa:*\n"[nombre] pasÃ³ a [etapa]"\n\n*Etapas:* contactado, cita agendada, visitÃ³, negociaciÃ³n, cierre`
          );
          break;
        case 'ayuda_general':
          await this.vendedorAyuda(from, nombre);
          break;
        case 'briefing':
          await this.vendedorBriefing(from, vendedor, nombre);
          break;
        case 'ver_citas':
          await this.vendedorCitasHoy(from, vendedor, nombre);
          break;
        case 'ver_meta':
          await this.vendedorMetaAvance(from, vendedor, nombre);
          break;
        case 'ver_leads':
          await this.vendedorResumenLeads(from, vendedor, nombre);
          break;
        case 'agendar_cita':
          await this.vendedorAgendarCitaCompleta(from, body, vendedor, nombre);
          break;
        case 'cancelar_cita':
          await this.vendedorCancelarCita(from, body, vendedor, nombre);
          break;
        case 'reagendar_cita':
          await this.vendedorReagendarCita(from, body, vendedor, nombre);
          break;
        case 'cerrar_venta':
          await this.vendedorCerrarVenta(from, body, vendedor, nombre);
          break;
        case 'cambiar_etapa':
          await this.vendedorCambiarEtapa(from, body, vendedor, nombre);
          break;
        case 'agregar_nota':
          await this.vendedorAgregarNota(from, body, vendedor, nombre);
          break;
        case 'ver_notas':
          await this.vendedorVerNotas(from, body, vendedor, nombre);
          break;
        case 'crear_lead':
          await this.vendedorCrearLead(from, body, vendedor, nombre);
          break;
        default:
          await this.vendedorAyuda(from, nombre);
      }
    } catch (error) {
      console.error('âŒ Error en IA Intent:', error);
      await this.vendedorAyuda(from, nombre);
    }
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONFIRMACIÃ“N DE CITA AL LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async hayConfirmacionPendiente(vendedorId: string): Promise<boolean> {
    const { data } = await this.supabase.client
      .from('leads')
      .select('id, notes')
      .eq('assigned_to', vendedorId)
      .not('notes->pending_confirmation', 'is', null)
      .limit(1);
    
    return data && data.length > 0;
  }

  private async enviarConfirmacionAlLead(from: string, vendedor: any, nombre: string): Promise<void> {
    // Buscar lead con confirmaciÃ³n pendiente
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, phone, notes')
      .eq('assigned_to', vendedor.id)
      .not('notes->pending_confirmation', 'is', null)
      .limit(1);

    if (!leads || leads.length === 0) {
      await this.twilio.sendWhatsAppMessage(from, 'âš ï¸ No encontrÃ© cita pendiente de confirmar.');
      return;
    }

    const lead = leads[0];
    const conf = lead.notes?.pending_confirmation;

    if (!conf || !lead.phone) {
      await this.twilio.sendWhatsAppMessage(from, 'âš ï¸ El lead no tiene telÃ©fono registrado.');
      return;
    }

    // Formatear telÃ©fono del lead
    const leadPhone = lead.phone.replace(/\D/g, '').slice(-10);
    
    // Enviar confirmaciÃ³n al lead
    const msgLead = `Â¡Hola ${lead.name?.split(' ')[0] || ''}! ğŸ 

Te confirmamos tu cita:
ğŸ“… ${conf.fecha}
ğŸ• ${conf.hora}
ğŸ“ ${conf.desarrollo || 'Por confirmar ubicaciÃ³n'}

Te esperamos. Â¿Tienes alguna duda? ğŸ˜Š`;

    try {
      await this.twilio.sendWhatsAppMessage(`whatsapp:+52${leadPhone}`, msgLead);
      
      // Limpiar confirmaciÃ³n pendiente
      const notasLimpias = { ...(lead.notes || {}) };
      delete notasLimpias.pending_confirmation;
      
      await this.supabase.client
        .from('leads')
        .update({ notes: notasLimpias })
        .eq('id', lead.id);

      await this.twilio.sendWhatsAppMessage(from,
        `âœ… *ConfirmaciÃ³n enviada a ${lead.name}*\n\nğŸ“± ${lead.phone}\n\nÂ¡Listo ${nombre}!`
      );
    } catch (error: any) {
      console.error('Error enviando confirmaciÃ³n:', error);
      await this.twilio.sendWhatsAppMessage(from,
        `âŒ No pude enviar a ${lead.name}. Verifica el nÃºmero: ${lead.phone}`
      );
    }
  }

  private async cancelarConfirmacionPendiente(from: string, vendedor: any, nombre: string): Promise<void> {
    // Buscar y limpiar confirmaciÃ³n pendiente
    let { data: leads } = await this.supabase.client
      .from('leads')
      .select('id, name, notes')
      .eq('assigned_to', vendedor.id)
      .not('notes->pending_confirmation', 'is', null)
      .limit(1);

    if (leads && leads.length > 0) {
      const lead = leads[0];
      const notasLimpias = { ...(lead.notes || {}) };
      delete notasLimpias.pending_confirmation;
      
      await this.supabase.client
        .from('leads')
        .update({ notes: notasLimpias })
        .eq('id', lead.id);

      await this.twilio.sendWhatsAppMessage(from,
        `ğŸ‘ Ok ${nombre}, tÃº le avisas a ${lead.name}.`
      );
    }
  }

    private async vendedorAyuda(from: string, nombre: string): Promise<void> {
    const respuesta = `ğŸ‘‹ *Hola ${nombre}!*

Soy SARA, tu asistente. Puedo ayudarte con:

ğŸ“… *"Â¿QuÃ© citas tengo hoy?"*
â†’ Tu agenda del dÃ­a

ğŸ“Š *"Â¿CÃ³mo va mi meta?"*
â†’ Tu avance de ventas

ğŸ“‹ *"Â¿CuÃ¡ntos leads tengo?"*
â†’ Resumen de prospectos

â° *"Â¿QuÃ© pendientes tengo?"*
â†’ Follow-ups urgentes

â˜€ï¸ *"Briefing"*
â†’ Resumen matutino completo


ğŸ“ *ACTUALIZAR:*
â€¢ "CerrÃ© venta con Juan"
â€¢ "MarÃ­a pasÃ³ a negociaciÃ³n"
â€¢ "Pedro cancelÃ³"
â€¢ "Agendar cita con Ana"


ğŸ“ *NOTAS:*
â€¢ "Nota Juan: le gusta jardÃ­n"
â€¢ "Notas de Juan"

Â¡PregÃºntame lo que necesites! ğŸš€`;

    await this.twilio.sendWhatsAppMessage(from, respuesta);
  }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OBTENER O CREAR LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async getOrCreateLead(phone: string): Promise<any> {
    // Normalizar telefono: extraer ultimos 10 digitos y agregar 521
    const digits = phone.replace(/\D/g, '').slice(-10);
    const normalizedPhone = '521' + digits;
    
    // Buscar por ultimos 10 digitos (flexible)
    const { data: leads } = await this.supabase.client
      .from('leads')
      .select('*')
      .like('phone', '%' + digits)
      .order('survey_step', { ascending: false });
    
    // Priorizar lead con encuesta activa o con nombre
    const existingLead = leads && leads.length > 0 
      ? leads.find((l: any) => l.survey_step > 0) || leads.find((l: any) => l.name) || leads[0] 
      : null;

    if (existingLead) {
      console.log('ğŸ“‹ Lead existente:', existingLead.id);
      return existingLead;
    }

    const vendedor = await this.getVendedorMenosCarga();
    
    const newLead = {
      phone: normalizedPhone,
      conversation_history: [],
      score: 0,
      status: 'new',
      assigned_to: vendedor?.id,
      needs_mortgage: null,
      mortgage_data: {},
      lead_score: 0,
      lead_category: 'cold'
    };

    console.log('ğŸ“ Creando lead...');
    const { data, error } = await this.supabase.client
      .from('leads')
      .insert([newLead])
      .select()
      .single();

    if (error) {
      console.error('âŒ Error creando lead:', error);
      return newLead;
    }

    console.log('âœ… Lead creado:', data.id);
    return data;
  }

  private async getVendedorMenosCarga(): Promise<any> {
    const { data: vendedores } = await this.supabase.client
      .from('team_members')
      .select('*')
      .eq('role', 'vendedor')
      .eq('active', true);

    if (!vendedores?.length) return null;

    const conCarga = await Promise.all(vendedores.map(async (v) => {
      const { count } = await this.supabase.client
        .from('leads')
        .select('*', { count: 'exact', head: true })
        .eq('assigned_to', v.id)
        .in('status', ['new', 'contacted', 'scheduled']);
      return { ...v, carga: count || 0 };
    }));

    conCarga.sort((a, b) => a.carga - b.carga);
    return conCarga[0];
  }

  private async getAllProperties(): Promise<any[]> {
    const { data, error } = await this.supabase.client
      .from('properties')
      .select('*');
    
    if (error) {
      console.error('âŒ Error cargando properties:', error);
      return [];
    }
    
    console.log(`ğŸ“¦ Properties cargadas: ${data?.length || 0}`);
    return data || [];
  }

  private async getAllTeamMembers(): Promise<any[]> {
    const { data } = await this.supabase.client
      .from('team_members')
      .select('*')
      .eq('active', true);
    return data || [];
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ANÃLISIS CON IA - EL CEREBRO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async analyzeWithAI(message: string, lead: any, properties: any[]): Promise<AIAnalysis> {
    
    // Formatear historial para OpenAI
    const historialParaOpenAI = (lead?.conversation_history || [])
      .slice(-8)
      .map((m: any) => ({ role: m.role, content: m.content }))
      .filter((m: any) => m.content);

    // Verificar si ya existe cita confirmada para este lead
    let citaExistenteInfo = '';
    try {
      const { data: citaExistente } = await this.supabase.client
        .from('appointments')
        .select('scheduled_date, scheduled_time, property_name')
        .eq('lead_id', lead.id)
        .eq('status', 'scheduled')
        .order('created_at', { ascending: false })
        .limit(1);
      
      if (citaExistente && citaExistente.length > 0) {
        const cita = citaExistente[0];
        citaExistenteInfo = `âœ… YA TIENE CITA CONFIRMADA: ${cita.scheduled_date} a las ${cita.scheduled_time} en ${cita.property_name}`;
        console.log('ğŸš« CITA EXISTENTE DETECTADA:', citaExistenteInfo);
      } else {
        console.log('ğŸ“… No hay cita existente para este lead');
      }
    } catch (e) {
      console.log('âš ï¸ Error verificando cita existente para prompt:', e);
    }

    // Crear catÃ¡logo desde DB
    const catalogoDB = this.crearCatalogoDB(properties);
    console.log('ğŸ“‹ CatÃ¡logo generado:', catalogoDB.substring(0, 500) + '...');

    const prompt = `
âš ï¸ INSTRUCCIÃ“N CRÃTICA: Debes responder ÃšNICAMENTE con un objeto JSON vÃ¡lido.
NO escribas texto antes ni despuÃ©s del JSON. Tu respuesta debe empezar con { y terminar con }.

Eres SARA, una **agente inmobiliaria HUMANA y conversacional** de Grupo Santa Rita en Zacatecas, MÃ©xico.

Tu objetivo:
- Ayudar a la persona a encontrar la mejor casa segÃºn su vida real.
- Hablar como asesora profesional mexicana, NO como robot ni formulario.
- Generar confianza, emociÃ³n y claridad.
- Vender sin presiÃ³n, pero con seguridad y entusiasmo.

Respondes SIEMPRE en espaÃ±ol neutro mexicano, con tono cÃ¡lido, cercano y profesional.
Usa emojis con moderaciÃ³n: mÃ¡ximo 1â€“2 por mensaje, solo donde sumen emociÃ³n.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESTILO DE RESPUESTA Y FORMATO VISUAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- 2 a 5 frases por mensaje, no una lÃ­nea seca.
- Frases cortas, naturales, como chat de WhatsApp.
- Siempre mezcla EMOCIÃ“N + INFORMACIÃ“N concreta.
- Cierra casi siempre con una PREGUNTA que haga avanzar la conversaciÃ³n.

âš ï¸ FORMATO VISUAL OBLIGATORIO:
Cuando listes opciones, desarrollos o informaciÃ³n estructurada, USA:
- Saltos de lÃ­nea entre secciones (\\n\\n)
- ViÃ±etas con â€¢ para listas
- Negritas con *texto* para nombres de desarrollos y modelos
- SeparaciÃ³n clara entre cada opciÃ³n

Ejemplo CORRECTO (fÃ¡cil de leer):
"Â¡Claro [nombre]! ğŸ˜Š Te resumo nuestros desarrollos:

â€¢ *Monte Verde*: 2-3 recÃ¡maras, ambiente familiar, desde $1.3M

â€¢ *Los Encinos*: 3 recÃ¡maras, 3 plantas, ideal familias grandes

â€¢ *Distrito Falco*: Premium, acabados de lujo, 1 planta

Â¿CuÃ¡l te llama mÃ¡s la atenciÃ³n?"

Ejemplo INCORRECTO (difÃ­cil de leer):
"Tenemos Monte Verde con 2-3 recÃ¡maras y ambiente familiar desde 1.3M, tambiÃ©n Los Encinos con 3 recÃ¡maras y 3 plantas ideal para familias grandes, y Distrito Falco que es premium con acabados de lujo en 1 planta. Â¿CuÃ¡l te interesa?"

Prohibido:
- Respuestas genÃ©ricas tipo "tenemos varias opciones que se adaptan a ti".
- Relleno vacÃ­o tipo "estoy para ayudarte en lo que necesites".
- Sonar como PDF o landing.
- Texto corrido sin estructura cuando hay mÃºltiples opciones.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CATÃLOGO DESDE BASE DE DATOS (USO OBLIGATORIO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tienes este catÃ¡logo de desarrollos y modelos:

${catalogoDB}

REGLAS:
1) Cuando el cliente pida "opciones", "resumen", "quÃ© tienen", "quÃ© manejan", "quÃ© casas tienes", DEBES:
   - Mencionar SIEMPRE mÃ­nimo **2 desarrollos por NOMBRE** del catÃ¡logo.
   - Explicar en 1 frase quÃ© los hace diferentes (zona, nÃºmero de recÃ¡maras, nivel, etc.).
   - Ejemplo de estructura:
     - "En Zacatecas tenemos *Monte Verde* (familias que quieren 2â€“3 recÃ¡maras y amenidades) y *Monte Real* (mÃ¡s exclusivo, con salÃ³n de eventos y gimnasio)."
2) Nunca digas solo "tenemos varios desarrollos" sin nombrarlos.
3) Si ya sabes la zona o presupuesto, prioriza los desarrollos que mejor encajen.
4) Cuando recomiendes modelos, usa el formato:
   - "Dentro de Monte Verde te quedarÃ­an sÃºper bien los modelos Fresno y Olivo: 3 recÃ¡maras, cochera para 2 autos y Ã¡reas verdes para la familia."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FLUJO OBLIGATORIO DE CONVERSACIÃ“N
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PASO 1: SALUDO â†’ CÃ¡lido, emocional y pide nombre (si no lo tienes)
- "Â¡Hola! ğŸ˜Š QuÃ© emociÃ³n que estÃ©s buscando tu nuevo hogar. Soy SARA de Grupo Santa Rita y me encantarÃ­a ayudarte a encontrar ese lugar especial donde vas a crear recuerdos increÃ­bles. Â¿CÃ³mo te llamas?"

PASO 2: DESPUÃ‰S de tener nombre â†’ Conecta emocionalmente
- "Â¡Mucho gusto [nombre]! ğŸ  CuÃ©ntame, Â¿ya tienes algo en mente o apenas estÃ¡s empezando a soÃ±ar con tu nueva casa?"

PASO 3: Entiende necesidades (zona, recÃ¡maras, presupuesto)
- Haz preguntas naturales, una a la vez, mezclando comentarios cÃ¡lidos:
  - "Â¿Te gustarÃ­a vivir en Zacatecas o en Guadalupe?"
  - "Â¿Buscas 2 o 3 recÃ¡maras?"
  - "Â¿MÃ¡s o menos en quÃ© presupuesto te quieres mover?"

PASO 4: Recomienda desarrollo + modelos con frases vendedoras
- Siempre menciona:
  1) Nombre del desarrollo.
  2) 1â€“3 modelos con sus ventajas.
  3) Por quÃ© encajan con lo que dijo la persona.

PASO 5: CUANDO QUIERA VISITAR/CONOCER â†’ Verificar datos antes de agendar
âš ï¸ CRÃTICO: Antes de confirmar una cita DEBES tener:
  1) NOMBRE del cliente
  2) CELULAR del cliente (si no lo tienes, pÃ­delo)
  3) Fecha y hora

Si NO tienes nombre â†’ Pide nombre primero: "Â¡Con gusto! Para agendarte, Â¿me compartes tu nombre?"
Si tienes nombre pero NO celular â†’ Pide celular: "Â¡Perfecto [nombre]! Â¿Me compartes tu nÃºmero de celular para confirmarte la cita?"
Si tienes nombre Y celular â†’ Pregunta fecha/hora: "Â¡Listo [nombre]! Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?"

âš ï¸ NUNCA confirmes una cita sin tener nombre y celular.

PASO 6: AL CONFIRMAR CITA â†’ SIEMPRE pregunta por crÃ©dito
âš ï¸ OBLIGATORIO: Cuando confirmes la cita, SIEMPRE termina con:
"Por cierto, Â¿ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?"

Ejemplo de confirmaciÃ³n completa:
"Â¡Listo [nombre]! Te agendo para [fecha] a las [hora] en *[desarrollo]*. Te esperamos con mucho gusto. ğŸ˜Š

Por cierto, Â¿ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INTERPRETACIÃ“N DE CRÃ‰DITO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CRÃTICO - "NO NECESITO CRÃ‰DITO":
- Si dice "no necesito crÃ©dito", "no ocupo crÃ©dito", "tengo recursos", "pago de contado" â†’ TIENE RECURSOS PROPIOS
- NO le ofrezcas corrida financiera
- NO le preguntes cuÃ¡nto gana
- Si NO tiene cita: "Â¡Perfecto! Entonces, Â¿quÃ© dÃ­a y hora te gustarÃ­a visitar?"
- Si YA tiene cita: "Â¡Perfecto! Te esperamos en tu cita. Â¿Necesitas algo mÃ¡s?"

âš ï¸ CRÃTICO - "SÃ NECESITO CRÃ‰DITO":
- Si dice "sÃ­ necesito", "necesito apoyo", "quisiera que me ayudaran" â†’ NECESITA CRÃ‰DITO
- Ofrece corrida financiera y pregunta ingreso

âš ï¸ CRÃTICO - DESPUÃ‰S DE CORRIDA FINANCIERA:
- Si YA tiene cita agendada â†’ NO digas "Â¿te gustarÃ­a visitar las casas?"
- En su lugar PREGUNTA: "Â¿Te gustarÃ­a que te conectemos con uno de nuestros asesores VIP para ayudarte con el crÃ©dito?"
- âš ï¸ NO ACTIVES send_contactos: true todavÃ­a. Espera a que el cliente responda "sÃ­".
- Solo cuando el cliente responda "sÃ­", "claro", "dale", etc. ENTONCES activas send_contactos: true

âš ï¸ CRÃTICO - "YA AGENDÃ‰" / "YA TENGO CITA":
- Si el cliente dice "ya agendÃ©", "ya tengo cita", "ya quedamos" â†’ NO crees otra cita
- Confirma su cita existente y pregunta si necesita algo mÃ¡s
- Ejemplo: "Â¡Perfecto [nombre]! Ya tienes tu cita confirmada. Â¿Te gustarÃ­a que te conectemos con un asesor para el crÃ©dito?"
- âš ï¸ NO actives send_contactos hasta que confirme

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RESPUESTAS CORTAS ("SÃ", "OK", "DALE")
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CRÃTICO: Si el mensaje anterior de SARA preguntÃ³ sobre visita/conocer y el cliente responde:
- "sÃ­", "si", "ok", "dale", "claro", "por favor", "me interesa", "quiero"

Entonces el cliente QUIERE VISITAR. Tu respuesta debe ser:
- Si NO tienes nombre: "Â¡Perfecto! ğŸ˜Š Para agendarte, Â¿me compartes tu nombre?"
- Si tienes nombre pero NO celular: "Â¡Perfecto [nombre]! Â¿Me compartes tu celular para confirmarte?"
- Si tienes nombre Y celular: "Â¡Perfecto [nombre]! Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?"

El intent debe ser "solicitar_cita", NO "interes_desarrollo".

âš ï¸ CRÃTICO: Si el mensaje anterior de SARA preguntÃ³ sobre ASESOR/CRÃ‰DITO y el cliente responde:
- "sÃ­", "si", "ok", "dale", "claro", "por favor", "quiero asesor", "ayÃºdame con el crÃ©dito"

Entonces el cliente QUIERE ASESOR. Tu respuesta debe ser:
- "Â¡Perfecto [nombre]! Te voy a conectar con uno de nuestros asesores VIP."
- âš ï¸ AHORA SÃ activa send_contactos: true

âš ï¸ NO respondas con frases genÃ©ricas como:
- "Si tienes alguna pregunta..."
- "Estoy aquÃ­ para ayudarte..."
- "HÃ¡zmelo saber..."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESCENARIOS ESPECIALES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CUANDO DIGA "APENAS EMPIEZO", "QUÃ‰ TIENEN", "QUÃ‰ OPCIONES HAY", "DAME UN RESUMEN":
Esto significa que quiere conocer TODO. DEBES listar TODOS los desarrollos (los 6), no solo 2-3.

Formato OBLIGATORIO:
"Â¡Claro [nombre]! ğŸ˜Š Te presento todos nuestros desarrollos:

**EN ZACATECAS:**

ğŸŸ¢ *Monte Verde* - Colinas del Padre
Desde $1.3M | 2-3 recÃ¡maras
_El refugio familiar donde la modernidad se mezcla con la naturaleza: fraccionamiento seguro, ambiente tranquilo y una vida mÃ¡s lenta, pero mejor pensada._

ğŸŸ¡ *Monte Real* - Zona exclusiva
Desde $1.8M | 2-3 recÃ¡maras
_El siguiente nivel de Monte Verde: las mismas Ã¡reas verdes, pero con salÃ³n de eventos, gimnasio y alberca para los que quieren ese plus de exclusividad._

ğŸŸ¢ *Los Encinos* - Zona residencial  
Desde $2.2M | 3 recÃ¡maras
_El fraccionamiento donde tus hijos crecen entre Ã¡reas verdes y juegos, mientras tÃº inviertes en una zona tranquila que vale mÃ¡s maÃ±ana._

ğŸŸ¢ *Miravalle* - Premium
Desde $2.8M | 3-4 recÃ¡maras
_Tu oasis en la ciudad: rodeado de cerros y calma, con el silencio suficiente para escuchar a tu familia y todo a unos minutos._

**EN GUADALUPE:**

ğŸŸ£ *Andes* - Excelente ubicaciÃ³n
Desde $1.5M | 2-3 recÃ¡maras
_La privada de la generaciÃ³n que quiere todo: seguridad, ubicaciÃ³n estratÃ©gica y un entorno joven donde la vida pasa entre gym, niÃ±os en bici y vecinos que piensan como tÃº._

ğŸ”µ *Distrito Falco* - El mÃ¡s exclusivo
Desde $3.5M | 3-4 recÃ¡maras
_La direcciÃ³n que suena a logro: un desarrollo exclusivo y sobrio, para quienes ya no compran casa, compran nivel de vida e inversiÃ³n inteligente._

Â¿Hay alguno que te llame la atenciÃ³n o quieres que te detalle alguno en particular?"

CUANDO PIDA INFO DE UN DESARROLLO ESPECÃFICO (ej. "cuÃ©ntame de Los Encinos"):
- Lista TODOS los modelos de ese desarrollo con precios y caracterÃ­sticas
- Usa formato visual con viÃ±etas y saltos de lÃ­nea
- Ejemplo:
  "Â¡Excelente elecciÃ³n! ğŸ˜Š En *Los Encinos* tenemos:

  â€¢ *Ascendente*: $3.2M | 3 rec | 210mÂ² | 3 plantas con terraza
  
  â€¢ *Descendente*: $2.9M | 3 rec | 182mÂ² | 3 plantas, vistas increÃ­bles
  
  â€¢ *Encino Blanco*: $2.2M | 3 rec | 125mÂ² | 2 plantas, privada
  
  Â¿Te gustarÃ­a ver el video o agendar una visita?"

CUANDO PIDA "UBICACIÃ“N", "MAPA", "DÃ“NDE ESTÃ":
- Da una explicaciÃ³n corta de la zona.
- Marca send_gps: true en el JSON.

CUANDO PIDA "VIDEO", "RECORRIDO", "VER LA CASA":
- Habla del desarrollo y activa send_video_desarrollo: true.

CUANDO QUIERA "HABLAR CON ASESOR":
- ExplÃ­cale que con gusto un asesor humano lo va a contactar.
- Activa send_contactos: true.

âš ï¸ CUANDO EL CLIENTE MENCIONE UN PRESUPUESTO CLARO (ej. "3 millones", "2.5M", "hasta 1.8", "tengo X"):
Es OBLIGATORIO que:
1) Menciones mÃ­nimo 2 desarrollos por NOMBRE que entren en ese rango (segÃºn el catÃ¡logo).
2) Expliques en 1 frase por quÃ© encajan con ese presupuesto.
3) Cierres con una pregunta para avanzar (zona, recÃ¡maras o cita).

Ejemplo:
Cliente: "Tengo un presupuesto de 3 millones, dame opciones"
Respuesta en "response":
"Con 3 millones estÃ¡s en una muy buena posiciÃ³n, [nombre] ğŸ˜Š
En Zacatecas te puedo recomendar *Los Encinos*, donde modelos como Ascendente te dan 3 recÃ¡maras, cochera para 2 autos y un entorno muy familiar.
TambiÃ©n estÃ¡ *Miravalle*, mÃ¡s premium, con casas de 3 niveles y terraza para reuniones.
Si prefieres Guadalupe, *Andes* es excelente por ubicaciÃ³n y relaciÃ³n precioâ€“beneficio.
Â¿Te gustarÃ­a que te detalle primero Zacatecas o Guadalupe?"

âŒ PROHIBIDO responder con frases genÃ©ricas como:
- "Tenemos desarrollos en diferentes zonas y presupuestos"
- "Â¿En quÃ© zona te gustarÃ­a vivir?"
- "CuÃ©ntame mÃ¡s, Â¿quÃ© tipo de casa buscas?"
Estas frases son INACEPTABLES cuando el cliente YA dio su presupuesto.

âš ï¸ CUANDO EL CLIENTE DICE QUE NO TIENE CRÃ‰DITO O PREGUNTA POR FINANCIAMIENTO:
NO te quedes en loop preguntando "Â¿te gustarÃ­a que te ayude?". 
Sigue este flujo concreto:

PASO 1: Ofrece hacer una CORRIDA FINANCIERA
"Â¡No te preocupes, [nombre]! ğŸ˜Š Te puedo hacer una *corrida financiera ilustrativa* para que veas:

â€¢ CuÃ¡nto te puede prestar un banco aproximadamente
â€¢ CÃ³mo quedarÃ­an tus mensualidades
â€¢ El enganche que necesitarÃ­as

Para eso solo necesito saber: *Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?*"

PASO 2: Cuando diga su ingreso, CALCULA con estas fÃ³rmulas:
- CrÃ©dito MÃNIMO = ingreso mensual Ã— 60
- CrÃ©dito MÃXIMO = ingreso mensual Ã— 80
- Mensualidad = 30% del ingreso mensual

Ejemplo si gana $30,000:
- CrÃ©dito: $1,800,000 - $2,400,000
- Mensualidad: ~$9,000

Responde asÃ­:
"Â¡Perfecto [nombre]! Con un ingreso de $[X] al mes, *aproximadamente* podrÃ­as acceder a:

â€¢ *CrÃ©dito estimado*: $[mÃ­nimo] - $[mÃ¡ximo]
â€¢ *Mensualidad aproximada*: ~$[30% del ingreso]
â€¢ *Enganche sugerido*: 10-20% del valor

âš ï¸ *Nota: Estos nÃºmeros son ilustrativos. El monto final depende del banco y tu historial.*

Con esto podrÃ­as ver casas en [desarrollos que encajen]. Â¿Te gustarÃ­a agendar una visita para conocerlas?"

PASO 3: SIEMPRE regresa a ofrecer CITA despuÃ©s de dar info de crÃ©dito
No te quedes dando vueltas con el crÃ©dito. DespuÃ©s de 2-3 intercambios sobre crÃ©dito, ofrece:
"Mientras avanzas con el crÃ©dito, Â¿te gustarÃ­a visitar las casas para ir viendo cuÃ¡l te enamora?"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TU PERSONALIDAD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- CÃ¡lida, empÃ¡tica, clara.
- Frases naturales: "Perfecto", "SÃºper bien", "Te va a encantar", "Excelente elecciÃ³n".
- NUNCA dices que eres IA o bot.
- Eres SARA, asesora inmobiliaria de Grupo Santa Rita.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATOS DEL CLIENTE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Nombre: ${lead.name || 'âŒ NO TENGO - DEBES PEDIRLO'}
- Celular: ${lead.phone ? 'âœ… SÃ­ tengo' : 'âŒ NO TENGO - DEBES PEDIRLO'}
- InterÃ©s: ${lead.property_interest || 'No definido'}
- CrÃ©dito: ${lead.needs_mortgage === null ? 'âŒ NO SÃ‰ - PREGUNTAR DESPUÃ‰S DE CITA' : lead.needs_mortgage ? 'SÃ­ necesita' : 'Tiene recursos propios'}
- Score: ${lead.lead_score || 0}/100
${citaExistenteInfo ? `- Cita: ${citaExistenteInfo}` : '- Cita: âŒ NO TIENE CITA AÃšN'}

${!lead.name ? 'âš ï¸ CRÃTICO: NO TENGO NOMBRE. Pide el nombre antes de agendar cita.' : ''}
${citaExistenteInfo ? `
ğŸš«ğŸš«ğŸš« PROHIBIDO - LEE ESTO ğŸš«ğŸš«ğŸš«
EL CLIENTE YA TIENE CITA CONFIRMADA.
- NUNCA digas "Â¿te gustarÃ­a visitar las casas?"
- NUNCA digas "Â¿quÃ© dÃ­a te gustarÃ­a visitarnos?"
- NUNCA crees otra cita
- Si habla de crÃ©dito â†’ ofrece ASESOR VIP, no visita
- Si dice "ya agendÃ©" â†’ confirma su cita existente
- Respuesta correcta: "Â¿Te gustarÃ­a que te conectemos con uno de nuestros asesores VIP para ayudarte con el crÃ©dito?"
ğŸš«ğŸš«ğŸš« FIN PROHIBICIÃ“N ğŸš«ğŸš«ğŸš«
` : ''}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REGLAS DE CITA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ Para CONFIRMAR una cita necesitas EN ESTE ORDEN:
1) Nombre âœ“ â†’ Si no tienes, pÃ­delo: "Â¿Me compartes tu nombre?"
2) Celular âœ“ â†’ Si no tienes, pÃ­delo: "Â¡Perfecto [nombre]! Â¿Me compartes tu nÃºmero de celular?"
3) Fecha y hora âœ“ â†’ Solo despuÃ©s de tener nombre Y celular

âš ï¸ SECUENCIA OBLIGATORIA:
- Cliente dice "sÃ­ quiero visitar" â†’ Pide NOMBRE primero
- Cliente da nombre â†’ Pide CELULAR
- Cliente da celular â†’ Pide FECHA/HORA
- Cliente da fecha/hora â†’ Confirma cita + pregunta crÃ©dito

ğŸš«ğŸš«ğŸš« PROHIBIDO - DATOS YA PROPORCIONADOS ğŸš«ğŸš«ğŸš«
Si en el historial o en DATOS_LEAD ya aparece:
- Nombre del cliente â†’ NUNCA preguntes "Â¿me compartes tu nombre?"
- NÃºmero de celular â†’ NUNCA preguntes "Â¿me compartes tu celular?"
- Cita confirmada â†’ NUNCA preguntes "Â¿te gustarÃ­a visitar?"

Si el cliente dice "ya te lo di" o similar:
- Busca el dato en el historial
- Ãšsalo y continÃºa el flujo
- NUNCA vuelvas a pedirlo
ğŸš«ğŸš«ğŸš« FIN PROHIBICIÃ“N ğŸš«ğŸš«ğŸš«

âš ï¸ Si en DATOS_LEAD dice "YA TIENE CITA CONFIRMADA":
- NO preguntes si quiere agendar otra visita
- NO digas "Â¿te gustarÃ­a visitar las casas?"
- NO digas "Â¿te gustarÃ­a conocer en persona?"
- Confirma que ya tiene cita y pregunta si necesita algo mÃ¡s
- Si pregunta algo de crÃ©dito, responde sobre crÃ©dito SIN ofrecer visita

âš ï¸ Si pide hablar con asesor hipotecario:
- Confirma que lo vas a conectar
- Pon send_contactos: true en el JSON

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EXTRACCIÃ“N OBLIGATORIA DE NOMBRE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Siempre que el cliente diga frases como:
- "soy X"
- "me llamo X"  
- "mi nombre es X"
DEBES OBLIGATORIAMENTE:
1) Usar ese nombre en tu respuesta.
2) Ponerlo en extracted_data.nombre EN EL JSON.

Ejemplo:
Cliente: "soy el karate kid"
JSON: { "extracted_data": { "nombre": "el karate kid" }, ... }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INTENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- "saludo": primer contacto (hola, buen dÃ­a) â†’ PIDE NOMBRE
- "interes_desarrollo": pide info, opciones, resumen de casas o desarrollos
- "solicitar_cita": quiere visitar SIN fecha/hora especÃ­fica
- "confirmar_cita": da fecha Y hora especÃ­fica
- "info_credito": responde sobre su situaciÃ³n de crÃ©dito/ingresos
- "otro": dudas generales

Flags:
- "send_video_desarrollo": true si pide video, recorrido, tour.
- "send_gps": true si pide ubicaciÃ³n, mapa, cÃ³mo llegar.
- "send_contactos": true SOLO cuando:
  * El cliente dice EXPLÃCITAMENTE "sÃ­ quiero asesor", "conÃ©ctame", "sÃ­", "dale" EN RESPUESTA a tu pregunta sobre asesor
  * âš ï¸ NO lo actives cuando TÃš ofreces asesor por primera vez
  * âš ï¸ NO lo actives junto con corrida financiera
  * âš ï¸ ESPERA a que el cliente confirme

âš ï¸âš ï¸âš ï¸ REGLA CRÃTICA PARA send_contactos âš ï¸âš ï¸âš ï¸
Si el ÃšLTIMO mensaje de SARA en el historial contiene:
- "ASESOR VIP DISPONIBLE"
- "te conectemos con uno"
- "asesor hipotecario"

Y el cliente responde: "sÃ­", "si", "claro", "dale", "ok", "por favor", "quiero"

ENTONCES:
1) send_contactos: true (OBLIGATORIO)
2) response: "Â¡Perfecto! Te voy a conectar con uno de nuestros asesores VIP..."
3) intent: "info_credito"

âš ï¸ NO confundas con solicitar_cita. Si preguntamos sobre ASESOR y dice "sÃ­", es para ASESOR, no para cita.
âš ï¸âš ï¸âš ï¸ FIN REGLA CRÃTICA âš ï¸âš ï¸âš ï¸

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FORMATO JSON OBLIGATORIO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Responde SIEMPRE solo con **JSON vÃ¡lido**, sin texto antes ni despuÃ©s.

{
  "intent": "saludo|interes_desarrollo|solicitar_cita|confirmar_cita|info_credito|otro",
  "extracted_data": {
    "nombre": null,
    "desarrollo": null,
    "desarrollos": [],
    "modelos": [],
    "fecha": null,
    "hora": null,
    "necesita_credito": null,
    "num_recamaras": null,
    "banco_preferido": null,
    "ingreso_mensual": null,
    "enganche_disponible": null,
    "modalidad_contacto": null,
    "quiere_asesor": null
  },
  "response": "Tu respuesta conversacional para WhatsApp",
  "send_video_desarrollo": false,
  "send_gps": false,
  "send_contactos": false
}

âš ï¸ EXTRACCIÃ“N DE MÃšLTIPLES DESARROLLOS Y MODELOS:
- Si el cliente menciona varios desarrollos (ej. "Los Encinos y Andes"), ponlos en "desarrollos": ["Los Encinos", "Andes"]
- Si menciona casas/modelos especÃ­ficos (ej. "el Ascendente y el Gardenia"), ponlos en "modelos": ["Ascendente", "Gardenia"]
- "desarrollo" es para un solo desarrollo, "desarrollos" es para mÃºltiples

âš ï¸ EXTRACCIÃ“N DE FECHAS Y HORAS:
La fecha de hoy es: ${new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}

- Si dice "hoy" â†’ fecha: "hoy"
- Si dice "maÃ±ana" â†’ fecha: "maÃ±ana"  
- Si dice "el lunes", "el martes", etc â†’ fecha: "lunes", "martes", etc
- Si dice "a las 4", "4pm", "16:00" â†’ hora: "16:00"
- Si dice "a las 2", "2pm", "14:00" â†’ hora: "14:00"
- Si dice "en la maÃ±ana" â†’ hora: "10:00"
- Si dice "en la tarde" â†’ hora: "16:00"

âš ï¸ EXTRACCIÃ“N DE DATOS DE CRÃ‰DITO (MUY IMPORTANTE):
- Si menciona banco (aunque tenga typos): "soctia", "escotia", "scotibank" â†’ banco_preferido: "Scotiabank"
- "bvba", "vbba" â†’ "BBVA" | "santaner", "santnader" â†’ "Santander" | "vanorte", "baorte" â†’ "Banorte"
- "infonavi", "imfonavit" â†’ "Infonavit" | "fovisste", "fobissste" â†’ "Fovissste"
- Si menciona ingreso: "67 mil", "67000", "sesenta y siete mil" â†’ ingreso_mensual: 67000
- Si menciona enganche: "234m1l", "234 mil", "doscientos" â†’ enganche_disponible: 234000
- Si dice "sÃ­" a asesor: "si", "va", "sale", "ok", "claro" â†’ quiere_asesor: true
- Si elige modalidad: "1", "llamada", "telefono" â†’ modalidad_contacto: "telefonica"
- "2", "zoom", "video" â†’ modalidad_contacto: "videollamada"
- "3", "oficina", "presencial" â†’ modalidad_contacto: "presencial"

RECUERDA: 
- Tu respuesta debe ser SOLO JSON vÃ¡lido
- Empieza con { y termina con }
- NO escribas texto antes del { ni despuÃ©s del }
- Pon tu mensaje conversacional DENTRO del campo "response"
`;

    // Variable para guardar respuesta raw de OpenAI (accesible en catch)
    let openaiRawResponse = '';

    try {
      // Firma correcta: chat(history, userMsg, systemPrompt)
      const response = await this.openai.chat(
        historialParaOpenAI,
        message,
        prompt
      );

      openaiRawResponse = response || ''; // Guardar para usar en catch si falla JSON
      console.log('ğŸ¤– OpenAI response:', response?.substring(0, 300));
      
      // Extraer JSON
      let jsonStr = response;
      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        jsonStr = jsonMatch[0];
      }
      
      const parsed = JSON.parse(jsonStr);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CINTURÃ“N DE SEGURIDAD: Forzar extracciÃ³n de nombre si la IA no lo puso
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!parsed.extracted_data) {
        parsed.extracted_data = {};
      }

      if (!parsed.extracted_data.nombre) {
        const nameMatch = message.match(/(?:soy|me llamo|mi nombre es)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±0-9\s]+)/i);
        if (nameMatch) {
          parsed.extracted_data.nombre = nameMatch[1].trim();
          console.log('ğŸ‘¤ Nombre detectado por regex:', parsed.extracted_data.nombre);
        }
      }
      
      // CORRECCIÃ“N: Si tiene fecha Y hora, forzar confirmar_cita
      if (parsed.extracted_data?.fecha && parsed.extracted_data?.hora) {
        parsed.intent = 'confirmar_cita';
      }
      
      return {
        intent: parsed.intent || 'otro',
        extracted_data: parsed.extracted_data || {},
        response: parsed.response || 'Â¡Hola! Â¿En quÃ© puedo ayudarte?',
        send_gps: parsed.send_gps || false,
        send_video_desarrollo: parsed.send_video_desarrollo || false,
        send_contactos: parsed.send_contactos || false
      };
      
    } catch (e) {
      console.error('âŒ Error OpenAI:', e);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FALLBACK INTELIGENTE: Si OpenAI respondiÃ³ texto plano, Â¡usarlo!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Limpiar la respuesta de OpenAI (quitar markdown, etc)
      let respuestaLimpia = openaiRawResponse
        .replace(/```json/gi, '')
        .replace(/```/g, '')
        .replace(/^\s*\{[\s\S]*\}\s*$/g, '') // Quitar JSON malformado
        .trim();
      
      // Si OpenAI dio una respuesta de texto Ãºtil (mÃ¡s de 20 chars, no es JSON roto)
      if (respuestaLimpia.length > 20 && !respuestaLimpia.startsWith('{')) {
        console.log('ğŸ”„ Usando respuesta de texto plano de OpenAI');
        
        // Detectar intent basado en el mensaje del usuario
        const msgLower = message.toLowerCase();
        let fallbackIntent = 'otro';
        if (msgLower.includes('opcion') || msgLower.includes('casa') || msgLower.includes('tienen') || msgLower.includes('millon')) {
          fallbackIntent = 'interes_desarrollo';
        } else if (msgLower.includes('cita') || msgLower.includes('visita')) {
          fallbackIntent = 'solicitar_cita';
        }
        
        return {
          intent: fallbackIntent,
          extracted_data: {},
          response: respuestaLimpia,
          send_gps: false,
          send_video_desarrollo: false,
          send_contactos: false
        };
      }
      
      // Si no hay respuesta Ãºtil de OpenAI, usar fallback contextual
      const msgLower = message.toLowerCase();
      const leadTieneNombre = lead.name;
      let fallbackResponse = '';
      let fallbackIntent = 'saludo';
      
      // Si YA tenemos nombre, no pedirlo de nuevo
      if (leadTieneNombre) {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PRIORIDAD 1: Si menciona presupuesto, DAR OPCIONES CONCRETAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (msgLower.includes('millon') || msgLower.includes('millÃ³n') || msgLower.match(/\d+\s*m\b/i)) {
          // Detectar rango de presupuesto
          const numMatch = msgLower.match(/(\d+(?:\.\d+)?)\s*(?:millon|millÃ³n|m\b)/i);
          const presupuesto = numMatch ? parseFloat(numMatch[1]) : 0;
          
          if (presupuesto >= 3) {
            fallbackResponse = `${lead.name}, con ${presupuesto}M estÃ¡s en excelente posiciÃ³n ğŸ˜Š

En Zacatecas te recomiendo *Los Encinos* (modelo Ascendente: 3 rec, 210mÂ², terraza) o *Miravalle* (Bilbao/Vizcaya: 3 niveles, roof garden).

En Guadalupe, *Distrito Falco* tiene modelos premium como HalcÃ³n con 4 rec y acabados de lujo.

Â¿Te gustarÃ­a que te detalle primero Zacatecas o Guadalupe?`;
          } else if (presupuesto >= 2) {
            fallbackResponse = `${lead.name}, con ${presupuesto}M tienes muy buenas opciones ğŸ˜Š

En Zacatecas: *Monte Verde* (Fresno/Olivo: 3 rec, Ã¡reas verdes) o *Los Encinos* (Descendente: 3 plantas, terraza).

En Guadalupe: *Andes* es excelente por ubicaciÃ³n y precio, modelos como Aconcagua te dan 3 rec con jardÃ­n.

Â¿CuÃ¡l zona te llama mÃ¡s la atenciÃ³n?`;
          } else {
            fallbackResponse = `${lead.name}, con ${presupuesto}M tenemos opciones accesibles ğŸ˜Š

*Monte Verde* tiene modelos desde $1.3M con 2-3 recÃ¡maras y amenidades familiares.
*Andes* en Guadalupe tambiÃ©n maneja precios competitivos.

Â¿Te gustarÃ­a conocer mÃ¡s de alguno?`;
          }
          fallbackIntent = 'interes_desarrollo';
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PRIORIDAD 2: Pide opciones pero SIN presupuesto
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (msgLower.includes('opcion') || msgLower.includes('casa') || msgLower.includes('tienen') || msgLower.includes('dame')) {
          fallbackResponse = `Â¡Claro ${lead.name}! ğŸ˜Š Te cuento rÃ¡pido:

En *Zacatecas* tenemos Monte Verde (familiar), Los Encinos (espacioso) y Miravalle (premium).
En *Guadalupe* estÃ¡ Andes (excelente ubicaciÃ³n) y Distrito Falco (el mÃ¡s exclusivo).

Para orientarte mejor: Â¿mÃ¡s o menos en quÃ© presupuesto andas?`;
          fallbackIntent = 'interes_desarrollo';
        } else if (msgLower.includes('sÃ­') || msgLower.includes('si') || msgLower.includes('claro')) {
          fallbackResponse = `Â¡Perfecto ${lead.name}! ğŸ˜Š Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?`;
          fallbackIntent = 'solicitar_cita';
        } else if (msgLower.includes('cita') || msgLower.includes('visita')) {
          fallbackResponse = `Â¡Con gusto ${lead.name}! ğŸ  Â¿QuÃ© dÃ­a y hora te funcionan mejor para la visita?`;
          fallbackIntent = 'solicitar_cita';
        } else {
          fallbackResponse = `${lead.name}, para darte las mejores opciones: Â¿en quÃ© zona te gustarÃ­a vivir (Zacatecas o Guadalupe) y mÃ¡s o menos en quÃ© presupuesto andas? ğŸ `;
          fallbackIntent = 'otro';
        }
      } else {
        // Sin nombre - pedirlo de forma cÃ¡lida
        fallbackResponse = 'Â¡Hola! ğŸ˜Š Soy SARA de Grupo Santa Rita. Me encantarÃ­a ayudarte a encontrar tu nuevo hogar. Â¿CÃ³mo te llamas?';
        fallbackIntent = 'saludo';
      }
      
      return {
        intent: fallbackIntent,
        extracted_data: {},
        response: fallbackResponse,
        send_gps: false,
        send_video_desarrollo: false,
        send_contactos: false
      };
    }
  }

  private crearCatalogoDB(properties: any[]): string {
    const porDesarrollo = new Map<string, any[]>();
    
    for (const p of properties) {
      const dev = p.development || 'Otros';
      if (!porDesarrollo.has(dev)) porDesarrollo.set(dev, []);
      porDesarrollo.get(dev)!.push(p);
    }

    let catalogo = '';
    porDesarrollo.forEach((props, dev) => {
      catalogo += `\nDESARROLLO: ${dev}\n`;
      props.forEach(p => {
        const precio = p.price ? `$${(Number(p.price)/1000000).toFixed(1)}M` : '';
        const plantas = p.floors === 1 ? '1 planta' : `${p.floors} plantas`;
        const extras = [];
        if (p.has_study) extras.push('estudio');
        if (p.has_terrace) extras.push('terraza');
        if (p.has_roof_garden) extras.push('roof garden');
        if (p.has_garden) extras.push('jardÃ­n');
        if (p.is_equipped) extras.push('equipada');
        
        catalogo += `â€¢ ${p.name}: ${precio} | ${p.bedrooms} rec | ${p.area_m2}mÂ² | ${plantas}`;
        if (extras.length > 0) catalogo += ` | ${extras.join(', ')}`;
        catalogo += '\n';
        if (p.sales_phrase) {
          catalogo += `  â†’ "${p.sales_phrase}"\n`;
        }
        if (p.ideal_client) {
          catalogo += `  ğŸ‘¤ Ideal: ${p.ideal_client}\n`;
        }
      });
    });
    
    return catalogo;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EJECUTAR DECISIÃ“N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async executeAIDecision(
    analysis: AIAnalysis,
    from: string,
    cleanPhone: string,
    lead: any,
    properties: any[],
    teamMembers: any[],
    originalMessage: string
  ): Promise<void> {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RE-FETCH: Obtener historial FRESCO para evitar race conditions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let historialFresco: any[] = [];
    try {
      const { data: leadFresco } = await this.supabase.client
        .from('leads')
        .select('conversation_history')
        .eq('id', lead.id)
        .single();
      historialFresco = leadFresco?.conversation_history || [];
      console.log('ğŸ”„ Historial re-fetched, mensajes:', historialFresco.length);
    } catch (e) {
      console.log('âš ï¸ Error re-fetching historial, usando cache');
      historialFresco = lead.conversation_history || [];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECCIÃ“N FORZADA: Flujo de ASESOR VIP con BANCOS y MODALIDADES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const historial = historialFresco;
    const mensajesSara = historial.filter((m: any) => m.role === 'assistant');
    const ultimoMsgSara = mensajesSara.length > 0 ? mensajesSara[mensajesSara.length - 1] : null;
    
    // DEBUG: Ver quÃ© hay en el historial
    console.log('ğŸ” DEBUG - Mensajes de SARA en historial:', mensajesSara.length);
    console.log('ğŸ” DEBUG - Ãšltimo mensaje SARA:', ultimoMsgSara?.content?.substring(0, 100) || 'NINGUNO');
    console.log('ğŸ” DEBUG - Mensaje original cliente:', originalMessage);
    
    // Lista de bancos disponibles
    const bancosDisponibles = [
      { nombre: 'Scotiabank', codigos: ['scotiabank', 'scotia'] },
      { nombre: 'BBVA', codigos: ['bbva'] },
      { nombre: 'Santander', codigos: ['santander'] },
      { nombre: 'Banorte', codigos: ['banorte'] },
      { nombre: 'HSBC', codigos: ['hsbc'] },
      { nombre: 'Banamex', codigos: ['banamex', 'citibanamex', 'citi'] },
      { nombre: 'Banregio', codigos: ['banregio'] },
      { nombre: 'Infonavit', codigos: ['infonavit'] },
      { nombre: 'Fovissste', codigos: ['fovissste'] }
    ];
    
    // Detectar banco mencionado
    const mensajeLower = originalMessage.toLowerCase().trim();
    let bancoDetectado = bancosDisponibles.find(b => 
      b.codigos.some(codigo => mensajeLower.includes(codigo))
    );
    
    // Detectar modalidad
    const modalidades = [
      { nombre: 'TelefÃ³nica', codigos: ['telefon', 'llamada', 'llamar', 'celular', '1'] },
      { nombre: 'Videollamada', codigos: ['zoom', 'videollamada', 'video', 'meet', 'teams', '2'] },
      { nombre: 'Presencial', codigos: ['presencial', 'oficina', 'persona', 'fisico', 'fÃ­sica', '3'] }
    ];
    let modalidadDetectada = modalidades.find(m =>
      m.codigos.some(codigo => mensajeLower.includes(codigo))
    );
    
    // Detectar ingreso en el mensaje
    let ingresoDetectado = 0;
    const matchMil = originalMessage.match(/(\d+)\s*mil/i);
    const matchPesos = originalMessage.match(/\$?\s*([\d,]+)\s*(?:pesos|mensual|al mes)?/i);
    const matchNumero = originalMessage.match(/(?:gano|ingreso|sueldo|cobro)?\s*(\d{2,})/i);
    
    if (matchMil) {
      ingresoDetectado = parseInt(matchMil[1]) * 1000;
    } else if (matchPesos && parseInt(matchPesos[1].replace(/,/g, '')) > 5000) {
      ingresoDetectado = parseInt(matchPesos[1].replace(/,/g, ''));
    } else if (matchNumero && parseInt(matchNumero[1]) >= 10) {
      const num = parseInt(matchNumero[1]);
      ingresoDetectado = num > 1000 ? num : num * 1000;
    }
    
    // Detectar enganche en el mensaje
    let engancheDetectado = 0;
    const matchEngancheMil = originalMessage.match(/(\d+)\s*mil/i);
    const matchEnganchePesos = originalMessage.match(/\$?\s*([\d,]+)/);
    if (matchEngancheMil) {
      engancheDetectado = parseInt(matchEngancheMil[1]) * 1000;
    } else if (matchEnganchePesos && parseInt(matchEnganchePesos[1].replace(/,/g, '')) >= 10000) {
      engancheDetectado = parseInt(matchEnganchePesos[1].replace(/,/g, ''));
    }
    
    // Detectar contextos del Ãºltimo mensaje de SARA
    const preguntabaBanco = ultimoMsgSara?.content?.includes('Scotiabank') &&
                            ultimoMsgSara?.content?.includes('BBVA') &&
                            ultimoMsgSara?.content?.includes('cuÃ¡l');
    
    const preguntabaIngreso = ultimoMsgSara?.content?.includes('cuÃ¡nto ganas') ||
                              ultimoMsgSara?.content?.includes('ingreso mensual') ||
                              ultimoMsgSara?.content?.includes('ganas al mes');
    
    const preguntabaEnganche = ultimoMsgSara?.content?.includes('enganche') &&
                               (ultimoMsgSara?.content?.includes('ahorrado') || 
                                ultimoMsgSara?.content?.includes('tienes algo'));
    
    const preguntabaAsesorVIP = ultimoMsgSara?.content?.toLowerCase()?.includes('asesor vip') ||
                                ultimoMsgSara?.content?.includes('te conecte con') ||
                                ultimoMsgSara?.content?.includes('te gustarÃ­a que te conecte') ||
                                (ultimoMsgSara?.content?.includes('asesor') && ultimoMsgSara?.content?.includes('?'));
    
    const contenidoLower = ultimoMsgSara?.content?.toLowerCase() || '';
    const preguntabaModalidad = (contenidoLower.includes('llamada telef') || contenidoLower.includes('1ï¸âƒ£')) &&
                                (contenidoLower.includes('videollamada') || contenidoLower.includes('2ï¸âƒ£')) &&
                                (contenidoLower.includes('presencial') || contenidoLower.includes('3ï¸âƒ£'));
    
    let respuestaAfirmativa = /^(sÃ­|si|claro|dale|ok|por favor|quiero|va|Ã³rale|orale|porfa|yes|yeah|simÃ³n|simon|arre|sale)$/i.test(originalMessage.trim()) ||
                                /^(sÃ­|si|claro|dale|ok)\s/i.test(originalMessage.trim());
    
    const respuestaNegativa = /^(no|nel|nop|nope|negativo|para nada)$/i.test(originalMessage.trim());
    
    console.log('ğŸ” DEBUG - preguntabaBanco:', preguntabaBanco);
    console.log('ğŸ” DEBUG - preguntabaIngreso:', preguntabaIngreso);
    console.log('ğŸ” DEBUG - preguntabaEnganche:', preguntabaEnganche);
    console.log('ğŸ” DEBUG - preguntabaAsesorVIP:', preguntabaAsesorVIP);
    console.log('ğŸ” DEBUG - preguntabaModalidad:', preguntabaModalidad);
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FALLBACK INTELIGENTE: Si el regex no detectÃ³, usar lo que OpenAI extrajo
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Banco: si regex no detectÃ³ pero OpenAI sÃ­
    if (!bancoDetectado && analysis.extracted_data?.banco_preferido) {
      const bancoAI = analysis.extracted_data.banco_preferido;
      bancoDetectado = bancosDisponibles.find(b => b.nombre.toLowerCase() === bancoAI.toLowerCase()) || { nombre: bancoAI };
      console.log('ğŸ¤– Banco detectado por OpenAI:', bancoAI);
    }
    
    // Ingreso: si regex no detectÃ³ pero OpenAI sÃ­
    if (ingresoDetectado === 0 && analysis.extracted_data?.ingreso_mensual) {
      ingresoDetectado = analysis.extracted_data.ingreso_mensual;
      console.log('ğŸ¤– Ingreso detectado por OpenAI:', ingresoDetectado);
    }
    
    // Enganche: si regex no detectÃ³ pero OpenAI sÃ­
    if (engancheDetectado === 0 && analysis.extracted_data?.enganche_disponible) {
      engancheDetectado = analysis.extracted_data.enganche_disponible;
      console.log('ğŸ¤– Enganche detectado por OpenAI:', engancheDetectado);
    }
    
    // Modalidad: si regex no detectÃ³ pero OpenAI sÃ­
    if (!modalidadDetectada && analysis.extracted_data?.modalidad_contacto) {
      const modAI = analysis.extracted_data.modalidad_contacto.toLowerCase();
      if (modAI.includes('telefon') || modAI === 'telefonica') {
        modalidadDetectada = { nombre: 'TelefÃ³nica', tipo: 'llamada' };
      } else if (modAI.includes('video') || modAI === 'videollamada') {
        modalidadDetectada = { nombre: 'Videollamada', tipo: 'zoom' };
      } else if (modAI.includes('presencial') || modAI === 'oficina') {
        modalidadDetectada = { nombre: 'Presencial', tipo: 'oficina' };
      }
      if (modalidadDetectada) console.log('ğŸ¤– Modalidad detectada por OpenAI:', modalidadDetectada.nombre);
    }
    
    // Quiere asesor: si OpenAI lo detectÃ³
    if (!respuestaAfirmativa && analysis.extracted_data?.quiere_asesor === true) {
      respuestaAfirmativa = true;
      console.log('ğŸ¤– Quiere asesor detectado por OpenAI');
    }
    
    console.log('ğŸ” DEBUG - bancoDetectado:', bancoDetectado?.nombre || 'NINGUNO');
    console.log('ğŸ” DEBUG - ingresoDetectado:', ingresoDetectado);
    console.log('ğŸ” DEBUG - engancheDetectado:', engancheDetectado);
    console.log('ğŸ” DEBUG - modalidadDetectada:', modalidadDetectada?.nombre || 'NINGUNA');
    console.log('ğŸ” DEBUG - respuestaAfirmativa:', respuestaAfirmativa);
    
    const nombreCliente = lead.name || analysis.extracted_data?.nombre || 'amigo';
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 1: Cliente pide crÃ©dito â†’ Preguntar BANCO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Detectar si es solicitud de crÃ©dito: intent de OpenAI O mensaje contiene palabras clave
    const mensajeEsCredito = originalMessage.toLowerCase().includes('crÃ©dito') || 
                             originalMessage.toLowerCase().includes('credito') ||
                             originalMessage.toLowerCase().includes('hipoteca') ||
                             originalMessage.toLowerCase().includes('prÃ©stamo') ||
                             originalMessage.toLowerCase().includes('prestamo') ||
                             originalMessage.toLowerCase().includes('financiamiento');
    
    const pidioCredito = (analysis.intent === 'info_credito' || mensajeEsCredito) && 
                         !lead.banco_preferido && 
                         !preguntabaBanco &&
                         !preguntabaIngreso &&
                         !preguntabaEnganche;
    
    if (pidioCredito && !bancoDetectado) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 1: Preguntando BANCO');
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
      analysis.response = `Â¡Claro ${nombreCliente}! ğŸ˜Š Te ayudo con tu crÃ©dito hipotecario.

Â¿CuÃ¡l banco es de tu preferencia?

ğŸ¦ Scotiabank
ğŸ¦ BBVA
ğŸ¦ Santander
ğŸ¦ Banorte
ğŸ¦ HSBC
ğŸ¦ Banamex
ğŸ¦ Banregio
ğŸ¦ Infonavit
ğŸ¦ Fovissste

Â¿Con cuÃ¡l te gustarÃ­a trabajar?`;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 2: Cliente eligiÃ³ BANCO â†’ Dar info + Preguntar INGRESO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if ((preguntabaBanco || (pidioCredito && bancoDetectado)) && bancoDetectado) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 2: Banco elegido:', bancoDetectado.nombre, 'â†’ Info + Preguntar INGRESO');
      
      // Guardar banco en lead
      try {
        await this.supabase.client
          .from('leads')
          .update({ banco_preferido: bancoDetectado.nombre })
          .eq('id', lead.id);
        lead.banco_preferido = bancoDetectado.nombre;
        console.log('âœ… Banco guardado:', bancoDetectado.nombre);
      } catch (e) {
        console.log('âš ï¸ Error guardando banco');
      }
      
      // Buscar datos del banco
      let datosBanco: any = null;
      try {
        const { data } = await this.supabase.client
          .from('bancos_hipotecarios')
          .select('*')
          .eq('banco', bancoDetectado.nombre)
          .eq('activo', true)
          .single();
        datosBanco = data;
      } catch (e) {
        console.log('âš ï¸ No se encontraron datos del banco');
      }
      
      if (datosBanco) {
        analysis.response = `Â¡Excelente elecciÃ³n! ğŸ¦ *${bancoDetectado.nombre}*

ğŸ“Š *Lo que ofrece ${bancoDetectado.nombre}:*
â€¢ Tasa: ${datosBanco.tasa_min}% - ${datosBanco.tasa_max}% anual
â€¢ Plazo: hasta ${datosBanco.plazo_max_anos} aÃ±os
â€¢ Enganche mÃ­nimo: ${Math.round((datosBanco.enganche_minimo || 0.10) * 100)}%

ğŸ’¡ *Tip:* ${datosBanco.nota_sara || 'Buena opciÃ³n para tu perfil.'}

Para darte una corrida personalizada, Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?`;
      } else {
        analysis.response = `Â¡Excelente elecciÃ³n! ğŸ¦ *${bancoDetectado.nombre}*

Para darte una corrida personalizada, Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 3: Cliente dio INGRESO â†’ Corrida + Preguntar ENGANCHE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaIngreso && ingresoDetectado > 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 3: Ingreso detectado:', ingresoDetectado, 'â†’ Corrida + Preguntar ENGANCHE');
      
      // Obtener banco del lead
      let bancoPreferido = lead.banco_preferido;
      if (!bancoPreferido) {
        try {
          const { data: leadActualizado } = await this.supabase.client
            .from('leads')
            .select('banco_preferido')
            .eq('id', lead.id)
            .single();
          bancoPreferido = leadActualizado?.banco_preferido;
        } catch (e) {}
      }
      
      // Buscar datos del banco
      let datosBanco: any = null;
      if (bancoPreferido) {
        try {
          const { data } = await this.supabase.client
            .from('bancos_hipotecarios')
            .select('*')
            .eq('banco', bancoPreferido)
            .eq('activo', true)
            .single();
          datosBanco = data;
        } catch (e) {}
      }
      
      // Calcular corrida
      const creditoMin = ingresoDetectado * 60;
      const creditoMax = ingresoDetectado * 80;
      const mensualidadAprox = ingresoDetectado * 0.30;
      
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      if (datosBanco) {
        analysis.response = `Â¡Muy bien ${nombreCliente}! Con tu ingreso de ${formatMoney(ingresoDetectado)} en *${bancoPreferido}*:

ğŸ“Š *Tu corrida estimada:*
â€¢ CrÃ©dito: ${formatMoney(creditoMin)} - ${formatMoney(creditoMax)}
â€¢ Mensualidad: ~${formatMoney(mensualidadAprox)}
â€¢ Tasa: ${datosBanco.tasa_min}% - ${datosBanco.tasa_max}% anual
â€¢ Plazo: hasta ${datosBanco.plazo_max_anos} aÃ±os

Â¿Tienes algo ahorrado para el enganche? (aunque sea un aproximado)`;
      } else {
        analysis.response = `Â¡Muy bien ${nombreCliente}! Con tu ingreso de ${formatMoney(ingresoDetectado)}:

ğŸ“Š *Tu corrida estimada:*
â€¢ CrÃ©dito: ${formatMoney(creditoMin)} - ${formatMoney(creditoMax)}
â€¢ Mensualidad: ~${formatMoney(mensualidadAprox)}

Â¿Tienes algo ahorrado para el enganche? (aunque sea un aproximado)`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4: Cliente dio ENGANCHE â†’ CÃ¡lculo final + Preguntar ASESOR VIP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaEnganche && engancheDetectado > 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4: Enganche detectado:', engancheDetectado, 'â†’ CÃ¡lculo final + Preguntar ASESOR');
      
      // Guardar enganche
      try {
        await this.supabase.client
          .from('leads')
          .update({ enganche_disponible: engancheDetectado })
          .eq('id', lead.id);
        console.log('âœ… Enganche guardado:', engancheDetectado);
      } catch (e) {
        console.log('âš ï¸ Error guardando enganche');
      }
      
      // Obtener banco e ingreso del historial
      let bancoPreferido = lead.banco_preferido;
      let ingresoGuardado = 0;
      
      // Buscar ingreso en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('ingreso de')) {
          const match = msg.content.match(/\$\s*([\d,]+)/);
          if (match) {
            ingresoGuardado = parseInt(match[1].replace(/,/g, ''));
            break;
          }
        }
      }
      
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      // Calcular capacidad total
      const creditoMax = ingresoGuardado > 0 ? ingresoGuardado * 80 : 0;
      const capacidadTotal = engancheDetectado + creditoMax;
      
      if (capacidadTotal > 0) {
        analysis.response = `Â¡Excelente ${nombreCliente}! ğŸ’ª

ğŸ“Š *Tu capacidad de compra:*
â€¢ Enganche: ${formatMoney(engancheDetectado)}
â€¢ CrÃ©dito estimado: ${formatMoney(creditoMax)}
â€¢ *Total: ${formatMoney(capacidadTotal)}* para tu casa

âš ï¸ Cifras ilustrativas. El banco define el monto final.

Â¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ${bancoPreferido || 'crÃ©dito'}*?`;
      } else {
        analysis.response = `Â¡Excelente ${nombreCliente}! ğŸ’ª

Con ${formatMoney(engancheDetectado)} de enganche mÃ¡s el crÃ©dito, tienes buenas opciones.

âš ï¸ Cifras ilustrativas. El banco define el monto final.

Â¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ${bancoPreferido || 'crÃ©dito'}*?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4.5: PreguntÃ³ enganche pero no detectÃ³ nÃºmero â†’ Confirmar
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaEnganche && engancheDetectado === 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4.5: No detectÃ³ enganche claro, interpretando...');
      
      // Extraer cualquier nÃºmero del mensaje
      const numerosEnMensaje = originalMessage.match(/\d+/g);
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      if (numerosEnMensaje && numerosEnMensaje.length > 0) {
        // Tomar el nÃºmero mÃ¡s grande encontrado
        let numeroBase = Math.max(...numerosEnMensaje.map((n: string) => parseInt(n)));
        
        // Si el mensaje tiene "mil", "m" o "k", multiplicar por 1000
        const tieneMil = originalMessage.toLowerCase().includes('mil') || 
                         /\d+\s*m(?!i?l)/i.test(originalMessage) ||
                         originalMessage.toLowerCase().includes('k');
        
        const numeroInterpretado = tieneMil || numeroBase < 1000 ? numeroBase * 1000 : numeroBase;
        
        console.log('ğŸ” NÃºmero interpretado:', numeroInterpretado, '(base:', numeroBase, ', tieneMil:', tieneMil, ')');
        
        // Preguntar confirmaciÃ³n
        analysis.response = 'Â¿Quisiste decir ' + formatMoney(numeroInterpretado) + ' de enganche? ğŸ¤”';
        
        // Guardar el nÃºmero interpretado para usarlo si confirma
        try {
          await this.supabase.client
            .from('leads')
            .update({ enganche_pendiente_confirmar: numeroInterpretado })
            .eq('id', lead.id);
        } catch (e) {}
        
      } else {
        // No hay nÃºmeros, pedir de nuevo
        analysis.response = 'No captÃ© bien el monto ğŸ˜… Â¿CuÃ¡nto tienes ahorrado para el enganche? (por ejemplo: 200 mil, 500k, etc.)';
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4.6: Cliente CONFIRMÃ“ enganche â†’ Continuar a PASO 4
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const preguntabaConfirmacionEnganche = ultimoMsgSara?.content?.includes('Quisiste decir') && 
                                            ultimoMsgSara?.content?.includes('enganche');
    
    if (preguntabaConfirmacionEnganche && respuestaAfirmativa) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4.6: Cliente confirmÃ³ enganche â†’ Ejecutando PASO 4');
      
      // Extraer enganche del mensaje anterior de SARA: "Â¿Quisiste decir $234,000 de enganche?"
      let engancheConfirmado = 0;
      const matchEnganche = ultimoMsgSara?.content?.match(/\$([\d,]+)/);
      if (matchEnganche) {
        engancheConfirmado = parseInt(matchEnganche[1].replace(/,/g, ''));
      }
      console.log('âœ… Enganche confirmado (del mensaje):', engancheConfirmado);
      
      if (engancheConfirmado > 0) {
        // Guardar enganche confirmado
        try {
          await this.supabase.client
            .from('leads')
            .update({ enganche_disponible: engancheConfirmado })
            .eq('id', lead.id);
          console.log('âœ… Enganche guardado:', engancheConfirmado);
        } catch (e) {}
        
        // Obtener banco e ingreso del historial
        let bancoPreferido = lead.banco_preferido;
        let ingresoGuardado = 0;
        
        for (const msg of historial) {
          if (msg.role === 'assistant' && msg.content?.includes('ingreso de')) {
            const match = msg.content.match(/\$\s*([\d,]+)/);
            if (match) {
              ingresoGuardado = parseInt(match[1].replace(/,/g, ''));
              break;
            }
          }
        }
        
        const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
        const creditoMax = ingresoGuardado > 0 ? ingresoGuardado * 80 : 0;
        const capacidadTotal = engancheConfirmado + creditoMax;
        
        if (capacidadTotal > 0) {
          analysis.response = 'Â¡Excelente ' + nombreCliente + '! ğŸ’ª\n\nğŸ“Š *Tu capacidad de compra:*\nâ€¢ Enganche: ' + formatMoney(engancheConfirmado) + '\nâ€¢ CrÃ©dito estimado: ' + formatMoney(creditoMax) + '\nâ€¢ *Total: ' + formatMoney(capacidadTotal) + '* para tu casa\n\nâš ï¸ Cifras ilustrativas. El banco define el monto final.\n\nÂ¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ' + (bancoPreferido || 'crÃ©dito') + '*?';
        } else {
          analysis.response = 'Â¡Excelente ' + nombreCliente + '! ğŸ’ª\n\nCon ' + formatMoney(engancheConfirmado) + ' de enganche mÃ¡s el crÃ©dito, tienes buenas opciones.\n\nâš ï¸ Cifras ilustrativas. El banco define el monto final.\n\nÂ¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ' + (bancoPreferido || 'crÃ©dito') + '*?';
        }
      } else {
        analysis.response = 'Â¡Perfecto! Â¿CuÃ¡nto tienes ahorrado para el enganche?';
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 5: Cliente dijo SÃ a asesor â†’ Pedir NOMBRE y CELULAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaAsesorVIP && respuestaAfirmativa) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Quiere asesor');
      
      // Si ya tenemos nombre, saltar directo a modalidad
      if (lead.name) {
        console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Ya tenemos nombre, saltando a MODALIDAD');
        analysis.response = `Â¡Perfecto ${lead.name}! ğŸ˜Š Â¿CÃ³mo prefieres que te contacte el asesor?

1ï¸âƒ£ *Llamada telefÃ³nica*
2ï¸âƒ£ *Videollamada* (Zoom/Meet)
3ï¸âƒ£ *Presencial* (en oficina)`;
      } else {
        // Solo pedir nombre (WhatsApp ya lo tenemos)
        console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Pidiendo solo NOMBRE');
        analysis.response = `Â¡Perfecto! ğŸ˜Š Â¿Me compartes tu *nombre completo* para conectarte con el asesor?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 5.5: Cliente dio NOMBRE/CELULAR â†’ Preguntar MODALIDAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const preguntabaNombreCelular = ultimoMsgSara?.content?.includes('nombre completo');
    
    // Detectar si el mensaje tiene un nÃºmero de telÃ©fono (10 dÃ­gitos)
    const telefonoEnMensaje = originalMessage.match(/\d{10,}/);
    // Detectar si tiene algo que parece nombre
    const textoSinNumeros = originalMessage.replace(/[\d\-\+\(\)]/g, '').trim();
    const pareceNombre = textoSinNumeros.length > 3;
    
    if (preguntabaNombreCelular && (telefonoEnMensaje || pareceNombre)) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5.5: Nombre/Celular recibido â†’ Preguntar MODALIDAD');
      
      // Extraer y guardar nombre (preferir el extraÃ­do por OpenAI, ya limpio)
      const nombreLimpio = analysis.extracted_data?.nombre || textoSinNumeros;
      if (nombreLimpio && nombreLimpio.length > 2) {
        try {
          await this.supabase.client
            .from('leads')
            .update({ name: nombreLimpio })
            .eq('id', lead.id);
          lead.name = nombreLimpio;
          console.log('âœ… Nombre guardado:', nombreLimpio);
        } catch (e) {}
      }
      
      // Extraer y guardar telÃ©fono
      if (telefonoEnMensaje) {
        const telLimpio = telefonoEnMensaje[0];
        try {
          await this.supabase.client
            .from('leads')
            .update({ phone: telLimpio })
            .eq('id', lead.id);
          console.log('âœ… TelÃ©fono guardado:', telLimpio);
        } catch (e) {}
      }
      
      const nombreSaludo = lead.name || textoSinNumeros || 'amigo';
      
      analysis.response = `Â¡Gracias ${nombreSaludo}! ğŸ˜Š Â¿CÃ³mo prefieres que te contacte el asesor?

1ï¸âƒ£ *Llamada telefÃ³nica*
2ï¸âƒ£ *Videollamada* (Zoom/Meet)
3ï¸âƒ£ *Presencial* (en oficina)`;
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 6: Cliente eligiÃ³ MODALIDAD â†’ CONECTAR CON ASESOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaModalidad && modalidadDetectada) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 6: Modalidad elegida:', modalidadDetectada.nombre, 'â†’ CONECTANDO');
      
      // Guardar modalidad
      try {
        await this.supabase.client
          .from('leads')
          .update({ modalidad_asesoria: modalidadDetectada.nombre })
          .eq('id', lead.id);
        console.log('âœ… Modalidad guardada:', modalidadDetectada.nombre);
      } catch (e) {}
      
      // Obtener banco del lead
      let bancoPreferido = lead.banco_preferido;
      if (!bancoPreferido) {
        try {
          const { data: leadActualizado } = await this.supabase.client
            .from('leads')
            .select('banco_preferido')
            .eq('id', lead.id)
            .single();
          bancoPreferido = leadActualizado?.banco_preferido;
        } catch (e) {}
      }
      
      // Buscar asesor del banco
      const asesorBanco = teamMembers.find((t: any) => 
        t.role === 'asesor' && 
        t.banco?.toLowerCase() === bancoPreferido?.toLowerCase()
      );
      
      // Verificar que telÃ©fono no sea placeholder
      const telefonoValido = asesorBanco?.phone && !asesorBanco.phone.startsWith('+5200000000');
      
      console.log('ğŸ” Buscando asesor de', bancoPreferido, 'â†’', asesorBanco?.name || 'NO ENCONTRADO', '| Tel vÃ¡lido:', telefonoValido);
      
      // Obtener datos del lead para la notificaciÃ³n
      let ingresoMensual = 'No especificado';
      let engancheDisponible = 'No especificado';
      
      // Buscar ingreso en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('ingreso de')) {
          const match = msg.content.match(/\$\s*([\d,]+)/);
          if (match) {
            ingresoMensual = `$${match[1]}/mes`;
            break;
          }
        }
      }
      
      // Buscar enganche en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('Enganche:')) {
          const match = msg.content.match(/Enganche:\s*\$?([\d,]+)/);
          if (match) {
            engancheDisponible = `$${match[1]}`;
            break;
          }
        }
      }
      
      // Re-fetch enganche de DB
      try {
        const { data: leadData } = await this.supabase.client
          .from('leads')
          .select('enganche_disponible')
          .eq('id', lead.id)
          .single();
        if (leadData?.enganche_disponible) {
          engancheDisponible = `$${leadData.enganche_disponible.toLocaleString('es-MX')}`;
        }
      } catch (e) {}
      
      if (asesorBanco && telefonoValido) {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTIFICAR AL ASESOR DEL BANCO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const score = lead.lead_score || lead.score || 0;
        const temp = score >= 70 ? 'HOT ğŸ”¥' : score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
        
        const msgAsesorBanco = `ğŸ”¥ğŸ”¥ğŸ”¥ *Â¡NUEVO LEAD DE CRÃ‰DITO!* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¦ *Banco:* ${bancoPreferido}
ğŸ“¹ *Modalidad:* ${modalidadDetectada.nombre}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${nombreCliente}
ğŸ“± *WhatsApp:* ${cleanPhone}
ğŸ’° *Ingreso:* ${ingresoMensual}
ğŸ’µ *Enganche:* ${engancheDisponible}
ğŸ“Š *Score:* ${score}/100 ${temp}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTACTAR A LA BREVEDAD!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorBanco.phone}`,
          msgAsesorBanco
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor de', bancoPreferido);
        
        // Guardar asesor asignado
        try {
          await this.supabase.client
            .from('leads')
            .update({ asesor_banco_id: asesorBanco.id })
            .eq('id', lead.id);
        } catch (e) {}
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CREAR SOLICITUD HIPOTECARIA EN CRM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        try {
          const ingresoNum = parseInt(ingresoMensual.replace(/[^0-9]/g, '')) || 0;
          const engancheNum = parseInt(engancheDisponible.replace(/[^0-9]/g, '')) || 0;
          const creditoEstimado = ingresoNum * 60;
          
          await this.supabase.client
            .from('mortgage_applications')
            .insert([{
              lead_id: lead.id,
              lead_name: nombreCliente,
              lead_phone: cleanPhone,
              bank: bancoPreferido,
              monthly_income: ingresoNum,
              down_payment: engancheNum,
              requested_amount: creditoEstimado,
              assigned_advisor_id: asesorBanco.id,
              assigned_advisor_name: asesorBanco.name,
              status: 'pending',
              status_notes: `Modalidad: ${modalidadDetectada.nombre}`,
              pending_at: new Date().toISOString()
            }]);
          console.log('ğŸ“‹ Solicitud hipotecaria creada en CRM');
        } catch (mortgageError) {
          console.error('âŒ Error creando solicitud hipotecaria:', mortgageError);
        }
        
        // Respuesta al cliente
        analysis.response = `Â¡Listo ${nombreCliente}! ğŸ‰

*${asesorBanco.name}* de *${bancoPreferido}* se pondrÃ¡ en contacto contigo a la brevedad por *${modalidadDetectada.nombre}*.

ğŸ“± Su telÃ©fono: ${asesorBanco.phone}

âœ… Ya le avisÃ© de tu interÃ©s. Â¡Ã‰xito con tu crÃ©dito!`;
        
        analysis.send_contactos = true;
        
      } else {
        // No hay asesor disponible
        analysis.response = `Â¡Perfecto ${nombreCliente}! ğŸ˜Š

He registrado tu solicitud de asesorÃ­a con *${bancoPreferido || 'crÃ©dito'}* por *${modalidadDetectada.nombre}*.

Un asesor te contactarÃ¡ muy pronto. Â¿Hay algo mÃ¡s en lo que pueda ayudarte?`;
        
        console.log('âš ï¸ No hay asesor disponible para', bancoPreferido);
      }
      
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECCIÃ“N FORZADA: Si Ãºltimo mensaje fue "Â¿QUIERES CONOCERLO?" y cliente dice "sÃ­"
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const preguntabaVisita = ultimoMsgSara?.content?.includes('CONOCERLO EN PERSONA') || 
                             ultimoMsgSara?.content?.includes('gustarÃ­a visitarlos') ||
                             ultimoMsgSara?.content?.includes('agendar una cita');
    
    if (preguntabaVisita && respuestaAfirmativa && analysis.intent !== 'solicitar_cita') {
      console.log('ğŸ”„ FORZANDO solicitar_cita - Cliente dijo SÃ a visita');
      analysis.intent = 'solicitar_cita';
    }

    // 1. Enviar respuesta principal
    let respuestaPrincipal = analysis.response;
    
    // Verificar si ya tiene cita para quitar preguntas de visita
    const yaTieneCita = historial.some((msg: any) => 
      msg.content?.includes('Â¡Cita confirmada!') || 
      msg.content?.includes('Te agendo para')
    );
    
    // Si YA TIENE CITA, quitar CUALQUIER pregunta de visita de la respuesta
    if (yaTieneCita) {
      respuestaPrincipal = respuestaPrincipal
        .replace(/\n*Â¿[Tt]e gustarÃ­a visitar.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres conocer.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres agendar.*\?/gi, '')
        .replace(/\n*Â¿[Tt]e gustarÃ­a agendar.*\?/gi, '')
        .replace(/\n*Â¿[Tt]e gustarÃ­a conocer.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres visitar.*\?/gi, '')
        .replace(/Con esto podrÃ­as ver casas en[^.]*\./gi, '')
        .replace(/Mientras avanzas con el crÃ©dito[^?]*\?/gi, '')
        .trim();
      console.log('ğŸ”„ Limpiando preguntas de visita (ya tiene cita)');
    }
    
    // Si es confirmar_cita, quitar la pregunta de crÃ©dito del mensaje principal
    const esConfirmarCita = analysis.intent === 'confirmar_cita' && 
                            analysis.extracted_data.fecha && 
                            analysis.extracted_data.hora;
    
    if (esConfirmarCita && respuestaPrincipal.includes('crÃ©dito hipotecario')) {
      respuestaPrincipal = respuestaPrincipal
        .replace(/\n*Por cierto,.*crÃ©dito hipotecario.*\?/gi, '')
        .replace(/\n*Â¿Ya tienes crÃ©dito.*\?/gi, '')
        .trim();
    }
    
    await this.twilio.sendWhatsAppMessage(from, respuestaPrincipal);
    console.log('âœ… Respuesta enviada');
    
    // NOTA: Ya NO enviamos mensaje separado de ASESOR VIP
    // El flujo nuevo de bancos maneja todo en los PASOS 1-6 arriba

    // Obtener desarrollo(s) - considerar array de desarrollos si existe
    const desarrollosArray = analysis.extracted_data.desarrollos || [];
    const desarrolloSingle = analysis.extracted_data.desarrollo;
    const desarrollo = desarrolloSingle || desarrollosArray[0] || lead.property_interest;
    const desarrollosParaCita = desarrollosArray.length > 0 ? desarrollosArray.join(' y ') : desarrollo;
    
    const propsDesarrollo = desarrollo ? 
      properties.filter(p => p.development?.toLowerCase().includes(desarrollo.toLowerCase())) : [];

    // 2. CITA: Solo si intent es confirmar_cita Y tiene fecha+hora Y tenemos nombre
    const tieneNombre = lead.name || analysis.extracted_data.nombre;
    const preguntamosCredito = lead.needs_mortgage !== null || analysis.extracted_data.necesita_credito !== null;
    
    // Verificar si ya tiene cita antes de intentar crear otra
    let yaExisteCita = false;
    try {
      const { data: citaPrevia } = await this.supabase.client
        .from('appointments')
        .select('id')
        .eq('lead_id', lead.id)
        .eq('status', 'scheduled')
        .limit(1);
      yaExisteCita = citaPrevia && citaPrevia.length > 0;
    } catch (e) {
      console.log('âš ï¸ Error verificando cita previa');
    }
    
    if (analysis.intent === 'confirmar_cita' && 
        analysis.extracted_data.fecha && 
        analysis.extracted_data.hora) {
      
      // Determinar el desarrollo final
      const desarrolloFinal = desarrollosParaCita || desarrollo;
      
      // Si ya tiene cita, NO crear otra
      if (yaExisteCita) {
        console.log('ğŸš« YA TIENE CITA - No se crearÃ¡ duplicada');
        // No hacer nada, la respuesta de OpenAI ya deberÃ­a ser adecuada
      }
      // Si NO hay desarrollo vÃ¡lido, NO crear cita
      else if (!desarrolloFinal || desarrolloFinal === 'Por definir') {
        console.log('ğŸš« NO HAY DESARROLLO VÃLIDO - No se crearÃ¡ cita');
        // No crear cita sin desarrollo, redirigir a asesor
        await this.twilio.sendWhatsAppMessage(from, 'Â¡Perfecto! ğŸ˜Š Para recomendarte el mejor desarrollo segÃºn tu presupuesto, Â¿te gustarÃ­a que un asesor te contacte directamente?');
      }
      // VerificaciÃ³n de seguridad: NO crear cita sin nombre
      else if (!tieneNombre) {
        console.log('âš ï¸ Intento de cita SIN NOMBRE - no se crearÃ¡');
        await this.twilio.sendWhatsAppMessage(from, 'Â¡Me encanta que quieras visitarnos! ğŸ˜Š Solo para darte mejor atenciÃ³n, Â¿me compartes tu nombre?');
      }
      // Si tenemos nombre, desarrollo vÃ¡lido y NO tiene cita previa, crear cita
      else {
        console.log('âœ… CREANDO CITA COMPLETA...');
        if (!preguntamosCredito) {
          console.log('âš ï¸ Nota: Cita creada sin info de crÃ©dito');
        }
        await this.crearCitaCompleta(
          from, cleanPhone, lead, desarrolloFinal,
          analysis.extracted_data.fecha,
          analysis.extracted_data.hora,
          teamMembers, analysis
        );
      }
    }

    // 3. Enviar recursos si aplica (MÃšLTIPLES DESARROLLOS Y MODELOS)
    const clientName = analysis.extracted_data.nombre || lead.name || 'Cliente';
    
    // Parsear desarrollos y modelos del mensaje original
    const { desarrollos: desarrollosDetectados, modelos: modelosDetectados } = this.parsearDesarrollosYModelos(originalMessage);
    
    // TambiÃ©n considerar lo que extrajo OpenAI
    const desarrollosOpenAI = analysis.extracted_data.desarrollos || [];
    const modelosOpenAI = analysis.extracted_data.modelos || [];
    
    // Combinar todas las fuentes de desarrollos (usar 'desarrollo' ya definido arriba)
    const todosDesarrollos = [...new Set([
      ...desarrollosDetectados,
      ...desarrollosOpenAI,
      ...(desarrollo ? [desarrollo] : [])
    ])];
    
    // Combinar todas las fuentes de modelos
    const todosModelos = [...new Set([
      ...modelosDetectados,
      ...modelosOpenAI
    ])];
    
    console.log('ğŸ“‹ Desarrollos detectados:', todosDesarrollos);
    console.log('ğŸ“‹ Modelos detectados:', todosModelos);
    
    // Verificar si ya se enviaron recursos para estos desarrollos (evitar duplicados)
    // Nota: historial ya estÃ¡ declarado arriba
    
    // Verificar en historial si hay mensajes con emojis de recursos
    const recursosEnHistorial = historial.some((msg: any) => 
      msg.role === 'assistant' && 
      (msg.content?.includes('ğŸ¬') || 
       msg.content?.includes('video') ||
       msg.content?.includes('Matterport') ||
       msg.content?.includes('matterport') ||
       msg.content?.includes('tour virtual') ||
       msg.content?.includes('youtu'))
    );
    
    // TambiÃ©n verificar si el Ãºltimo mensaje de SARA preguntÃ³ sobre visitar
    const ultimoMensajeSara = historial.filter((m: any) => m.role === 'assistant').pop();
    const preguntoPorVisita = ultimoMensajeSara?.content?.includes('visitarlos') || 
                              ultimoMensajeSara?.content?.includes('conocer') ||
                              ultimoMensajeSara?.content?.includes('en persona');
    
    // Si el lead ya tiene property_interest del mismo desarrollo, ya se enviaron recursos
    const mismoDesarrollo = lead.property_interest && 
                           todosDesarrollos.some(d => 
                             lead.property_interest?.toLowerCase().includes(d.toLowerCase())
                           );
    
    const recursosYaEnviados = recursosEnHistorial || mismoDesarrollo;
    
    console.log('ğŸ” Â¿Recursos ya enviados?', recursosYaEnviados, 
                '| En historial:', recursosEnHistorial, 
                '| Mismo desarrollo:', mismoDesarrollo,
                '| PreguntÃ³ visita:', preguntoPorVisita);
    
    // Solo enviar recursos si hay interÃ©s Y NO se enviaron antes
    const debeEnviarRecursos = (analysis.send_video_desarrollo || 
                               analysis.intent === 'interes_desarrollo') &&
                               !recursosYaEnviados;
    
    // NO enviar recursos duplicados
    if (recursosYaEnviados && (analysis.intent === 'interes_desarrollo' || analysis.send_video_desarrollo)) {
      console.log('â­ï¸ Recursos ya enviados antes, no se duplican');
    }
    
    if (debeEnviarRecursos) {
      const videosEnviados = new Set<string>();
      const matterportsEnviados = new Set<string>();
      
      // â³ PequeÃ±o delay para asegurar que el texto llegue primero
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // CASO 1: Modelos especÃ­ficos (ej. "el Ascendente y el Gardenia")
      if (todosModelos.length > 0) {
        const propsModelos = this.getPropsParaModelos(todosModelos, properties);
        
        for (const prop of propsModelos) {
          const nombreModelo = prop.model || prop.name || 'Casa';
          const nombreDesarrollo = prop.development || 'Desarrollo';
          
          // Video YouTube del modelo (personalizado + texto vendedor)
          if (prop.youtube_link && !videosEnviados.has(prop.youtube_link)) {
            const saludo = clientName !== 'Cliente' ? `*${clientName}*, mira` : 'Mira';
            const msgVideo = `ğŸ¬ ${saludo} cÃ³mo es *${nombreModelo}* en ${nombreDesarrollo} por dentro:\n${prop.youtube_link}`;
            await this.twilio.sendWhatsAppMessage(from, msgVideo);
            videosEnviados.add(prop.youtube_link);
            console.log(`âœ… Video YouTube enviado: ${nombreModelo}`);
          }
          
          // Matterport del modelo (personalizado)
          if (prop.matterport_link && !matterportsEnviados.has(prop.matterport_link)) {
            const saludo = clientName !== 'Cliente' ? `*${clientName}*, recorre` : 'Recorre';
            const msgMatterport = `ğŸ  ${saludo} *${nombreModelo}* en 3D como si estuvieras ahÃ­:\n${prop.matterport_link}`;
            await this.twilio.sendWhatsAppMessage(from, msgMatterport);
            matterportsEnviados.add(prop.matterport_link);
            console.log(`âœ… Matterport enviado: ${nombreModelo}`);
          }
          
          // âŒ GPS NO se envÃ­a automÃ¡ticamente - solo con cita confirmada
        }
      }
      
      // CASO 2: Desarrollos (ej. "Los Encinos y Andes")
      if (todosDesarrollos.length > 0) {
        for (const dev of todosDesarrollos) {
          const propsDelDesarrollo = properties.filter(p => 
            p.development?.toLowerCase().includes(dev.toLowerCase())
          );
          
          if (propsDelDesarrollo.length > 0) {
            const prop = propsDelDesarrollo[0]; // Primera propiedad del desarrollo
            console.log(`ğŸ“¹ ${dev}: youtube_link=${prop.youtube_link ? 'SÃ' : 'NO'}, matterport=${prop.matterport_link ? 'SÃ' : 'NO'}, gps=${prop.gps_link ? 'SÃ' : 'NO'}`);
            
            // Video YouTube del desarrollo (personalizado + texto vendedor)
            if (prop.youtube_link && !videosEnviados.has(prop.youtube_link)) {
              const saludo = clientName !== 'Cliente' ? `*${clientName}*, mira` : 'Mira';
              const msgVideo = `ğŸ¬ ${saludo} cÃ³mo es *${dev}* por dentro:\n${prop.youtube_link}`;
              await this.twilio.sendWhatsAppMessage(from, msgVideo);
              videosEnviados.add(prop.youtube_link);
              console.log(`âœ… Video YouTube enviado: ${dev}`);
            } else if (!prop.youtube_link) {
              console.log(`âš ï¸ ${dev} NO tiene youtube_link en DB`);
            }
            
            // Matterport del desarrollo (personalizado)
            if (prop.matterport_link && !matterportsEnviados.has(prop.matterport_link)) {
              const nombreModelo = prop.model || prop.name || 'la casa modelo';
              const saludo = clientName !== 'Cliente' ? `*${clientName}*, recorre` : 'Recorre';
              const msgMatterport = `ğŸ  ${saludo} *${nombreModelo}* de ${dev} en 3D:\n${prop.matterport_link}`;
              await this.twilio.sendWhatsAppMessage(from, msgMatterport);
              matterportsEnviados.add(prop.matterport_link);
              console.log(`âœ… Matterport enviado: ${dev}`);
            }
            
            // âŒ GPS NO se envÃ­a automÃ¡ticamente - solo con cita confirmada
          }
        }
      }
      
      console.log(`ğŸ“Š Resumen: ${videosEnviados.size} videos, ${matterportsEnviados.size} matterports (GPS solo con cita)`);
      
      // Marcar en el lead que ya se enviaron recursos (para evitar duplicados)
      try {
        const recursosEnviados = [];
        if (videosEnviados.size > 0) recursosEnviados.push('video');
        if (matterportsEnviados.size > 0) recursosEnviados.push('matterport');
        
        // Agregar nota al historial indicando que se enviaron recursos
        const notaRecursos = `[SISTEMA: Se enviaron recursos (${recursosEnviados.join(', ')}) para ${todosDesarrollos.join(', ')}]`;
        await this.supabase.client
          .from('leads')
          .update({ 
            property_interest: todosDesarrollos[0] || desarrollo,
            // Agregar flag de recursos enviados en metadata o similar
          })
          .eq('id', lead.id);
        console.log('ğŸ“ Marcado: recursos ya enviados para', todosDesarrollos.join(', '));
      } catch (e) {
        console.log('âš ï¸ Error marcando recursos enviados');
      }
      
      // Mensaje de seguimiento despuÃ©s de enviar recursos - MÃS LLAMATIVO
      if (videosEnviados.size > 0 || matterportsEnviados.size > 0) {
        const desarrollosMencionados = todosDesarrollos.length > 0 ? todosDesarrollos.join(' y ') : 'nuestros desarrollos';
        
        await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 segundos
        
        const msgSeguimiento = `ğŸ  *Â¿QUIERES CONOCERLO EN PERSONA?* ğŸ 

Puedo agendarte una cita para que visites *${desarrollosMencionados}*. Â¿QuÃ© dices? ğŸ˜Š`;
        
        await this.twilio.sendWhatsAppMessage(from, msgSeguimiento);
        console.log('âœ… Mensaje de seguimiento enviado (formato llamativo)');
        
        // Agregar mensaje de seguimiento al historial para que OpenAI lo vea
        try {
          const historialActual = lead.conversation_history || [];
          historialActual.push({ 
            role: 'assistant', 
            content: msgSeguimiento, 
            timestamp: new Date().toISOString() 
          });
          await this.supabase.client
            .from('leads')
            .update({ conversation_history: historialActual.slice(-30) })
            .eq('id', lead.id);
          console.log('ğŸ“ Mensaje de seguimiento agregado al historial');
        } catch (e) {
          console.log('âš ï¸ Error agregando mensaje al historial');
        }
      }
    }

    // 4. Si pide contacto con asesor, notificar al asesor Y confirmar al cliente
    // âš ï¸ Solo se ejecuta si NO se usÃ³ el nuevo flujo de banco/modalidad
    if (analysis.send_contactos) {
      console.log('ğŸ“¤ VERIFICANDO NOTIFICACIÃ“N A ASESOR...');
      
      // Si ya se procesÃ³ con el flujo de banco, NO usar este flujo viejo
      const leadActualizado = await this.supabase.client
        .from('leads')
        .select('banco_preferido, modalidad_asesoria')
        .eq('id', lead.id)
        .single();
      
      if (leadActualizado?.data?.banco_preferido && leadActualizado?.data?.modalidad_asesoria) {
        console.log('â­ï¸ Ya se procesÃ³ con flujo de BANCO/MODALIDAD, saltando flujo viejo');
        return;
      }
      
      // Verificar si ya se enviÃ³ notificaciÃ³n al asesor (evitar duplicados)
      const historialCompleto = lead.conversation_history || [];
      const yaSeEnvioAsesor = historialCompleto.some((msg: any) => 
        msg.role === 'assistant' && 
        (msg.content?.includes('Tu asesor hipotecario es') || 
         msg.content?.includes('Te voy a conectar con') ||
         msg.content?.includes('te contactarÃ¡ pronto'))
      );
      
      if (yaSeEnvioAsesor) {
        console.log('â­ï¸ Ya se enviÃ³ notificaciÃ³n al asesor anteriormente, no se duplica');
        return;
      }
      
      const asesorHipotecario = teamMembers.find(t => 
        t.role?.toLowerCase().includes('hipotec') || 
        t.role?.toLowerCase().includes('credito') ||
        t.role?.toLowerCase().includes('crÃ©dito') ||
        t.role?.toLowerCase().includes('asesor')
      );
      console.log('ğŸ‘¤ Asesor encontrado:', asesorHipotecario?.name || 'NO', '| Tel:', asesorHipotecario?.phone || 'NO');
      
      // Obtener datos de ubicaciÃ³n
      const desarrolloInteres = desarrollo || lead.property_interest || 'Por definir';
      const propDesarrollo = properties.find(p => 
        p.development?.toLowerCase().includes(desarrolloInteres.toLowerCase())
      );
      const direccionAsesor = propDesarrollo?.address || propDesarrollo?.location || `Fraccionamiento ${desarrolloInteres}, Zacatecas`;
      const gpsAsesor = propDesarrollo?.gps_link || '';
      
      // Obtener ingreso del historial Y del mensaje actual
      const historialConversacion = lead.conversation_history || [];
      let ingresoMensual = 'No especificado';
      
      // Buscar en todos los mensajes del historial
      for (const msg of historialConversacion) {
        if (msg.content) {
          // Buscar patrones como "gano 56 mil", "56,000", "$56000", etc.
          const matchMil = msg.content.match(/(\d+)\s*mil/i);
          const matchPesos = msg.content.match(/\$?\s*(\d{1,3}(?:,\d{3})+)/);
          const matchNumero = msg.content.match(/(?:gano|ingreso|sueldo|cobro).*?(\d+)/i);
          
          if (matchMil) {
            ingresoMensual = `$${matchMil[1]},000/mes`;
            console.log('ğŸ’° Ingreso detectado en historial (mil):', ingresoMensual);
          } else if (matchPesos) {
            ingresoMensual = `$${matchPesos[1]}/mes`;
            console.log('ğŸ’° Ingreso detectado en historial (pesos):', ingresoMensual);
          } else if (matchNumero) {
            const num = parseInt(matchNumero[1]);
            if (num > 1000) {
              ingresoMensual = `$${num.toLocaleString()}/mes`;
            } else {
              ingresoMensual = `$${num},000/mes`;
            }
            console.log('ğŸ’° Ingreso detectado en historial (nÃºmero):', ingresoMensual);
          }
        }
      }
      
      // TambiÃ©n buscar en el mensaje original actual
      if (originalMessage) {
        const matchMil = originalMessage.match(/(\d+)\s*mil/i);
        const matchPesos = originalMessage.match(/\$?\s*(\d{1,3}(?:,\d{3})+)/);
        
        if (matchMil) {
          ingresoMensual = `$${matchMil[1]},000/mes`;
          console.log('ğŸ’° Ingreso detectado en mensaje actual (mil):', ingresoMensual);
        } else if (matchPesos) {
          ingresoMensual = `$${matchPesos[1]}/mes`;
          console.log('ğŸ’° Ingreso detectado en mensaje actual (pesos):', ingresoMensual);
        }
      }
      
      // Buscar en la respuesta de SARA si mencionÃ³ el ingreso
      if (ingresoMensual === 'No especificado' && analysis.response) {
        const matchRespuesta = analysis.response.match(/\$(\d{1,3}(?:,\d{3})*)/);
        if (matchRespuesta) {
          ingresoMensual = `$${matchRespuesta[1]}/mes (calculado)`;
          console.log('ğŸ’° Ingreso detectado en respuesta SARA:', ingresoMensual);
        }
      }
      
      console.log('ğŸ’° Ingreso final a enviar:', ingresoMensual);
      
      // Obtener cita existente del lead (de la DB, no solo del anÃ¡lisis)
      let citaExistente = '';
      try {
        const { data: citaDB } = await this.supabase.client
          .from('appointments')
          .select('scheduled_date, scheduled_time, property_name')
          .eq('lead_id', lead.id)
          .eq('status', 'scheduled')
          .order('created_at', { ascending: false })
          .limit(1);
        
        if (citaDB && citaDB.length > 0) {
          const cita = citaDB[0];
          citaExistente = `${cita.scheduled_date} a las ${cita.scheduled_time} en ${cita.property_name}`;
          console.log('ğŸ“… Cita encontrada en DB:', citaExistente);
        }
      } catch (e) {
        console.log('âš ï¸ Error buscando cita en DB');
      }
      
      // Si no hay en DB, usar del anÃ¡lisis
      let fechaCita = '';
      let horaCita = '';
      if (!citaExistente) {
        fechaCita = analysis.extracted_data?.fecha || '';
        horaCita = analysis.extracted_data?.hora || '';
        if (fechaCita && horaCita) {
          citaExistente = `${fechaCita} a las ${horaCita}`;
        }
      }
      
      // Formatear fecha legible para el cliente
      const formatearFechaLegible = (fechaDB: string) => {
        if (!fechaDB) return '';
        // Si ya es legible (maÃ±ana, hoy, etc), retornar
        if (fechaDB.includes('maÃ±ana') || fechaDB.includes('hoy')) return fechaDB;
        // Si es formato ISO, convertir
        try {
          const fecha = new Date(fechaDB);
          const opciones: Intl.DateTimeFormatOptions = { weekday: 'long', day: 'numeric', month: 'long' };
          return fecha.toLocaleDateString('es-MX', opciones);
        } catch {
          return fechaDB;
        }
      };
      
      const formatearHoraLegible = (horaDB: string) => {
        if (!horaDB) return '';
        // Si tiene formato HH:MM:SS, simplificar
        const match = horaDB.match(/(\d{1,2}):(\d{2})/);
        if (match) {
          const hora = parseInt(match[1]);
          const minutos = match[2];
          const periodo = hora >= 12 ? 'pm' : 'am';
          const hora12 = hora > 12 ? hora - 12 : hora === 0 ? 12 : hora;
          return minutos === '00' ? `${hora12} ${periodo}` : `${hora12}:${minutos} ${periodo}`;
        }
        return horaDB;
      };
      
      // Crear versiÃ³n legible de la cita para el cliente
      let citaLegible = '';
      if (citaExistente) {
        const partes = citaExistente.match(/(.+) a las (.+) en (.+)/);
        if (partes) {
          citaLegible = `${formatearFechaLegible(partes[1])} a las ${formatearHoraLegible(partes[2])} en *${partes[3]}*`;
        } else {
          citaLegible = citaExistente;
        }
      }
      
      const temp = lead.lead_score >= 70 ? 'HOT ğŸ”¥' : lead.lead_score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
      
      if (asesorHipotecario?.phone) {
        // 1. MENSAJE COMPLETO AL ASESOR (incluye GPS)
        const msgAsesor = `ğŸ”¥ğŸ”¥ğŸ”¥ *Â¡NUEVO LEAD VIP!* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’³ *SOLICITA ASESORÃA HIPOTECARIA*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ  *InterÃ©s:* ${desarrolloInteres}
ğŸ’° *Ingreso:* ${ingresoMensual}
${citaExistente ? `ğŸ“… *Cita:* ${citaExistente}` : 'ğŸ“… *Cita:* Por agendar'}
ğŸ“Š *Score:* ${lead.lead_score || 0}/100 ${temp}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccionAsesor}
${gpsAsesor ? `ğŸ—ºï¸ ${gpsAsesor}` : ''}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTÃCTALO YA!* âš¡`;

        console.log('ğŸ“¨ MENSAJE A ASESOR:', msgAsesor);
        
        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorHipotecario.phone}`,
          msgAsesor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor (solicitud directa)');
        
        // 2. CONFIRMAR AL CLIENTE CON DATOS DEL ASESOR (SIN GPS para no saturar)
        const nombreAsesor = asesorHipotecario.name?.replace(/ - Asesor.*$/i, '') || 'Nuestro asesor';
        const telAsesor = asesorHipotecario.phone;
        
        const msgConfirmacionCliente = `âœ… *Â¡Listo ${clientName}!* Tu asesor hipotecario es:

ğŸ‘¤ *${nombreAsesor}*
ğŸ“± ${telAsesor}

${citaLegible ? `Te verÃ¡ ${citaLegible}` : 'Ã‰l se pondrÃ¡ en contacto contigo pronto'}`;

        await this.twilio.sendWhatsAppMessage(from, msgConfirmacionCliente);
        console.log('ğŸ“¤ ConfirmaciÃ³n de asesor enviada al cliente');
        
        // Agregar confirmaciÃ³n al historial para evitar duplicados
        try {
          const historialActual = lead.conversation_history || [];
          historialActual.push({ 
            role: 'assistant', 
            content: msgConfirmacionCliente, 
            timestamp: new Date().toISOString() 
          });
          await this.supabase.client
            .from('leads')
            .update({ conversation_history: historialActual.slice(-30) })
            .eq('id', lead.id);
          console.log('ğŸ“ ConfirmaciÃ³n de asesor agregada al historial');
        } catch (e) {
          console.log('âš ï¸ Error agregando confirmaciÃ³n al historial');
        }
        
        // 3. CREAR CITA DE ASESORÃA EN DB (si tiene fecha/hora del anÃ¡lisis)
        const fechaAnalisis = analysis.extracted_data?.fecha;
        const horaAnalisis = analysis.extracted_data?.hora;
        if (fechaAnalisis && horaAnalisis) {
          try {
            const { error: citaError } = await this.supabase.client
              .from('appointments')
              .insert([{
                lead_id: lead.id,
                lead_name: clientName,
                lead_phone: cleanPhone,
                property_name: desarrolloInteres,
                location: direccionAsesor,
                scheduled_date: this.parseFechaISO(fechaAnalisis),
                scheduled_time: this.parseHoraISO(horaAnalisis),
                status: 'scheduled',
                vendedor_id: asesorHipotecario.id,
                vendedor_name: nombreAsesor,
                appointment_type: 'asesoria_credito',
                duration_minutes: 60
              }]);
            
            if (citaError) {
              console.error('âŒ Error creando cita asesor en DB:', citaError);
            } else {
              console.log('ğŸ“… Cita de asesorÃ­a creada en DB');
            }
          } catch (e) {
            console.error('âŒ Error en cita asesor:', e);
          }
        }
      } else {
        console.log('âš ï¸ No se encontrÃ³ asesor con telÃ©fono para notificar');
      }
    }

    // 5. Actualizar lead
    await this.actualizarLead(lead, analysis, originalMessage);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CREAR CITA COMPLETA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async crearCitaCompleta(
    from: string,
    cleanPhone: string,
    lead: any,
    desarrollo: string,
    fecha: string,
    hora: string,
    teamMembers: any[],
    analysis: AIAnalysis
  ): Promise<void> {
    
    const vendedor = teamMembers.find(t => t.id === lead.assigned_to);
    console.log('ğŸ‘¤ Vendedor encontrado:', vendedor?.name || 'NO', '| Email:', vendedor?.email || 'NO', '| Phone:', vendedor?.phone || 'NO');
    
    // Buscar asesor hipotecario en el equipo (ampliar bÃºsqueda)
    const asesorHipotecario = teamMembers.find(t => 
      t.role?.toLowerCase().includes('hipotec') || 
      t.role?.toLowerCase().includes('credito') ||
      t.role?.toLowerCase().includes('crÃ©dito') ||
      t.role?.toLowerCase().includes('financ') ||
      t.role?.toLowerCase().includes('asesor') ||
      t.position?.toLowerCase().includes('hipotec') ||
      t.position?.toLowerCase().includes('credito') ||
      t.name?.toLowerCase().includes('asesor')
    );
    console.log('ğŸ’³ Asesor hipotecario encontrado:', asesorHipotecario?.name || 'NO', '| Email:', asesorHipotecario?.email || 'NO', '| Phone:', asesorHipotecario?.phone || 'NO');
    console.log('ğŸ“‹ Team members disponibles:', teamMembers.map(t => ({ name: t.name, role: t.role, position: t.position })));
    
    const clientName = analysis.extracted_data.nombre || lead.name || 'Cliente';
    const score = lead.lead_score || 0;
    const temp = score >= 70 ? 'HOT ğŸ”¥' : score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
    const necesitaCredito = lead.needs_mortgage === true || analysis.extracted_data.necesita_credito === true;

    // Buscar propiedad para obtener direcciÃ³n y GPS
    const properties = await this.getAllProperties();
    const propDesarrollo = properties.find(p => 
      p.development?.toLowerCase().includes(desarrollo.toLowerCase())
    );
    console.log(`ğŸ“ Propiedad encontrada para ${desarrollo}:`, propDesarrollo ? `address=${propDesarrollo.address}, location=${propDesarrollo.location}` : 'NO ENCONTRADA');
    const direccion = propDesarrollo?.address || propDesarrollo?.location || `Fraccionamiento ${desarrollo}, Zacatecas`;
    const gpsLink = propDesarrollo?.gps_link || '';

    // âš ï¸ VERIFICAR SI YA EXISTE UNA CITA RECIENTE (Ãºltimos 30 minutos)
    try {
      const { data: citaExistente } = await this.supabase.client
        .from('appointments')
        .select('id, created_at, lead_name')
        .eq('lead_id', lead.id)
        .gte('created_at', new Date(Date.now() - 30 * 60 * 1000).toISOString())
        .order('created_at', { ascending: false })
        .limit(1);

      if (citaExistente && citaExistente.length > 0) {
        console.log('âš ï¸ Ya existe cita reciente para este lead, no se crearÃ¡ duplicada');
        
        // Solo actualizar el nombre si no lo tenÃ­amos y ahora sÃ­ lo tenemos
        if (analysis.extracted_data.nombre && !citaExistente[0].lead_name) {
          await this.supabase.client
            .from('appointments')
            .update({ lead_name: analysis.extracted_data.nombre })
            .eq('id', citaExistente[0].id);
          console.log('âœ… Nombre actualizado en cita existente:', analysis.extracted_data.nombre);
        }
        return; // NO crear cita duplicada
      }
    } catch (checkError) {
      console.log('âš ï¸ Error verificando cita existente, continuando...', checkError);
    }

    try {
      // 1. Crear cita en DB con columnas correctas
      const { data: appointment, error } = await this.supabase.client
        .from('appointments')
        .insert([{
          lead_id: lead.id,
          lead_name: clientName,
          lead_phone: cleanPhone,
          property_name: desarrollo,
          location: direccion,
          scheduled_date: this.parseFechaISO(fecha),
          scheduled_time: this.parseHoraISO(hora),
          status: 'scheduled',
          vendedor_id: vendedor?.id,
          vendedor_name: vendedor?.name,
          appointment_type: 'visita',
          duration_minutes: 60
        }])
        .select()
        .single();

    if (error) {
        console.error('âŒ Error creando cita en DB:', error);
      } else {
        console.log('ğŸ“… Cita creada en DB:', appointment?.id);
      }

      const fechaEvento = this.parseFecha(fecha, hora);
      console.log('ğŸ“† Fecha evento parseada:', fechaEvento.toISOString());
      console.log('ğŸ“† Calendar object exists:', !!this.calendar);
      console.log('ğŸ“† Calendar.createEvent exists:', typeof this.calendar?.createEvent);
      
      // Formatear fechas para Google Calendar API (RFC3339 con offset)
      const endEvento = new Date(fechaEvento.getTime() + 60 * 60 * 1000);
      
      // Formato RFC3339 con offset de zona horaria MÃ©xico (UTC-6)
      const formatDateForCalendar = (date: Date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        // Formato ISO 8601 completo
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
      };
      
      // Calcular fechas una sola vez para ambos eventos
      const startDateTime = formatDateForCalendar(fechaEvento);
      const endDateTime = formatDateForCalendar(endEvento);
      
      // 2. Google Calendar - CITA VENDEDOR
      try {
        console.log('ğŸ“† Intentando crear evento VENDEDOR en Google Calendar...');
        console.log('ğŸ“† Start:', startDateTime, '| End:', endDateTime);
        
        // Normalizar evento para evitar error "Start and end times must either both be date or both be dateTime"
        const eventData: any = {
          summary: `ğŸ  Visita ${desarrollo} - ${clientName}`,
          description: `ğŸ‘¤ Cliente: ${clientName}
ğŸ“± TelÃ©fono: ${cleanPhone}
ğŸ  Desarrollo: ${desarrollo}
ğŸ“ DirecciÃ³n: ${direccion}
ğŸ—ºï¸ GPS: ${gpsLink}
ğŸ“Š Score: ${score}/100 ${temp}
ğŸ’³ Necesita crÃ©dito: ${necesitaCredito ? 'SÃ' : 'No especificado'}`,
          location: direccion,
          start: {
            dateTime: startDateTime,
            timeZone: 'America/Mexico_City'
          },
          end: {
            dateTime: endDateTime,
            timeZone: 'America/Mexico_City'
          },
          attendees: vendedor?.email ? [{ email: vendedor.email }] : []
        };
        
        // Asegurar que no haya mezcla de date y dateTime
        if (eventData.start?.dateTime) delete eventData.start.date;
        if (eventData.end?.dateTime) delete eventData.end.date;
        
        console.log('ğŸ“† Event data (normalizado):', JSON.stringify(eventData, null, 2));
        
        const eventResult = await this.calendar.createEvent(eventData);
        console.log('ğŸ“… Evento Google Calendar VENDEDOR creado:', eventResult);
      } catch (calError) {
        console.error('âŒ Error Calendar Vendedor:', calError);
        console.error('âŒ Error details:', JSON.stringify(calError, null, 2));
      }

      // 3. Google Calendar - CITA ASESOR HIPOTECARIO (si necesita crÃ©dito)
      console.log('ğŸ’³ Â¿Necesita crÃ©dito?', necesitaCredito, '| Â¿Tiene asesor email?', asesorHipotecario?.email || 'NO');
      if (necesitaCredito && asesorHipotecario?.email) {
        try {
          console.log('ğŸ“† Intentando crear evento ASESOR en Google Calendar...');
          
          // Normalizar evento
          const eventAsesorData: any = {
            summary: `ğŸ’³ AsesorÃ­a CrÃ©dito - ${clientName} (${desarrollo})`,
            description: `ğŸ‘¤ Cliente: ${clientName}
ğŸ“± TelÃ©fono: ${cleanPhone}
ğŸ  Desarrollo de interÃ©s: ${desarrollo}
ğŸ“ DirecciÃ³n: ${direccion}
ğŸ—ºï¸ GPS: ${gpsLink}
ğŸ“Š Score: ${score}/100 ${temp}
ğŸ‘¤ Vendedor asignado: ${vendedor?.name || 'Por asignar'}`,
            location: direccion,
            start: {
              dateTime: startDateTime,
              timeZone: 'America/Mexico_City'
            },
            end: {
              dateTime: endDateTime,
              timeZone: 'America/Mexico_City'
            },
            attendees: [{ email: asesorHipotecario.email }]
          };
          
          // Asegurar que no haya mezcla de date y dateTime
          if (eventAsesorData.start?.dateTime) delete eventAsesorData.start.date;
          if (eventAsesorData.end?.dateTime) delete eventAsesorData.end.date;
          
          const eventAsesor = await this.calendar.createEvent(eventAsesorData);
          console.log('ğŸ“… Evento Google Calendar ASESOR HIPOTECARIO creado:', eventAsesor);
        } catch (calError) {
          console.error('âŒ Error Calendar Asesor:', calError);
        }
      } else {
        console.log('â­ï¸ No se creÃ³ cita de asesor:', necesitaCredito ? 'Falta email de asesor' : 'No necesita crÃ©dito');
      }

      // 4. Notificar al VENDEDOR con direcciÃ³n y GPS
      if (vendedor?.phone) {
        const msgVendedor = `ğŸ””ğŸ””ğŸ”” *Â¡NUEVA CITA!* ğŸ””ğŸ””ğŸ””
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ  *${desarrollo}*
ğŸ“… *${fecha}* a las *${hora}*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ“Š *Score:* ${score}/100 ${temp}
ğŸ’³ *CrÃ©dito:* ${necesitaCredito ? 'âš ï¸ SÃ NECESITA' : 'No especificado'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccion}
ğŸ—ºï¸ ${gpsLink}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡PREPÃRATE PARA RECIBIRLO!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${vendedor.phone}`,
          msgVendedor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a vendedor');
      }

      // 5. Notificar al ASESOR HIPOTECARIO (si necesita crÃ©dito)
      if (necesitaCredito && asesorHipotecario?.phone) {
        const msgAsesor = `ğŸ”¥ğŸ”¥ğŸ”¥ *LEAD NECESITA CRÃ‰DITO* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ  *${desarrollo}*
ğŸ“… *Visita:* ${fecha} a las ${hora}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ“Š *Score:* ${score}/100 ${temp}
ğŸ‘¤ *Vendedor:* ${vendedor?.name || 'Por asignar'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccion}
ğŸ—ºï¸ ${gpsLink}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTÃCTALO PARA INICIAR TRÃMITE!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorHipotecario.phone}`,
          msgAsesor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor hipotecario');
      }

      // 6. Enviar confirmaciÃ³n al CLIENTE con info de vendedor y asesor
      let infoContactos = '';
      if (vendedor?.name) {
        infoContactos += `\nğŸ‘¤ *Vendedor:* ${vendedor.name}`;
        if (vendedor.phone) {
          infoContactos += `\nğŸ“± *Tel vendedor:* ${vendedor.phone}`;
        }
      }
      if (necesitaCredito && asesorHipotecario?.name) {
        infoContactos += `\n\nğŸ’³ *Asesor de crÃ©dito:* ${asesorHipotecario.name}`;
        if (asesorHipotecario.phone) {
          infoContactos += `\nğŸ“± *Tel asesor:* ${asesorHipotecario.phone}`;
        }
      }

      const confirmacion = `âœ… *Â¡Cita confirmada!*

ğŸ“… *Fecha:* ${fecha}
ğŸ• *Hora:* ${hora}
ğŸ  *Desarrollo:* ${desarrollo}

ğŸ“ *DirecciÃ³n:* ${direccion}
ğŸ—ºï¸ *Google Maps:* ${gpsLink}
${infoContactos}

Â¡Te esperamos! ğŸ‰`;

      await this.twilio.sendWhatsAppMessage(from, confirmacion);
      
      // Enviar pregunta de crÃ©dito como mensaje SEPARADO (mÃ¡s visible)
      await new Promise(resolve => setTimeout(resolve, 2500)); // 2.5 segundos
      
      const msgPreguntaCredito = `ğŸ’³ *IMPORTANTE* ğŸ’³

Â¿Ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?`;
      
      await this.twilio.sendWhatsAppMessage(from, msgPreguntaCredito);
      console.log('âœ… Pregunta de crÃ©dito enviada (mensaje separado)');

      console.log('âœ… CITA COMPLETA CREADA');

    } catch (error) {
      console.error('âŒ Error en crearCitaCompleta:', error);
    }
  }

  private parseFecha(fecha: string, hora: string): Date {
    const now = new Date();
    const fechaLower = fecha.toLowerCase();
    
    let targetDate = new Date(now);

    if (fechaLower.includes('hoy')) {
      // Hoy
    } else if (fechaLower.includes('maÃ±ana')) {
      targetDate.setDate(targetDate.getDate() + 1);
    } else if (fechaLower.includes('lunes')) {
      targetDate = this.getNextDayOfWeek(1);
    } else if (fechaLower.includes('martes')) {
      targetDate = this.getNextDayOfWeek(2);
    } else if (fechaLower.includes('miÃ©rcoles') || fechaLower.includes('miercoles')) {
      targetDate = this.getNextDayOfWeek(3);
    } else if (fechaLower.includes('jueves')) {
      targetDate = this.getNextDayOfWeek(4);
    } else if (fechaLower.includes('viernes')) {
      targetDate = this.getNextDayOfWeek(5);
    } else if (fechaLower.includes('sÃ¡bado') || fechaLower.includes('sabado')) {
      targetDate = this.getNextDayOfWeek(6);
    } else if (fechaLower.includes('domingo')) {
      targetDate = this.getNextDayOfWeek(0);
    }

    // Parsear hora
    const horaMatch = hora.match(/(\d{1,2})(?::(\d{2}))?/);
    if (horaMatch) {
      let hours = parseInt(horaMatch[1]);
      const minutes = parseInt(horaMatch[2] || '0');
      
      if (hora.toLowerCase().includes('pm') && hours < 12) hours += 12;
      if (hora.toLowerCase().includes('am') && hours === 12) hours = 0;
      
      targetDate.setHours(hours, minutes, 0, 0);
    }

    return targetDate;
  }

  private getNextDayOfWeek(dayOfWeek: number): Date {
    const now = new Date();
    const currentDay = now.getDay();
    let daysUntil = dayOfWeek - currentDay;
    if (daysUntil <= 0) daysUntil += 7;
    
    const result = new Date(now);
    result.setDate(result.getDate() + daysUntil);
    return result;
  }

  // Parsear fecha a formato ISO (YYYY-MM-DD) para Supabase
  private parseFechaISO(fecha: string): string {
    const targetDate = this.parseFecha(fecha, '12:00');
    return targetDate.toISOString().split('T')[0];
  }

  // Parsear hora a formato TIME (HH:MM:SS) para Supabase
  private parseHoraISO(hora: string): string {
    const horaMatch = hora.match(/(\d{1,2})(?::(\d{2}))?/);
    if (horaMatch) {
      let hours = parseInt(horaMatch[1]);
      const minutes = horaMatch[2] || '00';
      
      if (hora.toLowerCase().includes('pm') && hours < 12) hours += 12;
      if (hora.toLowerCase().includes('am') && hours === 12) hours = 0;
      
      return `${hours.toString().padStart(2, '0')}:${minutes}:00`;
    }
    return '12:00:00';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACTUALIZAR LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async actualizarLead(lead: any, analysis: AIAnalysis, originalMessage: string): Promise<void> {
    const updates: any = {};
    const data = analysis.extracted_data;

    // Actualizar datos extraÃ­dos
    if (data.nombre && !lead.name) {
      updates.name = data.nombre;
    }
    if (data.desarrollo && !lead.property_interest) {
      updates.property_interest = data.desarrollo;
    }
    if (data.necesita_credito !== null && data.necesita_credito !== undefined && lead.needs_mortgage === null) {
      updates.needs_mortgage = data.necesita_credito;
    }
    if (data.num_recamaras && !lead.num_recamaras) {
      updates.num_recamaras = data.num_recamaras;
    }

    // Calcular score
    let score = lead.lead_score || 0;
    
    if (!lead.name && data.nombre) {
      score += 15;
      console.log('ğŸ“Š +15 por nombre');
    }
    if (!lead.property_interest && data.desarrollo) {
      score += 15;
      console.log('ğŸ“Š +15 por desarrollo');
    }
    if (lead.needs_mortgage === null && data.necesita_credito !== null && data.necesita_credito !== undefined) {
      score += 10;
      console.log('ğŸ“Š +10 por crÃ©dito');
    }
    if (analysis.intent === 'confirmar_cita' && data.fecha && data.hora) {
      score += 20;
      console.log('ğŸ“Š +20 por cita confirmada');
    }

    updates.lead_score = Math.min(score, 100);
    updates.lead_category = score >= 70 ? 'HOT' : score >= 40 ? 'WARM' : 'COLD';

    // Actualizar historial
    const newHistory = [
      ...(lead.conversation_history || []),
      { role: 'user', content: originalMessage, timestamp: new Date().toISOString() },
      { role: 'assistant', content: analysis.response, timestamp: new Date().toISOString() }
    ].slice(-30);

    updates.conversation_history = newHistory;
    updates.updated_at = new Date().toISOString();

    // Guardar
    const { error, data: citaCreada } = await this.supabase.client
      .from('leads')
      .update(updates)
      .eq('id', lead.id);

    if (error) {
      console.error('âŒ Error actualizando lead:', error);
    } else {
      console.log('ğŸ“ Lead actualizado:', { score: updates.lead_score, temp: updates.lead_category });
    }
  }
}
