import { SupabaseService } from '../services/supabase';
import { OpenAIService } from '../services/openai';
import { TwilioService } from '../services/twilio';

const VIDEO_SERVER_URL = 'https://sara-videos.onrender.com';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERFACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AIAnalysis {
  intent: string;
  extracted_data: {
    nombre?: string;
    fecha?: string;
    hora?: string;
    desarrollo?: string;
    desarrollos?: string[];  // MÃºltiples desarrollos
    modelos?: string[];      // Modelos/casas especÃ­ficas
    num_recamaras?: number;
    necesita_credito?: boolean;
  };
  response: string;
  send_gps?: boolean;
  send_video_desarrollo?: boolean;
  send_contactos?: boolean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASE PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export class WhatsAppHandler {
  constructor(
    private supabase: SupabaseService,
    private openai: OpenAIService,
    private twilio: TwilioService,
    private calendar: any
  ) {}

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LISTAS DE DESARROLLOS Y MODELOS CONOCIDOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  private readonly DESARROLLOS_CONOCIDOS = [
    'Monte Verde', 'Monte Real', 'Los Encinos', 'Miravalle', 'Andes', 'Distrito Falco'
  ];
  
  private readonly MODELOS_CONOCIDOS = [
    // Los Encinos
    'Ascendente', 'Descendente', 'Encino Blanco', 'Encino Verde', 'Encino Dorado',
    // Andes
    'Gardenia', 'Dalia', 'Lavanda', 'Azalea', 'Magnolia',
    // Distrito Falco
    'Calandria', 'ColibrÃ­', 'Colibri', 'Chipre', 'Mirlo',
    // Monte Verde
    'Pino', 'Roble', 'Cedro',
    // Monte Real
    'Real I', 'Real II', 'Real III',
    // Miravalle
    'Bilbao', 'Vizcaya', 'Navarra'
  ];

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PARSEAR MÃšLTIPLES DESARROLLOS Y MODELOS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private parsearDesarrollosYModelos(texto: string): { desarrollos: string[], modelos: string[] } {
    const textoLower = texto.toLowerCase();
    const desarrollos: string[] = [];
    const modelos: string[] = [];
    
    // Buscar desarrollos mencionados
    for (const dev of this.DESARROLLOS_CONOCIDOS) {
      if (textoLower.includes(dev.toLowerCase())) {
        desarrollos.push(dev);
      }
    }
    
    // Buscar modelos/casas especÃ­ficas mencionadas
    for (const modelo of this.MODELOS_CONOCIDOS) {
      if (textoLower.includes(modelo.toLowerCase())) {
        modelos.push(modelo);
      }
    }
    
    return { desarrollos, modelos };
  }

  // Obtener propiedades para mÃºltiples desarrollos
  private getPropsParaDesarrollos(desarrollos: string[], properties: any[]): any[] {
    const props: any[] = [];
    const seen = new Set<string>();
    
    for (const dev of desarrollos) {
      const propsDelDesarrollo = properties.filter(p => 
        p.development?.toLowerCase().includes(dev.toLowerCase())
      );
      for (const prop of propsDelDesarrollo) {
        if (!seen.has(prop.id)) {
          seen.add(prop.id);
          props.push(prop);
        }
      }
    }
    return props;
  }

  // Obtener propiedades para modelos especÃ­ficos
  private getPropsParaModelos(modelos: string[], properties: any[]): any[] {
    const props: any[] = [];
    const seen = new Set<string>();
    
    for (const modelo of modelos) {
      const propDelModelo = properties.find(p => 
        p.model?.toLowerCase().includes(modelo.toLowerCase()) ||
        p.name?.toLowerCase().includes(modelo.toLowerCase())
      );
      if (propDelModelo && !seen.has(propDelModelo.id)) {
        seen.add(propDelModelo.id);
        props.push(propDelModelo);
      }
    }
    return props;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MÃ‰TODO PRINCIPAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async handleIncomingMessage(from: string, body: string, rawRequest?: any): Promise<void> {
    try {
      const trimmedBody = (body || '').trim();
      
      // Filtrar status callbacks de Twilio
      if (rawRequest?.SmsStatus || rawRequest?.MessageStatus || rawRequest?.EventType) {
        console.log('â­ï¸ Ignorando status callback');
        return;
      }
      
      // Filtrar mensajes vacÃ­os o status
      const ignoredMessages = ['OK', 'SENT', 'DELIVERED', 'READ', 'FAILED', 'QUEUED'];
      if (!trimmedBody || ignoredMessages.includes(trimmedBody.toUpperCase())) {
        console.log('â­ï¸ Ignorando:', trimmedBody);
        return;
      }

      console.log('ğŸ“± Mensaje de:', from, '-', body);
      const cleanPhone = from.replace('whatsapp:', '');

      // Obtener datos
      const [lead, properties, teamMembers] = await Promise.all([
        this.getOrCreateLead(cleanPhone),
        this.getAllProperties(),
        this.getAllTeamMembers()
      ]);

      // Analizar con IA
      const analysis = await this.analyzeWithAI(body, lead, properties);
      console.log('ğŸ§  AI Analysis:', JSON.stringify(analysis, null, 2));

      // Si la IA detectÃ³ nombre y el lead no lo tenÃ­a, actualizar en memoria
      if (analysis.extracted_data?.nombre && !lead.name) {
        lead.name = analysis.extracted_data.nombre;
        console.log('âœ… Nombre actualizado en memoria:', lead.name);
      }

      // Ejecutar
      await this.executeAIDecision(analysis, from, cleanPhone, lead, properties, teamMembers, body);

    } catch (error) {
      console.error('âŒ Error:', error);
      await this.twilio.sendWhatsAppMessage(from, 'Disculpa, tuve un problema tÃ©cnico. Â¿Puedes repetir tu mensaje? ğŸ™');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OBTENER O CREAR LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async getOrCreateLead(phone: string): Promise<any> {
    const { data: existingLead } = await this.supabase.client
      .from('leads')
      .select('*')
      .eq('phone', phone)
      .single();

    if (existingLead) {
      console.log('ğŸ“‹ Lead existente:', existingLead.id);
      return existingLead;
    }

    const vendedor = await this.getVendedorMenosCarga();
    
    const newLead = {
      phone,
      conversation_history: [],
      score: 0,
      status: 'new',
      assigned_to: vendedor?.id,
      needs_mortgage: null,
      mortgage_data: {},
      lead_score: 0,
      lead_category: 'cold'
    };

    console.log('ğŸ“ Creando lead...');
    const { data, error } = await this.supabase.client
      .from('leads')
      .insert([newLead])
      .select()
      .single();

    if (error) {
      console.error('âŒ Error creando lead:', error);
      return newLead;
    }

    console.log('âœ… Lead creado:', data.id);
    return data;
  }

  private async getVendedorMenosCarga(): Promise<any> {
    const { data: vendedores } = await this.supabase.client
      .from('team_members')
      .select('*')
      .eq('role', 'vendedor')
      .eq('active', true);

    if (!vendedores?.length) return null;

    const conCarga = await Promise.all(vendedores.map(async (v) => {
      const { count } = await this.supabase.client
        .from('leads')
        .select('*', { count: 'exact', head: true })
        .eq('assigned_to', v.id)
        .in('status', ['new', 'contacted', 'scheduled']);
      return { ...v, carga: count || 0 };
    }));

    conCarga.sort((a, b) => a.carga - b.carga);
    return conCarga[0];
  }

  private async getAllProperties(): Promise<any[]> {
    const { data, error } = await this.supabase.client
      .from('properties')
      .select('*');
    
    if (error) {
      console.error('âŒ Error cargando properties:', error);
      return [];
    }
    
    console.log(`ğŸ“¦ Properties cargadas: ${data?.length || 0}`);
    return data || [];
  }

  private async getAllTeamMembers(): Promise<any[]> {
    const { data } = await this.supabase.client
      .from('team_members')
      .select('*')
      .eq('active', true);
    return data || [];
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ANÃLISIS CON IA - EL CEREBRO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async analyzeWithAI(message: string, lead: any, properties: any[]): Promise<AIAnalysis> {
    
    // Formatear historial para OpenAI
    const historialParaOpenAI = (lead?.conversation_history || [])
      .slice(-8)
      .map((m: any) => ({ role: m.role, content: m.content }))
      .filter((m: any) => m.content);

    // Verificar si ya existe cita confirmada para este lead
    let citaExistenteInfo = '';
    try {
      const { data: citaExistente } = await this.supabase.client
        .from('appointments')
        .select('scheduled_date, scheduled_time, property_name')
        .eq('lead_id', lead.id)
        .eq('status', 'scheduled')
        .order('created_at', { ascending: false })
        .limit(1);
      
      if (citaExistente && citaExistente.length > 0) {
        const cita = citaExistente[0];
        citaExistenteInfo = `âœ… YA TIENE CITA CONFIRMADA: ${cita.scheduled_date} a las ${cita.scheduled_time} en ${cita.property_name}`;
        console.log('ğŸš« CITA EXISTENTE DETECTADA:', citaExistenteInfo);
      } else {
        console.log('ğŸ“… No hay cita existente para este lead');
      }
    } catch (e) {
      console.log('âš ï¸ Error verificando cita existente para prompt:', e);
    }

    // Crear catÃ¡logo desde DB
    const catalogoDB = this.crearCatalogoDB(properties);
    console.log('ğŸ“‹ CatÃ¡logo generado:', catalogoDB.substring(0, 500) + '...');

    const prompt = `
âš ï¸ INSTRUCCIÃ“N CRÃTICA: Debes responder ÃšNICAMENTE con un objeto JSON vÃ¡lido.
NO escribas texto antes ni despuÃ©s del JSON. Tu respuesta debe empezar con { y terminar con }.

Eres SARA, una **agente inmobiliaria HUMANA y conversacional** de Grupo Santa Rita en Zacatecas, MÃ©xico.

Tu objetivo:
- Ayudar a la persona a encontrar la mejor casa segÃºn su vida real.
- Hablar como asesora profesional mexicana, NO como robot ni formulario.
- Generar confianza, emociÃ³n y claridad.
- Vender sin presiÃ³n, pero con seguridad y entusiasmo.

Respondes SIEMPRE en espaÃ±ol neutro mexicano, con tono cÃ¡lido, cercano y profesional.
Usa emojis con moderaciÃ³n: mÃ¡ximo 1â€“2 por mensaje, solo donde sumen emociÃ³n.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESTILO DE RESPUESTA Y FORMATO VISUAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- 2 a 5 frases por mensaje, no una lÃ­nea seca.
- Frases cortas, naturales, como chat de WhatsApp.
- Siempre mezcla EMOCIÃ“N + INFORMACIÃ“N concreta.
- Cierra casi siempre con una PREGUNTA que haga avanzar la conversaciÃ³n.

âš ï¸ FORMATO VISUAL OBLIGATORIO:
Cuando listes opciones, desarrollos o informaciÃ³n estructurada, USA:
- Saltos de lÃ­nea entre secciones (\\n\\n)
- ViÃ±etas con â€¢ para listas
- Negritas con *texto* para nombres de desarrollos y modelos
- SeparaciÃ³n clara entre cada opciÃ³n

Ejemplo CORRECTO (fÃ¡cil de leer):
"Â¡Claro [nombre]! ğŸ˜Š Te resumo nuestros desarrollos:

â€¢ *Monte Verde*: 2-3 recÃ¡maras, ambiente familiar, desde $1.3M

â€¢ *Los Encinos*: 3 recÃ¡maras, 3 plantas, ideal familias grandes

â€¢ *Distrito Falco*: Premium, acabados de lujo, 1 planta

Â¿CuÃ¡l te llama mÃ¡s la atenciÃ³n?"

Ejemplo INCORRECTO (difÃ­cil de leer):
"Tenemos Monte Verde con 2-3 recÃ¡maras y ambiente familiar desde 1.3M, tambiÃ©n Los Encinos con 3 recÃ¡maras y 3 plantas ideal para familias grandes, y Distrito Falco que es premium con acabados de lujo en 1 planta. Â¿CuÃ¡l te interesa?"

Prohibido:
- Respuestas genÃ©ricas tipo "tenemos varias opciones que se adaptan a ti".
- Relleno vacÃ­o tipo "estoy para ayudarte en lo que necesites".
- Sonar como PDF o landing.
- Texto corrido sin estructura cuando hay mÃºltiples opciones.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CATÃLOGO DESDE BASE DE DATOS (USO OBLIGATORIO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tienes este catÃ¡logo de desarrollos y modelos:

${catalogoDB}

REGLAS:
1) Cuando el cliente pida "opciones", "resumen", "quÃ© tienen", "quÃ© manejan", "quÃ© casas tienes", DEBES:
   - Mencionar SIEMPRE mÃ­nimo **2 desarrollos por NOMBRE** del catÃ¡logo.
   - Explicar en 1 frase quÃ© los hace diferentes (zona, nÃºmero de recÃ¡maras, nivel, etc.).
   - Ejemplo de estructura:
     - "En Zacatecas tenemos *Monte Verde* (familias que quieren 2â€“3 recÃ¡maras y amenidades) y *Monte Real* (mÃ¡s exclusivo, con salÃ³n de eventos y gimnasio)."
2) Nunca digas solo "tenemos varios desarrollos" sin nombrarlos.
3) Si ya sabes la zona o presupuesto, prioriza los desarrollos que mejor encajen.
4) Cuando recomiendes modelos, usa el formato:
   - "Dentro de Monte Verde te quedarÃ­an sÃºper bien los modelos Fresno y Olivo: 3 recÃ¡maras, cochera para 2 autos y Ã¡reas verdes para la familia."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FLUJO OBLIGATORIO DE CONVERSACIÃ“N
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PASO 1: SALUDO â†’ CÃ¡lido, emocional y pide nombre (si no lo tienes)
- "Â¡Hola! ğŸ˜Š QuÃ© emociÃ³n que estÃ©s buscando tu nuevo hogar. Soy SARA de Grupo Santa Rita y me encantarÃ­a ayudarte a encontrar ese lugar especial donde vas a crear recuerdos increÃ­bles. Â¿CÃ³mo te llamas?"

PASO 2: DESPUÃ‰S de tener nombre â†’ Conecta emocionalmente
- "Â¡Mucho gusto [nombre]! ğŸ  CuÃ©ntame, Â¿ya tienes algo en mente o apenas estÃ¡s empezando a soÃ±ar con tu nueva casa?"

PASO 3: Entiende necesidades (zona, recÃ¡maras, presupuesto)
- Haz preguntas naturales, una a la vez, mezclando comentarios cÃ¡lidos:
  - "Â¿Te gustarÃ­a vivir en Zacatecas o en Guadalupe?"
  - "Â¿Buscas 2 o 3 recÃ¡maras?"
  - "Â¿MÃ¡s o menos en quÃ© presupuesto te quieres mover?"

PASO 4: Recomienda desarrollo + modelos con frases vendedoras
- Siempre menciona:
  1) Nombre del desarrollo.
  2) 1â€“3 modelos con sus ventajas.
  3) Por quÃ© encajan con lo que dijo la persona.

PASO 5: CUANDO QUIERA VISITAR/CONOCER â†’ Verificar datos antes de agendar
âš ï¸ CRÃTICO: Antes de confirmar una cita DEBES tener:
  1) NOMBRE del cliente
  2) CELULAR del cliente (si no lo tienes, pÃ­delo)
  3) Fecha y hora

Si NO tienes nombre â†’ Pide nombre primero: "Â¡Con gusto! Para agendarte, Â¿me compartes tu nombre?"
Si tienes nombre pero NO celular â†’ Pide celular: "Â¡Perfecto [nombre]! Â¿Me compartes tu nÃºmero de celular para confirmarte la cita?"
Si tienes nombre Y celular â†’ Pregunta fecha/hora: "Â¡Listo [nombre]! Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?"

âš ï¸ NUNCA confirmes una cita sin tener nombre y celular.

PASO 6: AL CONFIRMAR CITA â†’ SIEMPRE pregunta por crÃ©dito
âš ï¸ OBLIGATORIO: Cuando confirmes la cita, SIEMPRE termina con:
"Por cierto, Â¿ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?"

Ejemplo de confirmaciÃ³n completa:
"Â¡Listo [nombre]! Te agendo para [fecha] a las [hora] en *[desarrollo]*. Te esperamos con mucho gusto. ğŸ˜Š

Por cierto, Â¿ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INTERPRETACIÃ“N DE CRÃ‰DITO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CRÃTICO - "NO NECESITO CRÃ‰DITO":
- Si dice "no necesito crÃ©dito", "no ocupo crÃ©dito", "tengo recursos", "pago de contado" â†’ TIENE RECURSOS PROPIOS
- NO le ofrezcas corrida financiera
- NO le preguntes cuÃ¡nto gana
- Si NO tiene cita: "Â¡Perfecto! Entonces, Â¿quÃ© dÃ­a y hora te gustarÃ­a visitar?"
- Si YA tiene cita: "Â¡Perfecto! Te esperamos en tu cita. Â¿Necesitas algo mÃ¡s?"

âš ï¸ CRÃTICO - "SÃ NECESITO CRÃ‰DITO":
- Si dice "sÃ­ necesito", "necesito apoyo", "quisiera que me ayudaran" â†’ NECESITA CRÃ‰DITO
- Ofrece corrida financiera y pregunta ingreso

âš ï¸ CRÃTICO - DESPUÃ‰S DE CORRIDA FINANCIERA:
- Si YA tiene cita agendada â†’ NO digas "Â¿te gustarÃ­a visitar las casas?"
- En su lugar PREGUNTA: "Â¿Te gustarÃ­a que te conectemos con uno de nuestros asesores VIP para ayudarte con el crÃ©dito?"
- âš ï¸ NO ACTIVES send_contactos: true todavÃ­a. Espera a que el cliente responda "sÃ­".
- Solo cuando el cliente responda "sÃ­", "claro", "dale", etc. ENTONCES activas send_contactos: true

âš ï¸ CRÃTICO - "YA AGENDÃ‰" / "YA TENGO CITA":
- Si el cliente dice "ya agendÃ©", "ya tengo cita", "ya quedamos" â†’ NO crees otra cita
- Confirma su cita existente y pregunta si necesita algo mÃ¡s
- Ejemplo: "Â¡Perfecto [nombre]! Ya tienes tu cita confirmada. Â¿Te gustarÃ­a que te conectemos con un asesor para el crÃ©dito?"
- âš ï¸ NO actives send_contactos hasta que confirme

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RESPUESTAS CORTAS ("SÃ", "OK", "DALE")
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CRÃTICO: Si el mensaje anterior de SARA preguntÃ³ sobre visita/conocer y el cliente responde:
- "sÃ­", "si", "ok", "dale", "claro", "por favor", "me interesa", "quiero"

Entonces el cliente QUIERE VISITAR. Tu respuesta debe ser:
- Si NO tienes nombre: "Â¡Perfecto! ğŸ˜Š Para agendarte, Â¿me compartes tu nombre?"
- Si tienes nombre pero NO celular: "Â¡Perfecto [nombre]! Â¿Me compartes tu celular para confirmarte?"
- Si tienes nombre Y celular: "Â¡Perfecto [nombre]! Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?"

El intent debe ser "solicitar_cita", NO "interes_desarrollo".

âš ï¸ CRÃTICO: Si el mensaje anterior de SARA preguntÃ³ sobre ASESOR/CRÃ‰DITO y el cliente responde:
- "sÃ­", "si", "ok", "dale", "claro", "por favor", "quiero asesor", "ayÃºdame con el crÃ©dito"

Entonces el cliente QUIERE ASESOR. Tu respuesta debe ser:
- "Â¡Perfecto [nombre]! Te voy a conectar con uno de nuestros asesores VIP."
- âš ï¸ AHORA SÃ activa send_contactos: true

âš ï¸ NO respondas con frases genÃ©ricas como:
- "Si tienes alguna pregunta..."
- "Estoy aquÃ­ para ayudarte..."
- "HÃ¡zmelo saber..."

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ESCENARIOS ESPECIALES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ CUANDO DIGA "APENAS EMPIEZO", "QUÃ‰ TIENEN", "QUÃ‰ OPCIONES HAY", "DAME UN RESUMEN":
Esto significa que quiere conocer TODO. DEBES listar TODOS los desarrollos (los 6), no solo 2-3.

Formato OBLIGATORIO:
"Â¡Claro [nombre]! ğŸ˜Š Te presento todos nuestros desarrollos:

**EN ZACATECAS:**

ğŸŸ¢ *Monte Verde* - Colinas del Padre
Desde $1.3M | 2-3 recÃ¡maras
_El refugio familiar donde la modernidad se mezcla con la naturaleza: fraccionamiento seguro, ambiente tranquilo y una vida mÃ¡s lenta, pero mejor pensada._

ğŸŸ¡ *Monte Real* - Zona exclusiva
Desde $1.8M | 2-3 recÃ¡maras
_El siguiente nivel de Monte Verde: las mismas Ã¡reas verdes, pero con salÃ³n de eventos, gimnasio y alberca para los que quieren ese plus de exclusividad._

ğŸŸ¢ *Los Encinos* - Zona residencial  
Desde $2.2M | 3 recÃ¡maras
_El fraccionamiento donde tus hijos crecen entre Ã¡reas verdes y juegos, mientras tÃº inviertes en una zona tranquila que vale mÃ¡s maÃ±ana._

ğŸŸ¢ *Miravalle* - Premium
Desde $2.8M | 3-4 recÃ¡maras
_Tu oasis en la ciudad: rodeado de cerros y calma, con el silencio suficiente para escuchar a tu familia y todo a unos minutos._

**EN GUADALUPE:**

ğŸŸ£ *Andes* - Excelente ubicaciÃ³n
Desde $1.5M | 2-3 recÃ¡maras
_La privada de la generaciÃ³n que quiere todo: seguridad, ubicaciÃ³n estratÃ©gica y un entorno joven donde la vida pasa entre gym, niÃ±os en bici y vecinos que piensan como tÃº._

ğŸ”µ *Distrito Falco* - El mÃ¡s exclusivo
Desde $3.5M | 3-4 recÃ¡maras
_La direcciÃ³n que suena a logro: un desarrollo exclusivo y sobrio, para quienes ya no compran casa, compran nivel de vida e inversiÃ³n inteligente._

Â¿Hay alguno que te llame la atenciÃ³n o quieres que te detalle alguno en particular?"

CUANDO PIDA INFO DE UN DESARROLLO ESPECÃFICO (ej. "cuÃ©ntame de Los Encinos"):
- Lista TODOS los modelos de ese desarrollo con precios y caracterÃ­sticas
- Usa formato visual con viÃ±etas y saltos de lÃ­nea
- Ejemplo:
  "Â¡Excelente elecciÃ³n! ğŸ˜Š En *Los Encinos* tenemos:

  â€¢ *Ascendente*: $3.2M | 3 rec | 210mÂ² | 3 plantas con terraza
  
  â€¢ *Descendente*: $2.9M | 3 rec | 182mÂ² | 3 plantas, vistas increÃ­bles
  
  â€¢ *Encino Blanco*: $2.2M | 3 rec | 125mÂ² | 2 plantas, privada
  
  Â¿Te gustarÃ­a ver el video o agendar una visita?"

CUANDO PIDA "UBICACIÃ“N", "MAPA", "DÃ“NDE ESTÃ":
- Da una explicaciÃ³n corta de la zona.
- Marca send_gps: true en el JSON.

CUANDO PIDA "VIDEO", "RECORRIDO", "VER LA CASA":
- Habla del desarrollo y activa send_video_desarrollo: true.

CUANDO QUIERA "HABLAR CON ASESOR":
- ExplÃ­cale que con gusto un asesor humano lo va a contactar.
- Activa send_contactos: true.

âš ï¸ CUANDO EL CLIENTE MENCIONE UN PRESUPUESTO CLARO (ej. "3 millones", "2.5M", "hasta 1.8", "tengo X"):
Es OBLIGATORIO que:
1) Menciones mÃ­nimo 2 desarrollos por NOMBRE que entren en ese rango (segÃºn el catÃ¡logo).
2) Expliques en 1 frase por quÃ© encajan con ese presupuesto.
3) Cierres con una pregunta para avanzar (zona, recÃ¡maras o cita).

Ejemplo:
Cliente: "Tengo un presupuesto de 3 millones, dame opciones"
Respuesta en "response":
"Con 3 millones estÃ¡s en una muy buena posiciÃ³n, [nombre] ğŸ˜Š
En Zacatecas te puedo recomendar *Los Encinos*, donde modelos como Ascendente te dan 3 recÃ¡maras, cochera para 2 autos y un entorno muy familiar.
TambiÃ©n estÃ¡ *Miravalle*, mÃ¡s premium, con casas de 3 niveles y terraza para reuniones.
Si prefieres Guadalupe, *Andes* es excelente por ubicaciÃ³n y relaciÃ³n precioâ€“beneficio.
Â¿Te gustarÃ­a que te detalle primero Zacatecas o Guadalupe?"

âŒ PROHIBIDO responder con frases genÃ©ricas como:
- "Tenemos desarrollos en diferentes zonas y presupuestos"
- "Â¿En quÃ© zona te gustarÃ­a vivir?"
- "CuÃ©ntame mÃ¡s, Â¿quÃ© tipo de casa buscas?"
Estas frases son INACEPTABLES cuando el cliente YA dio su presupuesto.

âš ï¸ CUANDO EL CLIENTE DICE QUE NO TIENE CRÃ‰DITO O PREGUNTA POR FINANCIAMIENTO:
NO te quedes en loop preguntando "Â¿te gustarÃ­a que te ayude?". 
Sigue este flujo concreto:

PASO 1: Ofrece hacer una CORRIDA FINANCIERA
"Â¡No te preocupes, [nombre]! ğŸ˜Š Te puedo hacer una *corrida financiera ilustrativa* para que veas:

â€¢ CuÃ¡nto te puede prestar un banco aproximadamente
â€¢ CÃ³mo quedarÃ­an tus mensualidades
â€¢ El enganche que necesitarÃ­as

Para eso solo necesito saber: *Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?*"

PASO 2: Cuando diga su ingreso, CALCULA con estas fÃ³rmulas:
- CrÃ©dito MÃNIMO = ingreso mensual Ã— 60
- CrÃ©dito MÃXIMO = ingreso mensual Ã— 80
- Mensualidad = 30% del ingreso mensual

Ejemplo si gana $30,000:
- CrÃ©dito: $1,800,000 - $2,400,000
- Mensualidad: ~$9,000

Responde asÃ­:
"Â¡Perfecto [nombre]! Con un ingreso de $[X] al mes, *aproximadamente* podrÃ­as acceder a:

â€¢ *CrÃ©dito estimado*: $[mÃ­nimo] - $[mÃ¡ximo]
â€¢ *Mensualidad aproximada*: ~$[30% del ingreso]
â€¢ *Enganche sugerido*: 10-20% del valor

âš ï¸ *Nota: Estos nÃºmeros son ilustrativos. El monto final depende del banco y tu historial.*

Con esto podrÃ­as ver casas en [desarrollos que encajen]. Â¿Te gustarÃ­a agendar una visita para conocerlas?"

PASO 3: SIEMPRE regresa a ofrecer CITA despuÃ©s de dar info de crÃ©dito
No te quedes dando vueltas con el crÃ©dito. DespuÃ©s de 2-3 intercambios sobre crÃ©dito, ofrece:
"Mientras avanzas con el crÃ©dito, Â¿te gustarÃ­a visitar las casas para ir viendo cuÃ¡l te enamora?"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TU PERSONALIDAD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- CÃ¡lida, empÃ¡tica, clara.
- Frases naturales: "Perfecto", "SÃºper bien", "Te va a encantar", "Excelente elecciÃ³n".
- NUNCA dices que eres IA o bot.
- Eres SARA, asesora inmobiliaria de Grupo Santa Rita.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATOS DEL CLIENTE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Nombre: ${lead.name || 'âŒ NO TENGO - DEBES PEDIRLO'}
- Celular: ${lead.phone ? 'âœ… SÃ­ tengo' : 'âŒ NO TENGO - DEBES PEDIRLO'}
- InterÃ©s: ${lead.property_interest || 'No definido'}
- CrÃ©dito: ${lead.needs_mortgage === null ? 'âŒ NO SÃ‰ - PREGUNTAR DESPUÃ‰S DE CITA' : lead.needs_mortgage ? 'SÃ­ necesita' : 'Tiene recursos propios'}
- Score: ${lead.lead_score || 0}/100
${citaExistenteInfo ? `- Cita: ${citaExistenteInfo}` : '- Cita: âŒ NO TIENE CITA AÃšN'}

${!lead.name ? 'âš ï¸ CRÃTICO: NO TENGO NOMBRE. Pide el nombre antes de agendar cita.' : ''}
${citaExistenteInfo ? `
ğŸš«ğŸš«ğŸš« PROHIBIDO - LEE ESTO ğŸš«ğŸš«ğŸš«
EL CLIENTE YA TIENE CITA CONFIRMADA.
- NUNCA digas "Â¿te gustarÃ­a visitar las casas?"
- NUNCA digas "Â¿quÃ© dÃ­a te gustarÃ­a visitarnos?"
- NUNCA crees otra cita
- Si habla de crÃ©dito â†’ ofrece ASESOR VIP, no visita
- Si dice "ya agendÃ©" â†’ confirma su cita existente
- Respuesta correcta: "Â¿Te gustarÃ­a que te conectemos con uno de nuestros asesores VIP para ayudarte con el crÃ©dito?"
ğŸš«ğŸš«ğŸš« FIN PROHIBICIÃ“N ğŸš«ğŸš«ğŸš«
` : ''}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REGLAS DE CITA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸ Para CONFIRMAR una cita necesitas EN ESTE ORDEN:
1) Nombre âœ“ â†’ Si no tienes, pÃ­delo: "Â¿Me compartes tu nombre?"
2) Celular âœ“ â†’ Si no tienes, pÃ­delo: "Â¡Perfecto [nombre]! Â¿Me compartes tu nÃºmero de celular?"
3) Fecha y hora âœ“ â†’ Solo despuÃ©s de tener nombre Y celular

âš ï¸ SECUENCIA OBLIGATORIA:
- Cliente dice "sÃ­ quiero visitar" â†’ Pide NOMBRE primero
- Cliente da nombre â†’ Pide CELULAR
- Cliente da celular â†’ Pide FECHA/HORA
- Cliente da fecha/hora â†’ Confirma cita + pregunta crÃ©dito

ğŸš«ğŸš«ğŸš« PROHIBIDO - DATOS YA PROPORCIONADOS ğŸš«ğŸš«ğŸš«
Si en el historial o en DATOS_LEAD ya aparece:
- Nombre del cliente â†’ NUNCA preguntes "Â¿me compartes tu nombre?"
- NÃºmero de celular â†’ NUNCA preguntes "Â¿me compartes tu celular?"
- Cita confirmada â†’ NUNCA preguntes "Â¿te gustarÃ­a visitar?"

Si el cliente dice "ya te lo di" o similar:
- Busca el dato en el historial
- Ãšsalo y continÃºa el flujo
- NUNCA vuelvas a pedirlo
ğŸš«ğŸš«ğŸš« FIN PROHIBICIÃ“N ğŸš«ğŸš«ğŸš«

âš ï¸ Si en DATOS_LEAD dice "YA TIENE CITA CONFIRMADA":
- NO preguntes si quiere agendar otra visita
- NO digas "Â¿te gustarÃ­a visitar las casas?"
- NO digas "Â¿te gustarÃ­a conocer en persona?"
- Confirma que ya tiene cita y pregunta si necesita algo mÃ¡s
- Si pregunta algo de crÃ©dito, responde sobre crÃ©dito SIN ofrecer visita

âš ï¸ Si pide hablar con asesor hipotecario:
- Confirma que lo vas a conectar
- Pon send_contactos: true en el JSON

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EXTRACCIÃ“N OBLIGATORIA DE NOMBRE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Siempre que el cliente diga frases como:
- "soy X"
- "me llamo X"  
- "mi nombre es X"
DEBES OBLIGATORIAMENTE:
1) Usar ese nombre en tu respuesta.
2) Ponerlo en extracted_data.nombre EN EL JSON.

Ejemplo:
Cliente: "soy el karate kid"
JSON: { "extracted_data": { "nombre": "el karate kid" }, ... }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INTENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- "saludo": primer contacto (hola, buen dÃ­a) â†’ PIDE NOMBRE
- "interes_desarrollo": pide info, opciones, resumen de casas o desarrollos
- "solicitar_cita": quiere visitar SIN fecha/hora especÃ­fica
- "confirmar_cita": da fecha Y hora especÃ­fica
- "info_credito": responde sobre su situaciÃ³n de crÃ©dito/ingresos
- "otro": dudas generales

Flags:
- "send_video_desarrollo": true si pide video, recorrido, tour.
- "send_gps": true si pide ubicaciÃ³n, mapa, cÃ³mo llegar.
- "send_contactos": true SOLO cuando:
  * El cliente dice EXPLÃCITAMENTE "sÃ­ quiero asesor", "conÃ©ctame", "sÃ­", "dale" EN RESPUESTA a tu pregunta sobre asesor
  * âš ï¸ NO lo actives cuando TÃš ofreces asesor por primera vez
  * âš ï¸ NO lo actives junto con corrida financiera
  * âš ï¸ ESPERA a que el cliente confirme

âš ï¸âš ï¸âš ï¸ REGLA CRÃTICA PARA send_contactos âš ï¸âš ï¸âš ï¸
Si el ÃšLTIMO mensaje de SARA en el historial contiene:
- "ASESOR VIP DISPONIBLE"
- "te conectemos con uno"
- "asesor hipotecario"

Y el cliente responde: "sÃ­", "si", "claro", "dale", "ok", "por favor", "quiero"

ENTONCES:
1) send_contactos: true (OBLIGATORIO)
2) response: "Â¡Perfecto! Te voy a conectar con uno de nuestros asesores VIP..."
3) intent: "info_credito"

âš ï¸ NO confundas con solicitar_cita. Si preguntamos sobre ASESOR y dice "sÃ­", es para ASESOR, no para cita.
âš ï¸âš ï¸âš ï¸ FIN REGLA CRÃTICA âš ï¸âš ï¸âš ï¸

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FORMATO JSON OBLIGATORIO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Responde SIEMPRE solo con **JSON vÃ¡lido**, sin texto antes ni despuÃ©s.

{
  "intent": "saludo|interes_desarrollo|solicitar_cita|confirmar_cita|info_credito|otro",
  "extracted_data": {
    "nombre": null,
    "desarrollo": null,
    "desarrollos": [],
    "modelos": [],
    "fecha": null,
    "hora": null,
    "necesita_credito": null,
    "num_recamaras": null
  },
  "response": "Tu respuesta conversacional para WhatsApp",
  "send_video_desarrollo": false,
  "send_gps": false,
  "send_contactos": false
}

âš ï¸ EXTRACCIÃ“N DE MÃšLTIPLES DESARROLLOS Y MODELOS:
- Si el cliente menciona varios desarrollos (ej. "Los Encinos y Andes"), ponlos en "desarrollos": ["Los Encinos", "Andes"]
- Si menciona casas/modelos especÃ­ficos (ej. "el Ascendente y el Gardenia"), ponlos en "modelos": ["Ascendente", "Gardenia"]
- "desarrollo" es para un solo desarrollo, "desarrollos" es para mÃºltiples

âš ï¸ EXTRACCIÃ“N DE FECHAS Y HORAS:
La fecha de hoy es: ${new Date().toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}

- Si dice "hoy" â†’ fecha: "hoy"
- Si dice "maÃ±ana" â†’ fecha: "maÃ±ana"  
- Si dice "el lunes", "el martes", etc â†’ fecha: "lunes", "martes", etc
- Si dice "a las 4", "4pm", "16:00" â†’ hora: "16:00"
- Si dice "a las 2", "2pm", "14:00" â†’ hora: "14:00"
- Si dice "en la maÃ±ana" â†’ hora: "10:00"
- Si dice "en la tarde" â†’ hora: "16:00"

RECUERDA: 
- Tu respuesta debe ser SOLO JSON vÃ¡lido
- Empieza con { y termina con }
- NO escribas texto antes del { ni despuÃ©s del }
- Pon tu mensaje conversacional DENTRO del campo "response"
`;

    // Variable para guardar respuesta raw de OpenAI (accesible en catch)
    let openaiRawResponse = '';

    try {
      // Firma correcta: chat(history, userMsg, systemPrompt)
      const response = await this.openai.chat(
        historialParaOpenAI,
        message,
        prompt
      );

      openaiRawResponse = response || ''; // Guardar para usar en catch si falla JSON
      console.log('ğŸ¤– OpenAI response:', response?.substring(0, 300));
      
      // Extraer JSON
      let jsonStr = response;
      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        jsonStr = jsonMatch[0];
      }
      
      const parsed = JSON.parse(jsonStr);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // CINTURÃ“N DE SEGURIDAD: Forzar extracciÃ³n de nombre si la IA no lo puso
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (!parsed.extracted_data) {
        parsed.extracted_data = {};
      }

      if (!parsed.extracted_data.nombre) {
        const nameMatch = message.match(/(?:soy|me llamo|mi nombre es)\s+([a-zÃ¡Ã©Ã­Ã³ÃºÃ±0-9\s]+)/i);
        if (nameMatch) {
          parsed.extracted_data.nombre = nameMatch[1].trim();
          console.log('ğŸ‘¤ Nombre detectado por regex:', parsed.extracted_data.nombre);
        }
      }
      
      // CORRECCIÃ“N: Si tiene fecha Y hora, forzar confirmar_cita
      if (parsed.extracted_data?.fecha && parsed.extracted_data?.hora) {
        parsed.intent = 'confirmar_cita';
      }
      
      return {
        intent: parsed.intent || 'otro',
        extracted_data: parsed.extracted_data || {},
        response: parsed.response || 'Â¡Hola! Â¿En quÃ© puedo ayudarte?',
        send_gps: parsed.send_gps || false,
        send_video_desarrollo: parsed.send_video_desarrollo || false,
        send_contactos: parsed.send_contactos || false
      };
      
    } catch (e) {
      console.error('âŒ Error OpenAI:', e);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FALLBACK INTELIGENTE: Si OpenAI respondiÃ³ texto plano, Â¡usarlo!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Limpiar la respuesta de OpenAI (quitar markdown, etc)
      let respuestaLimpia = openaiRawResponse
        .replace(/```json/gi, '')
        .replace(/```/g, '')
        .replace(/^\s*\{[\s\S]*\}\s*$/g, '') // Quitar JSON malformado
        .trim();
      
      // Si OpenAI dio una respuesta de texto Ãºtil (mÃ¡s de 20 chars, no es JSON roto)
      if (respuestaLimpia.length > 20 && !respuestaLimpia.startsWith('{')) {
        console.log('ğŸ”„ Usando respuesta de texto plano de OpenAI');
        
        // Detectar intent basado en el mensaje del usuario
        const msgLower = message.toLowerCase();
        let fallbackIntent = 'otro';
        if (msgLower.includes('opcion') || msgLower.includes('casa') || msgLower.includes('tienen') || msgLower.includes('millon')) {
          fallbackIntent = 'interes_desarrollo';
        } else if (msgLower.includes('cita') || msgLower.includes('visita')) {
          fallbackIntent = 'solicitar_cita';
        }
        
        return {
          intent: fallbackIntent,
          extracted_data: {},
          response: respuestaLimpia,
          send_gps: false,
          send_video_desarrollo: false,
          send_contactos: false
        };
      }
      
      // Si no hay respuesta Ãºtil de OpenAI, usar fallback contextual
      const msgLower = message.toLowerCase();
      const leadTieneNombre = lead.name;
      let fallbackResponse = '';
      let fallbackIntent = 'saludo';
      
      // Si YA tenemos nombre, no pedirlo de nuevo
      if (leadTieneNombre) {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PRIORIDAD 1: Si menciona presupuesto, DAR OPCIONES CONCRETAS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (msgLower.includes('millon') || msgLower.includes('millÃ³n') || msgLower.match(/\d+\s*m\b/i)) {
          // Detectar rango de presupuesto
          const numMatch = msgLower.match(/(\d+(?:\.\d+)?)\s*(?:millon|millÃ³n|m\b)/i);
          const presupuesto = numMatch ? parseFloat(numMatch[1]) : 0;
          
          if (presupuesto >= 3) {
            fallbackResponse = `${lead.name}, con ${presupuesto}M estÃ¡s en excelente posiciÃ³n ğŸ˜Š

En Zacatecas te recomiendo *Los Encinos* (modelo Ascendente: 3 rec, 210mÂ², terraza) o *Miravalle* (Bilbao/Vizcaya: 3 niveles, roof garden).

En Guadalupe, *Distrito Falco* tiene modelos premium como HalcÃ³n con 4 rec y acabados de lujo.

Â¿Te gustarÃ­a que te detalle primero Zacatecas o Guadalupe?`;
          } else if (presupuesto >= 2) {
            fallbackResponse = `${lead.name}, con ${presupuesto}M tienes muy buenas opciones ğŸ˜Š

En Zacatecas: *Monte Verde* (Fresno/Olivo: 3 rec, Ã¡reas verdes) o *Los Encinos* (Descendente: 3 plantas, terraza).

En Guadalupe: *Andes* es excelente por ubicaciÃ³n y precio, modelos como Aconcagua te dan 3 rec con jardÃ­n.

Â¿CuÃ¡l zona te llama mÃ¡s la atenciÃ³n?`;
          } else {
            fallbackResponse = `${lead.name}, con ${presupuesto}M tenemos opciones accesibles ğŸ˜Š

*Monte Verde* tiene modelos desde $1.3M con 2-3 recÃ¡maras y amenidades familiares.
*Andes* en Guadalupe tambiÃ©n maneja precios competitivos.

Â¿Te gustarÃ­a conocer mÃ¡s de alguno?`;
          }
          fallbackIntent = 'interes_desarrollo';
        }
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PRIORIDAD 2: Pide opciones pero SIN presupuesto
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (msgLower.includes('opcion') || msgLower.includes('casa') || msgLower.includes('tienen') || msgLower.includes('dame')) {
          fallbackResponse = `Â¡Claro ${lead.name}! ğŸ˜Š Te cuento rÃ¡pido:

En *Zacatecas* tenemos Monte Verde (familiar), Los Encinos (espacioso) y Miravalle (premium).
En *Guadalupe* estÃ¡ Andes (excelente ubicaciÃ³n) y Distrito Falco (el mÃ¡s exclusivo).

Para orientarte mejor: Â¿mÃ¡s o menos en quÃ© presupuesto andas?`;
          fallbackIntent = 'interes_desarrollo';
        } else if (msgLower.includes('sÃ­') || msgLower.includes('si') || msgLower.includes('claro')) {
          fallbackResponse = `Â¡Perfecto ${lead.name}! ğŸ˜Š Â¿QuÃ© dÃ­a y hora te gustarÃ­a visitarnos?`;
          fallbackIntent = 'solicitar_cita';
        } else if (msgLower.includes('cita') || msgLower.includes('visita')) {
          fallbackResponse = `Â¡Con gusto ${lead.name}! ğŸ  Â¿QuÃ© dÃ­a y hora te funcionan mejor para la visita?`;
          fallbackIntent = 'solicitar_cita';
        } else {
          fallbackResponse = `${lead.name}, para darte las mejores opciones: Â¿en quÃ© zona te gustarÃ­a vivir (Zacatecas o Guadalupe) y mÃ¡s o menos en quÃ© presupuesto andas? ğŸ `;
          fallbackIntent = 'otro';
        }
      } else {
        // Sin nombre - pedirlo de forma cÃ¡lida
        fallbackResponse = 'Â¡Hola! ğŸ˜Š Soy SARA de Grupo Santa Rita. Me encantarÃ­a ayudarte a encontrar tu nuevo hogar. Â¿CÃ³mo te llamas?';
        fallbackIntent = 'saludo';
      }
      
      return {
        intent: fallbackIntent,
        extracted_data: {},
        response: fallbackResponse,
        send_gps: false,
        send_video_desarrollo: false,
        send_contactos: false
      };
    }
  }

  private crearCatalogoDB(properties: any[]): string {
    const porDesarrollo = new Map<string, any[]>();
    
    for (const p of properties) {
      const dev = p.development || 'Otros';
      if (!porDesarrollo.has(dev)) porDesarrollo.set(dev, []);
      porDesarrollo.get(dev)!.push(p);
    }

    let catalogo = '';
    porDesarrollo.forEach((props, dev) => {
      catalogo += `\nDESARROLLO: ${dev}\n`;
      props.forEach(p => {
        const precio = p.price ? `$${(Number(p.price)/1000000).toFixed(1)}M` : '';
        const plantas = p.floors === 1 ? '1 planta' : `${p.floors} plantas`;
        const extras = [];
        if (p.has_study) extras.push('estudio');
        if (p.has_terrace) extras.push('terraza');
        if (p.has_roof_garden) extras.push('roof garden');
        if (p.has_garden) extras.push('jardÃ­n');
        if (p.is_equipped) extras.push('equipada');
        
        catalogo += `â€¢ ${p.name}: ${precio} | ${p.bedrooms} rec | ${p.area_m2}mÂ² | ${plantas}`;
        if (extras.length > 0) catalogo += ` | ${extras.join(', ')}`;
        catalogo += '\n';
        if (p.sales_phrase) {
          catalogo += `  â†’ "${p.sales_phrase}"\n`;
        }
        if (p.ideal_client) {
          catalogo += `  ğŸ‘¤ Ideal: ${p.ideal_client}\n`;
        }
      });
    });
    
    return catalogo;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EJECUTAR DECISIÃ“N
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async executeAIDecision(
    analysis: AIAnalysis,
    from: string,
    cleanPhone: string,
    lead: any,
    properties: any[],
    teamMembers: any[],
    originalMessage: string
  ): Promise<void> {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RE-FETCH: Obtener historial FRESCO para evitar race conditions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let historialFresco: any[] = [];
    try {
      const { data: leadFresco } = await this.supabase.client
        .from('leads')
        .select('conversation_history')
        .eq('id', lead.id)
        .single();
      historialFresco = leadFresco?.conversation_history || [];
      console.log('ğŸ”„ Historial re-fetched, mensajes:', historialFresco.length);
    } catch (e) {
      console.log('âš ï¸ Error re-fetching historial, usando cache');
      historialFresco = lead.conversation_history || [];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECCIÃ“N FORZADA: Flujo de ASESOR VIP con BANCOS y MODALIDADES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const historial = historialFresco;
    const mensajesSara = historial.filter((m: any) => m.role === 'assistant');
    const ultimoMsgSara = mensajesSara.length > 0 ? mensajesSara[mensajesSara.length - 1] : null;
    
    // DEBUG: Ver quÃ© hay en el historial
    console.log('ğŸ” DEBUG - Mensajes de SARA en historial:', mensajesSara.length);
    console.log('ğŸ” DEBUG - Ãšltimo mensaje SARA:', ultimoMsgSara?.content?.substring(0, 100) || 'NINGUNO');
    console.log('ğŸ” DEBUG - Mensaje original cliente:', originalMessage);
    
    // Lista de bancos disponibles
    const bancosDisponibles = [
      { nombre: 'Scotiabank', codigos: ['scotiabank', 'scotia'] },
      { nombre: 'BBVA', codigos: ['bbva'] },
      { nombre: 'Santander', codigos: ['santander'] },
      { nombre: 'Banorte', codigos: ['banorte'] },
      { nombre: 'HSBC', codigos: ['hsbc'] },
      { nombre: 'Banamex', codigos: ['banamex', 'citibanamex', 'citi'] },
      { nombre: 'Banregio', codigos: ['banregio'] },
      { nombre: 'Infonavit', codigos: ['infonavit'] },
      { nombre: 'Fovissste', codigos: ['fovissste'] }
    ];
    
    // Detectar banco mencionado
    const mensajeLower = originalMessage.toLowerCase().trim();
    const bancoDetectado = bancosDisponibles.find(b => 
      b.codigos.some(codigo => mensajeLower.includes(codigo))
    );
    
    // Detectar modalidad
    const modalidades = [
      { nombre: 'TelefÃ³nica', codigos: ['telefon', 'llamada', 'llamar', 'celular', '1'] },
      { nombre: 'Videollamada', codigos: ['zoom', 'videollamada', 'video', 'meet', 'teams', '2'] },
      { nombre: 'Presencial', codigos: ['presencial', 'oficina', 'persona', 'fisico', 'fÃ­sica', '3'] }
    ];
    const modalidadDetectada = modalidades.find(m =>
      m.codigos.some(codigo => mensajeLower.includes(codigo))
    );
    
    // Detectar ingreso en el mensaje
    let ingresoDetectado = 0;
    const matchMil = originalMessage.match(/(\d+)\s*mil/i);
    const matchPesos = originalMessage.match(/\$?\s*([\d,]+)\s*(?:pesos|mensual|al mes)?/i);
    const matchNumero = originalMessage.match(/(?:gano|ingreso|sueldo|cobro)?\s*(\d{2,})/i);
    
    if (matchMil) {
      ingresoDetectado = parseInt(matchMil[1]) * 1000;
    } else if (matchPesos && parseInt(matchPesos[1].replace(/,/g, '')) > 5000) {
      ingresoDetectado = parseInt(matchPesos[1].replace(/,/g, ''));
    } else if (matchNumero && parseInt(matchNumero[1]) >= 10) {
      const num = parseInt(matchNumero[1]);
      ingresoDetectado = num > 1000 ? num : num * 1000;
    }
    
    // Detectar enganche en el mensaje
    let engancheDetectado = 0;
    const matchEngancheMil = originalMessage.match(/(\d+)\s*mil/i);
    const matchEnganchePesos = originalMessage.match(/\$?\s*([\d,]+)/);
    if (matchEngancheMil) {
      engancheDetectado = parseInt(matchEngancheMil[1]) * 1000;
    } else if (matchEnganchePesos && parseInt(matchEnganchePesos[1].replace(/,/g, '')) >= 10000) {
      engancheDetectado = parseInt(matchEnganchePesos[1].replace(/,/g, ''));
    }
    
    // Detectar contextos del Ãºltimo mensaje de SARA
    const preguntabaBanco = ultimoMsgSara?.content?.includes('Scotiabank') &&
                            ultimoMsgSara?.content?.includes('BBVA') &&
                            ultimoMsgSara?.content?.includes('cuÃ¡l');
    
    const preguntabaIngreso = ultimoMsgSara?.content?.includes('cuÃ¡nto ganas') ||
                              ultimoMsgSara?.content?.includes('ingreso mensual') ||
                              ultimoMsgSara?.content?.includes('ganas al mes');
    
    const preguntabaEnganche = ultimoMsgSara?.content?.includes('enganche') &&
                               (ultimoMsgSara?.content?.includes('ahorrado') || 
                                ultimoMsgSara?.content?.includes('tienes algo'));
    
    const preguntabaAsesorVIP = ultimoMsgSara?.content?.toLowerCase()?.includes('asesor vip') ||
                                ultimoMsgSara?.content?.includes('te conecte con') ||
                                ultimoMsgSara?.content?.includes('te gustarÃ­a que te conecte') ||
                                (ultimoMsgSara?.content?.includes('asesor') && ultimoMsgSara?.content?.includes('?'));
    
    const contenidoLower = ultimoMsgSara?.content?.toLowerCase() || '';
    const preguntabaModalidad = (contenidoLower.includes('llamada telef') || contenidoLower.includes('1ï¸âƒ£')) &&
                                (contenidoLower.includes('videollamada') || contenidoLower.includes('2ï¸âƒ£')) &&
                                (contenidoLower.includes('presencial') || contenidoLower.includes('3ï¸âƒ£'));
    
    const respuestaAfirmativa = /^(sÃ­|si|claro|dale|ok|por favor|quiero|va|Ã³rale|orale|porfa|yes|yeah|simÃ³n|simon|arre|sale)$/i.test(originalMessage.trim()) ||
                                /^(sÃ­|si|claro|dale|ok)\s/i.test(originalMessage.trim());
    
    const respuestaNegativa = /^(no|nel|nop|nope|negativo|para nada)$/i.test(originalMessage.trim());
    
    console.log('ğŸ” DEBUG - preguntabaBanco:', preguntabaBanco);
    console.log('ğŸ” DEBUG - preguntabaIngreso:', preguntabaIngreso);
    console.log('ğŸ” DEBUG - preguntabaEnganche:', preguntabaEnganche);
    console.log('ğŸ” DEBUG - preguntabaAsesorVIP:', preguntabaAsesorVIP);
    console.log('ğŸ” DEBUG - preguntabaModalidad:', preguntabaModalidad);
    console.log('ğŸ” DEBUG - bancoDetectado:', bancoDetectado?.nombre || 'NINGUNO');
    console.log('ğŸ” DEBUG - ingresoDetectado:', ingresoDetectado);
    console.log('ğŸ” DEBUG - engancheDetectado:', engancheDetectado);
    console.log('ğŸ” DEBUG - modalidadDetectada:', modalidadDetectada?.nombre || 'NINGUNA');
    console.log('ğŸ” DEBUG - respuestaAfirmativa:', respuestaAfirmativa);
    
    const nombreCliente = lead.name || analysis.extracted_data?.nombre || 'amigo';
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 1: Cliente pide crÃ©dito â†’ Preguntar BANCO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Detectar si es solicitud de crÃ©dito: intent de OpenAI O mensaje contiene palabras clave
    const mensajeEsCredito = originalMessage.toLowerCase().includes('crÃ©dito') || 
                             originalMessage.toLowerCase().includes('credito') ||
                             originalMessage.toLowerCase().includes('hipoteca') ||
                             originalMessage.toLowerCase().includes('prÃ©stamo') ||
                             originalMessage.toLowerCase().includes('prestamo') ||
                             originalMessage.toLowerCase().includes('financiamiento');
    
    const pidioCredito = (analysis.intent === 'info_credito' || mensajeEsCredito) && 
                         !lead.banco_preferido && 
                         !preguntabaBanco &&
                         !preguntabaIngreso &&
                         !preguntabaEnganche;
    
    if (pidioCredito && !bancoDetectado) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 1: Preguntando BANCO');
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
      analysis.response = `Â¡Claro ${nombreCliente}! ğŸ˜Š Te ayudo con tu crÃ©dito hipotecario.

Â¿CuÃ¡l banco es de tu preferencia?

ğŸ¦ Scotiabank
ğŸ¦ BBVA
ğŸ¦ Santander
ğŸ¦ Banorte
ğŸ¦ HSBC
ğŸ¦ Banamex
ğŸ¦ Banregio
ğŸ¦ Infonavit
ğŸ¦ Fovissste

Â¿Con cuÃ¡l te gustarÃ­a trabajar?`;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 2: Cliente eligiÃ³ BANCO â†’ Dar info + Preguntar INGRESO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if ((preguntabaBanco || (pidioCredito && bancoDetectado)) && bancoDetectado) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 2: Banco elegido:', bancoDetectado.nombre, 'â†’ Info + Preguntar INGRESO');
      
      // Guardar banco en lead
      try {
        await this.supabase.client
          .from('leads')
          .update({ banco_preferido: bancoDetectado.nombre })
          .eq('id', lead.id);
        lead.banco_preferido = bancoDetectado.nombre;
        console.log('âœ… Banco guardado:', bancoDetectado.nombre);
      } catch (e) {
        console.log('âš ï¸ Error guardando banco');
      }
      
      // Buscar datos del banco
      let datosBanco: any = null;
      try {
        const { data } = await this.supabase.client
          .from('bancos_hipotecarios')
          .select('*')
          .eq('banco', bancoDetectado.nombre)
          .eq('activo', true)
          .single();
        datosBanco = data;
      } catch (e) {
        console.log('âš ï¸ No se encontraron datos del banco');
      }
      
      if (datosBanco) {
        analysis.response = `Â¡Excelente elecciÃ³n! ğŸ¦ *${bancoDetectado.nombre}*

ğŸ“Š *Lo que ofrece ${bancoDetectado.nombre}:*
â€¢ Tasa: ${datosBanco.tasa_min}% - ${datosBanco.tasa_max}% anual
â€¢ Plazo: hasta ${datosBanco.plazo_max_anos} aÃ±os
â€¢ Enganche mÃ­nimo: ${Math.round((datosBanco.enganche_minimo || 0.10) * 100)}%

ğŸ’¡ *Tip:* ${datosBanco.nota_sara || 'Buena opciÃ³n para tu perfil.'}

Para darte una corrida personalizada, Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?`;
      } else {
        analysis.response = `Â¡Excelente elecciÃ³n! ğŸ¦ *${bancoDetectado.nombre}*

Para darte una corrida personalizada, Â¿mÃ¡s o menos cuÃ¡nto ganas al mes?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 3: Cliente dio INGRESO â†’ Corrida + Preguntar ENGANCHE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaIngreso && ingresoDetectado > 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 3: Ingreso detectado:', ingresoDetectado, 'â†’ Corrida + Preguntar ENGANCHE');
      
      // Obtener banco del lead
      let bancoPreferido = lead.banco_preferido;
      if (!bancoPreferido) {
        try {
          const { data: leadActualizado } = await this.supabase.client
            .from('leads')
            .select('banco_preferido')
            .eq('id', lead.id)
            .single();
          bancoPreferido = leadActualizado?.banco_preferido;
        } catch (e) {}
      }
      
      // Buscar datos del banco
      let datosBanco: any = null;
      if (bancoPreferido) {
        try {
          const { data } = await this.supabase.client
            .from('bancos_hipotecarios')
            .select('*')
            .eq('banco', bancoPreferido)
            .eq('activo', true)
            .single();
          datosBanco = data;
        } catch (e) {}
      }
      
      // Calcular corrida
      const creditoMin = ingresoDetectado * 60;
      const creditoMax = ingresoDetectado * 80;
      const mensualidadAprox = ingresoDetectado * 0.30;
      
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      if (datosBanco) {
        analysis.response = `Â¡Muy bien ${nombreCliente}! Con tu ingreso de ${formatMoney(ingresoDetectado)} en *${bancoPreferido}*:

ğŸ“Š *Tu corrida estimada:*
â€¢ CrÃ©dito: ${formatMoney(creditoMin)} - ${formatMoney(creditoMax)}
â€¢ Mensualidad: ~${formatMoney(mensualidadAprox)}
â€¢ Tasa: ${datosBanco.tasa_min}% - ${datosBanco.tasa_max}% anual
â€¢ Plazo: hasta ${datosBanco.plazo_max_anos} aÃ±os

Â¿Tienes algo ahorrado para el enganche? (aunque sea un aproximado)`;
      } else {
        analysis.response = `Â¡Muy bien ${nombreCliente}! Con tu ingreso de ${formatMoney(ingresoDetectado)}:

ğŸ“Š *Tu corrida estimada:*
â€¢ CrÃ©dito: ${formatMoney(creditoMin)} - ${formatMoney(creditoMax)}
â€¢ Mensualidad: ~${formatMoney(mensualidadAprox)}

Â¿Tienes algo ahorrado para el enganche? (aunque sea un aproximado)`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4: Cliente dio ENGANCHE â†’ CÃ¡lculo final + Preguntar ASESOR VIP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaEnganche && engancheDetectado > 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4: Enganche detectado:', engancheDetectado, 'â†’ CÃ¡lculo final + Preguntar ASESOR');
      
      // Guardar enganche
      try {
        await this.supabase.client
          .from('leads')
          .update({ enganche_disponible: engancheDetectado })
          .eq('id', lead.id);
        console.log('âœ… Enganche guardado:', engancheDetectado);
      } catch (e) {
        console.log('âš ï¸ Error guardando enganche');
      }
      
      // Obtener banco e ingreso del historial
      let bancoPreferido = lead.banco_preferido;
      let ingresoGuardado = 0;
      
      // Buscar ingreso en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('ingreso de')) {
          const match = msg.content.match(/\$\s*([\d,]+)/);
          if (match) {
            ingresoGuardado = parseInt(match[1].replace(/,/g, ''));
            break;
          }
        }
      }
      
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      // Calcular capacidad total
      const creditoMax = ingresoGuardado > 0 ? ingresoGuardado * 80 : 0;
      const capacidadTotal = engancheDetectado + creditoMax;
      
      if (capacidadTotal > 0) {
        analysis.response = `Â¡Excelente ${nombreCliente}! ğŸ’ª

ğŸ“Š *Tu capacidad de compra:*
â€¢ Enganche: ${formatMoney(engancheDetectado)}
â€¢ CrÃ©dito estimado: ${formatMoney(creditoMax)}
â€¢ *Total: ${formatMoney(capacidadTotal)}* para tu casa

âš ï¸ Cifras ilustrativas. El banco define el monto final.

Â¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ${bancoPreferido || 'crÃ©dito'}*?`;
      } else {
        analysis.response = `Â¡Excelente ${nombreCliente}! ğŸ’ª

Con ${formatMoney(engancheDetectado)} de enganche mÃ¡s el crÃ©dito, tienes buenas opciones.

âš ï¸ Cifras ilustrativas. El banco define el monto final.

Â¿Te gustarÃ­a que te conecte con nuestro *asesor VIP de ${bancoPreferido || 'crÃ©dito'}*?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4.5: PreguntÃ³ enganche pero no detectÃ³ nÃºmero â†’ Confirmar
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaEnganche && engancheDetectado === 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4.5: No detectÃ³ enganche claro, interpretando...');
      
      // Extraer cualquier nÃºmero del mensaje
      const numerosEnMensaje = originalMessage.match(/\d+/g);
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      if (numerosEnMensaje && numerosEnMensaje.length > 0) {
        // Tomar el nÃºmero mÃ¡s grande encontrado
        let numeroBase = Math.max(...numerosEnMensaje.map((n: string) => parseInt(n)));
        
        // Si el mensaje tiene "mil", "m" o "k", multiplicar por 1000
        const tieneMil = originalMessage.toLowerCase().includes('mil') || 
                         /\d+\s*m(?!i?l)/i.test(originalMessage) ||
                         originalMessage.toLowerCase().includes('k');
        
        const numeroInterpretado = tieneMil || numeroBase < 1000 ? numeroBase * 1000 : numeroBase;
        
        console.log('ğŸ” NÃºmero interpretado:', numeroInterpretado, '(base:', numeroBase, ', tieneMil:', tieneMil, ')');
        
        // Guardar temporalmente para confirmar
        analysis.response = \`Â¿Quisiste decir \${formatMoney(numeroInterpretado)} de enganche? ğŸ¤”\`;
        
        // Guardar el nÃºmero interpretado para usarlo si confirma
        try {
          await this.supabase.client
            .from('leads')
            .update({ enganche_pendiente_confirmar: numeroInterpretado })
            .eq('id', lead.id);
        } catch (e) {}
        
      } else {
        // No hay nÃºmeros, pedir de nuevo
        analysis.response = \`No captÃ© bien el monto ğŸ˜… Â¿CuÃ¡nto tienes ahorrado para el enganche? (por ejemplo: 200 mil, 500k, etc.)\`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 4.5: PreguntÃ³ enganche pero no detectÃ³ nÃºmero â†’ Confirmar
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaEnganche && engancheDetectado === 0) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 4.5: No detectÃ³ enganche claro, interpretando...');
      
      // Extraer cualquier nÃºmero del mensaje
      const numerosEnMensaje = originalMessage.match(/\d+/g);
      const formatMoney = (n: number) => '$' + Math.round(n).toLocaleString('es-MX');
      
      if (numerosEnMensaje && numerosEnMensaje.length > 0) {
        // Tomar el nÃºmero mÃ¡s grande encontrado
        let numeroBase = Math.max(...numerosEnMensaje.map((n: string) => parseInt(n)));
        
        // Si el mensaje tiene "mil", "m" o "k", multiplicar por 1000
        const tieneMil = originalMessage.toLowerCase().includes('mil') || 
                         /\d+\s*m(?!i?l)/i.test(originalMessage) ||
                         originalMessage.toLowerCase().includes('k');
        
        const numeroInterpretado = tieneMil || numeroBase < 1000 ? numeroBase * 1000 : numeroBase;
        
        console.log('ğŸ” NÃºmero interpretado:', numeroInterpretado, '(base:', numeroBase, ', tieneMil:', tieneMil, ')');
        
        // Guardar temporalmente para confirmar
        analysis.response = 'Â¿Quisiste decir ' + formatMoney(numeroInterpretado) + ' de enganche? ğŸ¤”';
        
        // Guardar el nÃºmero interpretado para usarlo si confirma
        try {
          await this.supabase.client
            .from('leads')
            .update({ enganche_pendiente_confirmar: numeroInterpretado })
            .eq('id', lead.id);
        } catch (e) {}
        
      } else {
        // No hay nÃºmeros, pedir de nuevo
        analysis.response = 'No captÃ© bien el monto ğŸ˜… Â¿CuÃ¡nto tienes ahorrado para el enganche? (por ejemplo: 200 mil, 500k, etc.)';
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 5: Cliente dijo SÃ a asesor â†’ Pedir NOMBRE y CELULAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaAsesorVIP && respuestaAfirmativa) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Quiere asesor');
      
      // Si ya tenemos nombre, saltar directo a modalidad
      if (lead.name) {
        console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Ya tenemos nombre, saltando a MODALIDAD');
        analysis.response = `Â¡Perfecto ${lead.name}! ğŸ˜Š Â¿CÃ³mo prefieres que te contacte el asesor?

1ï¸âƒ£ *Llamada telefÃ³nica*
2ï¸âƒ£ *Videollamada* (Zoom/Meet)
3ï¸âƒ£ *Presencial* (en oficina)`;
      } else {
        // Solo pedir nombre (WhatsApp ya lo tenemos)
        console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5: Pidiendo solo NOMBRE');
        analysis.response = `Â¡Perfecto! ğŸ˜Š Â¿Me compartes tu *nombre completo* para conectarte con el asesor?`;
      }
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 5.5: Cliente dio NOMBRE/CELULAR â†’ Preguntar MODALIDAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const preguntabaNombreCelular = ultimoMsgSara?.content?.includes('nombre completo');
    
    // Detectar si el mensaje tiene un nÃºmero de telÃ©fono (10 dÃ­gitos)
    const telefonoEnMensaje = originalMessage.match(/\d{10,}/);
    // Detectar si tiene algo que parece nombre
    const textoSinNumeros = originalMessage.replace(/[\d\-\+\(\)]/g, '').trim();
    const pareceNombre = textoSinNumeros.length > 3;
    
    if (preguntabaNombreCelular && (telefonoEnMensaje || pareceNombre)) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 5.5: Nombre/Celular recibido â†’ Preguntar MODALIDAD');
      
      // Extraer y guardar nombre (preferir el extraÃ­do por OpenAI, ya limpio)
      const nombreLimpio = analysis.extracted_data?.nombre || textoSinNumeros;
      if (nombreLimpio && nombreLimpio.length > 2) {
        try {
          await this.supabase.client
            .from('leads')
            .update({ name: nombreLimpio })
            .eq('id', lead.id);
          lead.name = nombreLimpio;
          console.log('âœ… Nombre guardado:', nombreLimpio);
        } catch (e) {}
      }
      
      // Extraer y guardar telÃ©fono
      if (telefonoEnMensaje) {
        const telLimpio = telefonoEnMensaje[0];
        try {
          await this.supabase.client
            .from('leads')
            .update({ phone: telLimpio })
            .eq('id', lead.id);
          console.log('âœ… TelÃ©fono guardado:', telLimpio);
        } catch (e) {}
      }
      
      const nombreSaludo = lead.name || textoSinNumeros || 'amigo';
      
      analysis.response = `Â¡Gracias ${nombreSaludo}! ğŸ˜Š Â¿CÃ³mo prefieres que te contacte el asesor?

1ï¸âƒ£ *Llamada telefÃ³nica*
2ï¸âƒ£ *Videollamada* (Zoom/Meet)
3ï¸âƒ£ *Presencial* (en oficina)`;
      
      analysis.send_contactos = false;
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FLUJO CRÃ‰DITO PASO 6: Cliente eligiÃ³ MODALIDAD â†’ CONECTAR CON ASESOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else if (preguntabaModalidad && modalidadDetectada) {
      console.log('ğŸ¦ FLUJO CRÃ‰DITO PASO 6: Modalidad elegida:', modalidadDetectada.nombre, 'â†’ CONECTANDO');
      
      // Guardar modalidad
      try {
        await this.supabase.client
          .from('leads')
          .update({ modalidad_asesoria: modalidadDetectada.nombre })
          .eq('id', lead.id);
        console.log('âœ… Modalidad guardada:', modalidadDetectada.nombre);
      } catch (e) {}
      
      // Obtener banco del lead
      let bancoPreferido = lead.banco_preferido;
      if (!bancoPreferido) {
        try {
          const { data: leadActualizado } = await this.supabase.client
            .from('leads')
            .select('banco_preferido')
            .eq('id', lead.id)
            .single();
          bancoPreferido = leadActualizado?.banco_preferido;
        } catch (e) {}
      }
      
      // Buscar asesor del banco
      const asesorBanco = teamMembers.find((t: any) => 
        t.role === 'asesor' && 
        t.banco?.toLowerCase() === bancoPreferido?.toLowerCase()
      );
      
      // Verificar que telÃ©fono no sea placeholder
      const telefonoValido = asesorBanco?.phone && !asesorBanco.phone.startsWith('+5200000000');
      
      console.log('ğŸ” Buscando asesor de', bancoPreferido, 'â†’', asesorBanco?.name || 'NO ENCONTRADO', '| Tel vÃ¡lido:', telefonoValido);
      
      // Obtener datos del lead para la notificaciÃ³n
      let ingresoMensual = 'No especificado';
      let engancheDisponible = 'No especificado';
      
      // Buscar ingreso en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('ingreso de')) {
          const match = msg.content.match(/\$\s*([\d,]+)/);
          if (match) {
            ingresoMensual = `$${match[1]}/mes`;
            break;
          }
        }
      }
      
      // Buscar enganche en historial
      for (const msg of historial) {
        if (msg.role === 'assistant' && msg.content?.includes('Enganche:')) {
          const match = msg.content.match(/Enganche:\s*\$?([\d,]+)/);
          if (match) {
            engancheDisponible = `$${match[1]}`;
            break;
          }
        }
      }
      
      // Re-fetch enganche de DB
      try {
        const { data: leadData } = await this.supabase.client
          .from('leads')
          .select('enganche_disponible')
          .eq('id', lead.id)
          .single();
        if (leadData?.enganche_disponible) {
          engancheDisponible = `$${leadData.enganche_disponible.toLocaleString('es-MX')}`;
        }
      } catch (e) {}
      
      if (asesorBanco && telefonoValido) {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTIFICAR AL ASESOR DEL BANCO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const score = lead.lead_score || lead.score || 0;
        const temp = score >= 70 ? 'HOT ğŸ”¥' : score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
        
        const msgAsesorBanco = `ğŸ”¥ğŸ”¥ğŸ”¥ *Â¡NUEVO LEAD DE CRÃ‰DITO!* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¦ *Banco:* ${bancoPreferido}
ğŸ“¹ *Modalidad:* ${modalidadDetectada.nombre}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${nombreCliente}
ğŸ“± *WhatsApp:* ${cleanPhone}
ğŸ’° *Ingreso:* ${ingresoMensual}
ğŸ’µ *Enganche:* ${engancheDisponible}
ğŸ“Š *Score:* ${score}/100 ${temp}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTACTAR A LA BREVEDAD!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorBanco.phone}`,
          msgAsesorBanco
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor de', bancoPreferido);
        
        // Guardar asesor asignado
        try {
          await this.supabase.client
            .from('leads')
            .update({ asesor_banco_id: asesorBanco.id })
            .eq('id', lead.id);
        } catch (e) {}
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CREAR SOLICITUD HIPOTECARIA EN CRM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        try {
          const ingresoNum = parseInt(ingresoMensual.replace(/[^0-9]/g, '')) || 0;
          const engancheNum = parseInt(engancheDisponible.replace(/[^0-9]/g, '')) || 0;
          const creditoEstimado = ingresoNum * 60;
          
          await this.supabase.client
            .from('mortgage_applications')
            .insert([{
              lead_id: lead.id,
              lead_name: nombreCliente,
              lead_phone: cleanPhone,
              bank: bancoPreferido,
              monthly_income: ingresoNum,
              down_payment: engancheNum,
              requested_amount: creditoEstimado,
              assigned_advisor_id: asesorBanco.id,
              assigned_advisor_name: asesorBanco.name,
              status: 'pending',
              status_notes: `Modalidad: ${modalidadDetectada.nombre}`,
              pending_at: new Date().toISOString()
            }]);
          console.log('ğŸ“‹ Solicitud hipotecaria creada en CRM');
        } catch (mortgageError) {
          console.error('âŒ Error creando solicitud hipotecaria:', mortgageError);
        }
        
        // Respuesta al cliente
        analysis.response = `Â¡Listo ${nombreCliente}! ğŸ‰

*${asesorBanco.name}* de *${bancoPreferido}* se pondrÃ¡ en contacto contigo a la brevedad por *${modalidadDetectada.nombre}*.

ğŸ“± Su telÃ©fono: ${asesorBanco.phone}

âœ… Ya le avisÃ© de tu interÃ©s. Â¡Ã‰xito con tu crÃ©dito!`;
        
        analysis.send_contactos = true;
        
      } else {
        // No hay asesor disponible
        analysis.response = `Â¡Perfecto ${nombreCliente}! ğŸ˜Š

He registrado tu solicitud de asesorÃ­a con *${bancoPreferido || 'crÃ©dito'}* por *${modalidadDetectada.nombre}*.

Un asesor te contactarÃ¡ muy pronto. Â¿Hay algo mÃ¡s en lo que pueda ayudarte?`;
        
        console.log('âš ï¸ No hay asesor disponible para', bancoPreferido);
      }
      
      analysis.intent = 'info_credito';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DETECCIÃ“N FORZADA: Si Ãºltimo mensaje fue "Â¿QUIERES CONOCERLO?" y cliente dice "sÃ­"
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const preguntabaVisita = ultimoMsgSara?.content?.includes('CONOCERLO EN PERSONA') || 
                             ultimoMsgSara?.content?.includes('gustarÃ­a visitarlos') ||
                             ultimoMsgSara?.content?.includes('agendar una cita');
    
    if (preguntabaVisita && respuestaAfirmativa && analysis.intent !== 'solicitar_cita') {
      console.log('ğŸ”„ FORZANDO solicitar_cita - Cliente dijo SÃ a visita');
      analysis.intent = 'solicitar_cita';
    }

    // 1. Enviar respuesta principal
    let respuestaPrincipal = analysis.response;
    
    // Verificar si ya tiene cita para quitar preguntas de visita
    const yaTieneCita = historial.some((msg: any) => 
      msg.content?.includes('Â¡Cita confirmada!') || 
      msg.content?.includes('Te agendo para')
    );
    
    // Si YA TIENE CITA, quitar CUALQUIER pregunta de visita de la respuesta
    if (yaTieneCita) {
      respuestaPrincipal = respuestaPrincipal
        .replace(/\n*Â¿[Tt]e gustarÃ­a visitar.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres conocer.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres agendar.*\?/gi, '')
        .replace(/\n*Â¿[Tt]e gustarÃ­a agendar.*\?/gi, '')
        .replace(/\n*Â¿[Tt]e gustarÃ­a conocer.*\?/gi, '')
        .replace(/\n*Â¿[Qq]uieres visitar.*\?/gi, '')
        .replace(/Con esto podrÃ­as ver casas en[^.]*\./gi, '')
        .replace(/Mientras avanzas con el crÃ©dito[^?]*\?/gi, '')
        .trim();
      console.log('ğŸ”„ Limpiando preguntas de visita (ya tiene cita)');
    }
    
    // Si es confirmar_cita, quitar la pregunta de crÃ©dito del mensaje principal
    const esConfirmarCita = analysis.intent === 'confirmar_cita' && 
                            analysis.extracted_data.fecha && 
                            analysis.extracted_data.hora;
    
    if (esConfirmarCita && respuestaPrincipal.includes('crÃ©dito hipotecario')) {
      respuestaPrincipal = respuestaPrincipal
        .replace(/\n*Por cierto,.*crÃ©dito hipotecario.*\?/gi, '')
        .replace(/\n*Â¿Ya tienes crÃ©dito.*\?/gi, '')
        .trim();
    }
    
    await this.twilio.sendWhatsAppMessage(from, respuestaPrincipal);
    console.log('âœ… Respuesta enviada');
    
    // NOTA: Ya NO enviamos mensaje separado de ASESOR VIP
    // El flujo nuevo de bancos maneja todo en los PASOS 1-6 arriba

    // Obtener desarrollo(s) - considerar array de desarrollos si existe
    const desarrollosArray = analysis.extracted_data.desarrollos || [];
    const desarrolloSingle = analysis.extracted_data.desarrollo;
    const desarrollo = desarrolloSingle || desarrollosArray[0] || lead.property_interest;
    const desarrollosParaCita = desarrollosArray.length > 0 ? desarrollosArray.join(' y ') : desarrollo;
    
    const propsDesarrollo = desarrollo ? 
      properties.filter(p => p.development?.toLowerCase().includes(desarrollo.toLowerCase())) : [];

    // 2. CITA: Solo si intent es confirmar_cita Y tiene fecha+hora Y tenemos nombre
    const tieneNombre = lead.name || analysis.extracted_data.nombre;
    const preguntamosCredito = lead.needs_mortgage !== null || analysis.extracted_data.necesita_credito !== null;
    
    // Verificar si ya tiene cita antes de intentar crear otra
    let yaExisteCita = false;
    try {
      const { data: citaPrevia } = await this.supabase.client
        .from('appointments')
        .select('id')
        .eq('lead_id', lead.id)
        .eq('status', 'scheduled')
        .limit(1);
      yaExisteCita = citaPrevia && citaPrevia.length > 0;
    } catch (e) {
      console.log('âš ï¸ Error verificando cita previa');
    }
    
    if (analysis.intent === 'confirmar_cita' && 
        analysis.extracted_data.fecha && 
        analysis.extracted_data.hora) {
      
      // Determinar el desarrollo final
      const desarrolloFinal = desarrollosParaCita || desarrollo;
      
      // Si ya tiene cita, NO crear otra
      if (yaExisteCita) {
        console.log('ğŸš« YA TIENE CITA - No se crearÃ¡ duplicada');
        // No hacer nada, la respuesta de OpenAI ya deberÃ­a ser adecuada
      }
      // Si NO hay desarrollo vÃ¡lido, NO crear cita
      else if (!desarrolloFinal || desarrolloFinal === 'Por definir') {
        console.log('ğŸš« NO HAY DESARROLLO VÃLIDO - No se crearÃ¡ cita');
        // No crear cita sin desarrollo, redirigir a asesor
        await this.twilio.sendWhatsAppMessage(from, 'Â¡Perfecto! ğŸ˜Š Para recomendarte el mejor desarrollo segÃºn tu presupuesto, Â¿te gustarÃ­a que un asesor te contacte directamente?');
      }
      // VerificaciÃ³n de seguridad: NO crear cita sin nombre
      else if (!tieneNombre) {
        console.log('âš ï¸ Intento de cita SIN NOMBRE - no se crearÃ¡');
        await this.twilio.sendWhatsAppMessage(from, 'Â¡Me encanta que quieras visitarnos! ğŸ˜Š Solo para darte mejor atenciÃ³n, Â¿me compartes tu nombre?');
      }
      // Si tenemos nombre, desarrollo vÃ¡lido y NO tiene cita previa, crear cita
      else {
        console.log('âœ… CREANDO CITA COMPLETA...');
        if (!preguntamosCredito) {
          console.log('âš ï¸ Nota: Cita creada sin info de crÃ©dito');
        }
        await this.crearCitaCompleta(
          from, cleanPhone, lead, desarrolloFinal,
          analysis.extracted_data.fecha,
          analysis.extracted_data.hora,
          teamMembers, analysis
        );
      }
    }

    // 3. Enviar recursos si aplica (MÃšLTIPLES DESARROLLOS Y MODELOS)
    const clientName = analysis.extracted_data.nombre || lead.name || 'Cliente';
    
    // Parsear desarrollos y modelos del mensaje original
    const { desarrollos: desarrollosDetectados, modelos: modelosDetectados } = this.parsearDesarrollosYModelos(originalMessage);
    
    // TambiÃ©n considerar lo que extrajo OpenAI
    const desarrollosOpenAI = analysis.extracted_data.desarrollos || [];
    const modelosOpenAI = analysis.extracted_data.modelos || [];
    
    // Combinar todas las fuentes de desarrollos (usar 'desarrollo' ya definido arriba)
    const todosDesarrollos = [...new Set([
      ...desarrollosDetectados,
      ...desarrollosOpenAI,
      ...(desarrollo ? [desarrollo] : [])
    ])];
    
    // Combinar todas las fuentes de modelos
    const todosModelos = [...new Set([
      ...modelosDetectados,
      ...modelosOpenAI
    ])];
    
    console.log('ğŸ“‹ Desarrollos detectados:', todosDesarrollos);
    console.log('ğŸ“‹ Modelos detectados:', todosModelos);
    
    // Verificar si ya se enviaron recursos para estos desarrollos (evitar duplicados)
    // Nota: historial ya estÃ¡ declarado arriba
    
    // Verificar en historial si hay mensajes con emojis de recursos
    const recursosEnHistorial = historial.some((msg: any) => 
      msg.role === 'assistant' && 
      (msg.content?.includes('ğŸ¬') || 
       msg.content?.includes('video') ||
       msg.content?.includes('Matterport') ||
       msg.content?.includes('matterport') ||
       msg.content?.includes('tour virtual') ||
       msg.content?.includes('youtu'))
    );
    
    // TambiÃ©n verificar si el Ãºltimo mensaje de SARA preguntÃ³ sobre visitar
    const ultimoMensajeSara = historial.filter((m: any) => m.role === 'assistant').pop();
    const preguntoPorVisita = ultimoMensajeSara?.content?.includes('visitarlos') || 
                              ultimoMensajeSara?.content?.includes('conocer') ||
                              ultimoMensajeSara?.content?.includes('en persona');
    
    // Si el lead ya tiene property_interest del mismo desarrollo, ya se enviaron recursos
    const mismoDesarrollo = lead.property_interest && 
                           todosDesarrollos.some(d => 
                             lead.property_interest?.toLowerCase().includes(d.toLowerCase())
                           );
    
    const recursosYaEnviados = recursosEnHistorial || mismoDesarrollo;
    
    console.log('ğŸ” Â¿Recursos ya enviados?', recursosYaEnviados, 
                '| En historial:', recursosEnHistorial, 
                '| Mismo desarrollo:', mismoDesarrollo,
                '| PreguntÃ³ visita:', preguntoPorVisita);
    
    // Solo enviar recursos si hay interÃ©s Y NO se enviaron antes
    const debeEnviarRecursos = (analysis.send_video_desarrollo || 
                               analysis.intent === 'interes_desarrollo') &&
                               !recursosYaEnviados;
    
    // NO enviar recursos duplicados
    if (recursosYaEnviados && (analysis.intent === 'interes_desarrollo' || analysis.send_video_desarrollo)) {
      console.log('â­ï¸ Recursos ya enviados antes, no se duplican');
    }
    
    if (debeEnviarRecursos) {
      const videosEnviados = new Set<string>();
      const matterportsEnviados = new Set<string>();
      
      // â³ PequeÃ±o delay para asegurar que el texto llegue primero
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // CASO 1: Modelos especÃ­ficos (ej. "el Ascendente y el Gardenia")
      if (todosModelos.length > 0) {
        const propsModelos = this.getPropsParaModelos(todosModelos, properties);
        
        for (const prop of propsModelos) {
          const nombreModelo = prop.model || prop.name || 'Casa';
          const nombreDesarrollo = prop.development || 'Desarrollo';
          
          // Video YouTube del modelo (personalizado + texto vendedor)
          if (prop.youtube_link && !videosEnviados.has(prop.youtube_link)) {
            const saludo = clientName !== 'Cliente' ? `*${clientName}*, mira` : 'Mira';
            const msgVideo = `ğŸ¬ ${saludo} cÃ³mo es *${nombreModelo}* en ${nombreDesarrollo} por dentro:\n${prop.youtube_link}`;
            await this.twilio.sendWhatsAppMessage(from, msgVideo);
            videosEnviados.add(prop.youtube_link);
            console.log(`âœ… Video YouTube enviado: ${nombreModelo}`);
          }
          
          // Matterport del modelo (personalizado)
          if (prop.matterport_link && !matterportsEnviados.has(prop.matterport_link)) {
            const saludo = clientName !== 'Cliente' ? `*${clientName}*, recorre` : 'Recorre';
            const msgMatterport = `ğŸ  ${saludo} *${nombreModelo}* en 3D como si estuvieras ahÃ­:\n${prop.matterport_link}`;
            await this.twilio.sendWhatsAppMessage(from, msgMatterport);
            matterportsEnviados.add(prop.matterport_link);
            console.log(`âœ… Matterport enviado: ${nombreModelo}`);
          }
          
          // âŒ GPS NO se envÃ­a automÃ¡ticamente - solo con cita confirmada
        }
      }
      
      // CASO 2: Desarrollos (ej. "Los Encinos y Andes")
      if (todosDesarrollos.length > 0) {
        for (const dev of todosDesarrollos) {
          const propsDelDesarrollo = properties.filter(p => 
            p.development?.toLowerCase().includes(dev.toLowerCase())
          );
          
          if (propsDelDesarrollo.length > 0) {
            const prop = propsDelDesarrollo[0]; // Primera propiedad del desarrollo
            console.log(`ğŸ“¹ ${dev}: youtube_link=${prop.youtube_link ? 'SÃ' : 'NO'}, matterport=${prop.matterport_link ? 'SÃ' : 'NO'}, gps=${prop.gps_link ? 'SÃ' : 'NO'}`);
            
            // Video YouTube del desarrollo (personalizado + texto vendedor)
            if (prop.youtube_link && !videosEnviados.has(prop.youtube_link)) {
              const saludo = clientName !== 'Cliente' ? `*${clientName}*, mira` : 'Mira';
              const msgVideo = `ğŸ¬ ${saludo} cÃ³mo es *${dev}* por dentro:\n${prop.youtube_link}`;
              await this.twilio.sendWhatsAppMessage(from, msgVideo);
              videosEnviados.add(prop.youtube_link);
              console.log(`âœ… Video YouTube enviado: ${dev}`);
            } else if (!prop.youtube_link) {
              console.log(`âš ï¸ ${dev} NO tiene youtube_link en DB`);
            }
            
            // Matterport del desarrollo (personalizado)
            if (prop.matterport_link && !matterportsEnviados.has(prop.matterport_link)) {
              const nombreModelo = prop.model || prop.name || 'la casa modelo';
              const saludo = clientName !== 'Cliente' ? `*${clientName}*, recorre` : 'Recorre';
              const msgMatterport = `ğŸ  ${saludo} *${nombreModelo}* de ${dev} en 3D:\n${prop.matterport_link}`;
              await this.twilio.sendWhatsAppMessage(from, msgMatterport);
              matterportsEnviados.add(prop.matterport_link);
              console.log(`âœ… Matterport enviado: ${dev}`);
            }
            
            // âŒ GPS NO se envÃ­a automÃ¡ticamente - solo con cita confirmada
          }
        }
      }
      
      console.log(`ğŸ“Š Resumen: ${videosEnviados.size} videos, ${matterportsEnviados.size} matterports (GPS solo con cita)`);
      
      // Marcar en el lead que ya se enviaron recursos (para evitar duplicados)
      try {
        const recursosEnviados = [];
        if (videosEnviados.size > 0) recursosEnviados.push('video');
        if (matterportsEnviados.size > 0) recursosEnviados.push('matterport');
        
        // Agregar nota al historial indicando que se enviaron recursos
        const notaRecursos = `[SISTEMA: Se enviaron recursos (${recursosEnviados.join(', ')}) para ${todosDesarrollos.join(', ')}]`;
        await this.supabase.client
          .from('leads')
          .update({ 
            property_interest: todosDesarrollos[0] || desarrollo,
            // Agregar flag de recursos enviados en metadata o similar
          })
          .eq('id', lead.id);
        console.log('ğŸ“ Marcado: recursos ya enviados para', todosDesarrollos.join(', '));
      } catch (e) {
        console.log('âš ï¸ Error marcando recursos enviados');
      }
      
      // Mensaje de seguimiento despuÃ©s de enviar recursos - MÃS LLAMATIVO
      if (videosEnviados.size > 0 || matterportsEnviados.size > 0) {
        const desarrollosMencionados = todosDesarrollos.length > 0 ? todosDesarrollos.join(' y ') : 'nuestros desarrollos';
        
        await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 segundos
        
        const msgSeguimiento = `ğŸ  *Â¿QUIERES CONOCERLO EN PERSONA?* ğŸ 

Puedo agendarte una cita para que visites *${desarrollosMencionados}*. Â¿QuÃ© dices? ğŸ˜Š`;
        
        await this.twilio.sendWhatsAppMessage(from, msgSeguimiento);
        console.log('âœ… Mensaje de seguimiento enviado (formato llamativo)');
        
        // Agregar mensaje de seguimiento al historial para que OpenAI lo vea
        try {
          const historialActual = lead.conversation_history || [];
          historialActual.push({ 
            role: 'assistant', 
            content: msgSeguimiento, 
            timestamp: new Date().toISOString() 
          });
          await this.supabase.client
            .from('leads')
            .update({ conversation_history: historialActual.slice(-30) })
            .eq('id', lead.id);
          console.log('ğŸ“ Mensaje de seguimiento agregado al historial');
        } catch (e) {
          console.log('âš ï¸ Error agregando mensaje al historial');
        }
      }
    }

    // 4. Si pide contacto con asesor, notificar al asesor Y confirmar al cliente
    // âš ï¸ Solo se ejecuta si NO se usÃ³ el nuevo flujo de banco/modalidad
    if (analysis.send_contactos) {
      console.log('ğŸ“¤ VERIFICANDO NOTIFICACIÃ“N A ASESOR...');
      
      // Si ya se procesÃ³ con el flujo de banco, NO usar este flujo viejo
      const leadActualizado = await this.supabase.client
        .from('leads')
        .select('banco_preferido, modalidad_asesoria')
        .eq('id', lead.id)
        .single();
      
      if (leadActualizado?.data?.banco_preferido && leadActualizado?.data?.modalidad_asesoria) {
        console.log('â­ï¸ Ya se procesÃ³ con flujo de BANCO/MODALIDAD, saltando flujo viejo');
        return;
      }
      
      // Verificar si ya se enviÃ³ notificaciÃ³n al asesor (evitar duplicados)
      const historialCompleto = lead.conversation_history || [];
      const yaSeEnvioAsesor = historialCompleto.some((msg: any) => 
        msg.role === 'assistant' && 
        (msg.content?.includes('Tu asesor hipotecario es') || 
         msg.content?.includes('Te voy a conectar con') ||
         msg.content?.includes('te contactarÃ¡ pronto'))
      );
      
      if (yaSeEnvioAsesor) {
        console.log('â­ï¸ Ya se enviÃ³ notificaciÃ³n al asesor anteriormente, no se duplica');
        return;
      }
      
      const asesorHipotecario = teamMembers.find(t => 
        t.role?.toLowerCase().includes('hipotec') || 
        t.role?.toLowerCase().includes('credito') ||
        t.role?.toLowerCase().includes('crÃ©dito') ||
        t.role?.toLowerCase().includes('asesor')
      );
      console.log('ğŸ‘¤ Asesor encontrado:', asesorHipotecario?.name || 'NO', '| Tel:', asesorHipotecario?.phone || 'NO');
      
      // Obtener datos de ubicaciÃ³n
      const desarrolloInteres = desarrollo || lead.property_interest || 'Por definir';
      const propDesarrollo = properties.find(p => 
        p.development?.toLowerCase().includes(desarrolloInteres.toLowerCase())
      );
      const direccionAsesor = propDesarrollo?.address || propDesarrollo?.location || `Fraccionamiento ${desarrolloInteres}, Zacatecas`;
      const gpsAsesor = propDesarrollo?.gps_link || '';
      
      // Obtener ingreso del historial Y del mensaje actual
      const historialConversacion = lead.conversation_history || [];
      let ingresoMensual = 'No especificado';
      
      // Buscar en todos los mensajes del historial
      for (const msg of historialConversacion) {
        if (msg.content) {
          // Buscar patrones como "gano 56 mil", "56,000", "$56000", etc.
          const matchMil = msg.content.match(/(\d+)\s*mil/i);
          const matchPesos = msg.content.match(/\$?\s*(\d{1,3}(?:,\d{3})+)/);
          const matchNumero = msg.content.match(/(?:gano|ingreso|sueldo|cobro).*?(\d+)/i);
          
          if (matchMil) {
            ingresoMensual = `$${matchMil[1]},000/mes`;
            console.log('ğŸ’° Ingreso detectado en historial (mil):', ingresoMensual);
          } else if (matchPesos) {
            ingresoMensual = `$${matchPesos[1]}/mes`;
            console.log('ğŸ’° Ingreso detectado en historial (pesos):', ingresoMensual);
          } else if (matchNumero) {
            const num = parseInt(matchNumero[1]);
            if (num > 1000) {
              ingresoMensual = `$${num.toLocaleString()}/mes`;
            } else {
              ingresoMensual = `$${num},000/mes`;
            }
            console.log('ğŸ’° Ingreso detectado en historial (nÃºmero):', ingresoMensual);
          }
        }
      }
      
      // TambiÃ©n buscar en el mensaje original actual
      if (originalMessage) {
        const matchMil = originalMessage.match(/(\d+)\s*mil/i);
        const matchPesos = originalMessage.match(/\$?\s*(\d{1,3}(?:,\d{3})+)/);
        
        if (matchMil) {
          ingresoMensual = `$${matchMil[1]},000/mes`;
          console.log('ğŸ’° Ingreso detectado en mensaje actual (mil):', ingresoMensual);
        } else if (matchPesos) {
          ingresoMensual = `$${matchPesos[1]}/mes`;
          console.log('ğŸ’° Ingreso detectado en mensaje actual (pesos):', ingresoMensual);
        }
      }
      
      // Buscar en la respuesta de SARA si mencionÃ³ el ingreso
      if (ingresoMensual === 'No especificado' && analysis.response) {
        const matchRespuesta = analysis.response.match(/\$(\d{1,3}(?:,\d{3})*)/);
        if (matchRespuesta) {
          ingresoMensual = `$${matchRespuesta[1]}/mes (calculado)`;
          console.log('ğŸ’° Ingreso detectado en respuesta SARA:', ingresoMensual);
        }
      }
      
      console.log('ğŸ’° Ingreso final a enviar:', ingresoMensual);
      
      // Obtener cita existente del lead (de la DB, no solo del anÃ¡lisis)
      let citaExistente = '';
      try {
        const { data: citaDB } = await this.supabase.client
          .from('appointments')
          .select('scheduled_date, scheduled_time, property_name')
          .eq('lead_id', lead.id)
          .eq('status', 'scheduled')
          .order('created_at', { ascending: false })
          .limit(1);
        
        if (citaDB && citaDB.length > 0) {
          const cita = citaDB[0];
          citaExistente = `${cita.scheduled_date} a las ${cita.scheduled_time} en ${cita.property_name}`;
          console.log('ğŸ“… Cita encontrada en DB:', citaExistente);
        }
      } catch (e) {
        console.log('âš ï¸ Error buscando cita en DB');
      }
      
      // Si no hay en DB, usar del anÃ¡lisis
      let fechaCita = '';
      let horaCita = '';
      if (!citaExistente) {
        fechaCita = analysis.extracted_data?.fecha || '';
        horaCita = analysis.extracted_data?.hora || '';
        if (fechaCita && horaCita) {
          citaExistente = `${fechaCita} a las ${horaCita}`;
        }
      }
      
      // Formatear fecha legible para el cliente
      const formatearFechaLegible = (fechaDB: string) => {
        if (!fechaDB) return '';
        // Si ya es legible (maÃ±ana, hoy, etc), retornar
        if (fechaDB.includes('maÃ±ana') || fechaDB.includes('hoy')) return fechaDB;
        // Si es formato ISO, convertir
        try {
          const fecha = new Date(fechaDB);
          const opciones: Intl.DateTimeFormatOptions = { weekday: 'long', day: 'numeric', month: 'long' };
          return fecha.toLocaleDateString('es-MX', opciones);
        } catch {
          return fechaDB;
        }
      };
      
      const formatearHoraLegible = (horaDB: string) => {
        if (!horaDB) return '';
        // Si tiene formato HH:MM:SS, simplificar
        const match = horaDB.match(/(\d{1,2}):(\d{2})/);
        if (match) {
          const hora = parseInt(match[1]);
          const minutos = match[2];
          const periodo = hora >= 12 ? 'pm' : 'am';
          const hora12 = hora > 12 ? hora - 12 : hora === 0 ? 12 : hora;
          return minutos === '00' ? `${hora12} ${periodo}` : `${hora12}:${minutos} ${periodo}`;
        }
        return horaDB;
      };
      
      // Crear versiÃ³n legible de la cita para el cliente
      let citaLegible = '';
      if (citaExistente) {
        const partes = citaExistente.match(/(.+) a las (.+) en (.+)/);
        if (partes) {
          citaLegible = `${formatearFechaLegible(partes[1])} a las ${formatearHoraLegible(partes[2])} en *${partes[3]}*`;
        } else {
          citaLegible = citaExistente;
        }
      }
      
      const temp = lead.lead_score >= 70 ? 'HOT ğŸ”¥' : lead.lead_score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
      
      if (asesorHipotecario?.phone) {
        // 1. MENSAJE COMPLETO AL ASESOR (incluye GPS)
        const msgAsesor = `ğŸ”¥ğŸ”¥ğŸ”¥ *Â¡NUEVO LEAD VIP!* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’³ *SOLICITA ASESORÃA HIPOTECARIA*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ  *InterÃ©s:* ${desarrolloInteres}
ğŸ’° *Ingreso:* ${ingresoMensual}
${citaExistente ? `ğŸ“… *Cita:* ${citaExistente}` : 'ğŸ“… *Cita:* Por agendar'}
ğŸ“Š *Score:* ${lead.lead_score || 0}/100 ${temp}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccionAsesor}
${gpsAsesor ? `ğŸ—ºï¸ ${gpsAsesor}` : ''}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTÃCTALO YA!* âš¡`;

        console.log('ğŸ“¨ MENSAJE A ASESOR:', msgAsesor);
        
        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorHipotecario.phone}`,
          msgAsesor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor (solicitud directa)');
        
        // 2. CONFIRMAR AL CLIENTE CON DATOS DEL ASESOR (SIN GPS para no saturar)
        const nombreAsesor = asesorHipotecario.name?.replace(/ - Asesor.*$/i, '') || 'Nuestro asesor';
        const telAsesor = asesorHipotecario.phone;
        
        const msgConfirmacionCliente = `âœ… *Â¡Listo ${clientName}!* Tu asesor hipotecario es:

ğŸ‘¤ *${nombreAsesor}*
ğŸ“± ${telAsesor}

${citaLegible ? `Te verÃ¡ ${citaLegible}` : 'Ã‰l se pondrÃ¡ en contacto contigo pronto'}`;

        await this.twilio.sendWhatsAppMessage(from, msgConfirmacionCliente);
        console.log('ğŸ“¤ ConfirmaciÃ³n de asesor enviada al cliente');
        
        // Agregar confirmaciÃ³n al historial para evitar duplicados
        try {
          const historialActual = lead.conversation_history || [];
          historialActual.push({ 
            role: 'assistant', 
            content: msgConfirmacionCliente, 
            timestamp: new Date().toISOString() 
          });
          await this.supabase.client
            .from('leads')
            .update({ conversation_history: historialActual.slice(-30) })
            .eq('id', lead.id);
          console.log('ğŸ“ ConfirmaciÃ³n de asesor agregada al historial');
        } catch (e) {
          console.log('âš ï¸ Error agregando confirmaciÃ³n al historial');
        }
        
        // 3. CREAR CITA DE ASESORÃA EN DB (si tiene fecha/hora del anÃ¡lisis)
        const fechaAnalisis = analysis.extracted_data?.fecha;
        const horaAnalisis = analysis.extracted_data?.hora;
        if (fechaAnalisis && horaAnalisis) {
          try {
            const { error: citaError } = await this.supabase.client
              .from('appointments')
              .insert([{
                lead_id: lead.id,
                lead_name: clientName,
                lead_phone: cleanPhone,
                property_name: desarrolloInteres,
                location: direccionAsesor,
                scheduled_date: this.parseFechaISO(fechaAnalisis),
                scheduled_time: this.parseHoraISO(horaAnalisis),
                status: 'scheduled',
                vendedor_id: asesorHipotecario.id,
                vendedor_name: nombreAsesor,
                appointment_type: 'asesoria_credito',
                duration_minutes: 60
              }]);
            
            if (citaError) {
              console.error('âŒ Error creando cita asesor en DB:', citaError);
            } else {
              console.log('ğŸ“… Cita de asesorÃ­a creada en DB');
            }
          } catch (e) {
            console.error('âŒ Error en cita asesor:', e);
          }
        }
      } else {
        console.log('âš ï¸ No se encontrÃ³ asesor con telÃ©fono para notificar');
      }
    }

    // 5. Actualizar lead
    await this.actualizarLead(lead, analysis, originalMessage);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CREAR CITA COMPLETA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async crearCitaCompleta(
    from: string,
    cleanPhone: string,
    lead: any,
    desarrollo: string,
    fecha: string,
    hora: string,
    teamMembers: any[],
    analysis: AIAnalysis
  ): Promise<void> {
    
    const vendedor = teamMembers.find(t => t.id === lead.assigned_to);
    console.log('ğŸ‘¤ Vendedor encontrado:', vendedor?.name || 'NO', '| Email:', vendedor?.email || 'NO', '| Phone:', vendedor?.phone || 'NO');
    
    // Buscar asesor hipotecario en el equipo (ampliar bÃºsqueda)
    const asesorHipotecario = teamMembers.find(t => 
      t.role?.toLowerCase().includes('hipotec') || 
      t.role?.toLowerCase().includes('credito') ||
      t.role?.toLowerCase().includes('crÃ©dito') ||
      t.role?.toLowerCase().includes('financ') ||
      t.role?.toLowerCase().includes('asesor') ||
      t.position?.toLowerCase().includes('hipotec') ||
      t.position?.toLowerCase().includes('credito') ||
      t.name?.toLowerCase().includes('asesor')
    );
    console.log('ğŸ’³ Asesor hipotecario encontrado:', asesorHipotecario?.name || 'NO', '| Email:', asesorHipotecario?.email || 'NO', '| Phone:', asesorHipotecario?.phone || 'NO');
    console.log('ğŸ“‹ Team members disponibles:', teamMembers.map(t => ({ name: t.name, role: t.role, position: t.position })));
    
    const clientName = analysis.extracted_data.nombre || lead.name || 'Cliente';
    const score = lead.lead_score || 0;
    const temp = score >= 70 ? 'HOT ğŸ”¥' : score >= 40 ? 'WARM ğŸŒ¡ï¸' : 'COLD â„ï¸';
    const necesitaCredito = lead.needs_mortgage === true || analysis.extracted_data.necesita_credito === true;

    // Buscar propiedad para obtener direcciÃ³n y GPS
    const properties = await this.getAllProperties();
    const propDesarrollo = properties.find(p => 
      p.development?.toLowerCase().includes(desarrollo.toLowerCase())
    );
    console.log(`ğŸ“ Propiedad encontrada para ${desarrollo}:`, propDesarrollo ? `address=${propDesarrollo.address}, location=${propDesarrollo.location}` : 'NO ENCONTRADA');
    const direccion = propDesarrollo?.address || propDesarrollo?.location || `Fraccionamiento ${desarrollo}, Zacatecas`;
    const gpsLink = propDesarrollo?.gps_link || '';

    // âš ï¸ VERIFICAR SI YA EXISTE UNA CITA RECIENTE (Ãºltimos 30 minutos)
    try {
      const { data: citaExistente } = await this.supabase.client
        .from('appointments')
        .select('id, created_at, lead_name')
        .eq('lead_id', lead.id)
        .gte('created_at', new Date(Date.now() - 30 * 60 * 1000).toISOString())
        .order('created_at', { ascending: false })
        .limit(1);

      if (citaExistente && citaExistente.length > 0) {
        console.log('âš ï¸ Ya existe cita reciente para este lead, no se crearÃ¡ duplicada');
        
        // Solo actualizar el nombre si no lo tenÃ­amos y ahora sÃ­ lo tenemos
        if (analysis.extracted_data.nombre && !citaExistente[0].lead_name) {
          await this.supabase.client
            .from('appointments')
            .update({ lead_name: analysis.extracted_data.nombre })
            .eq('id', citaExistente[0].id);
          console.log('âœ… Nombre actualizado en cita existente:', analysis.extracted_data.nombre);
        }
        return; // NO crear cita duplicada
      }
    } catch (checkError) {
      console.log('âš ï¸ Error verificando cita existente, continuando...', checkError);
    }

    try {
      // 1. Crear cita en DB con columnas correctas
      const { data: appointment, error } = await this.supabase.client
        .from('appointments')
        .insert([{
          lead_id: lead.id,
          lead_name: clientName,
          lead_phone: cleanPhone,
          property_name: desarrollo,
          location: direccion,
          scheduled_date: this.parseFechaISO(fecha),
          scheduled_time: this.parseHoraISO(hora),
          status: 'scheduled',
          vendedor_id: vendedor?.id,
          vendedor_name: vendedor?.name,
          appointment_type: 'visita',
          duration_minutes: 60
        }])
        .select()
        .single();

      if (error) {
        console.error('âŒ Error creando cita en DB:', error);
      } else {
        console.log('ğŸ“… Cita creada en DB:', appointment?.id);
      }

      const fechaEvento = this.parseFecha(fecha, hora);
      console.log('ğŸ“† Fecha evento parseada:', fechaEvento.toISOString());
      console.log('ğŸ“† Calendar object exists:', !!this.calendar);
      console.log('ğŸ“† Calendar.createEvent exists:', typeof this.calendar?.createEvent);
      
      // Formatear fechas para Google Calendar API (RFC3339 con offset)
      const endEvento = new Date(fechaEvento.getTime() + 60 * 60 * 1000);
      
      // Formato RFC3339 con offset de zona horaria MÃ©xico (UTC-6)
      const formatDateForCalendar = (date: Date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        // Formato ISO 8601 completo
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
      };
      
      // Calcular fechas una sola vez para ambos eventos
      const startDateTime = formatDateForCalendar(fechaEvento);
      const endDateTime = formatDateForCalendar(endEvento);
      
      // 2. Google Calendar - CITA VENDEDOR
      try {
        console.log('ğŸ“† Intentando crear evento VENDEDOR en Google Calendar...');
        console.log('ğŸ“† Start:', startDateTime, '| End:', endDateTime);
        
        // Normalizar evento para evitar error "Start and end times must either both be date or both be dateTime"
        const eventData: any = {
          summary: `ğŸ  Visita ${desarrollo} - ${clientName}`,
          description: `ğŸ‘¤ Cliente: ${clientName}
ğŸ“± TelÃ©fono: ${cleanPhone}
ğŸ  Desarrollo: ${desarrollo}
ğŸ“ DirecciÃ³n: ${direccion}
ğŸ—ºï¸ GPS: ${gpsLink}
ğŸ“Š Score: ${score}/100 ${temp}
ğŸ’³ Necesita crÃ©dito: ${necesitaCredito ? 'SÃ' : 'No especificado'}`,
          location: direccion,
          start: {
            dateTime: startDateTime,
            timeZone: 'America/Mexico_City'
          },
          end: {
            dateTime: endDateTime,
            timeZone: 'America/Mexico_City'
          },
          attendees: vendedor?.email ? [{ email: vendedor.email }] : []
        };
        
        // Asegurar que no haya mezcla de date y dateTime
        if (eventData.start?.dateTime) delete eventData.start.date;
        if (eventData.end?.dateTime) delete eventData.end.date;
        
        console.log('ğŸ“† Event data (normalizado):', JSON.stringify(eventData, null, 2));
        
        const eventResult = await this.calendar.createEvent(eventData);
        console.log('ğŸ“… Evento Google Calendar VENDEDOR creado:', eventResult);
      } catch (calError) {
        console.error('âŒ Error Calendar Vendedor:', calError);
        console.error('âŒ Error details:', JSON.stringify(calError, null, 2));
      }

      // 3. Google Calendar - CITA ASESOR HIPOTECARIO (si necesita crÃ©dito)
      console.log('ğŸ’³ Â¿Necesita crÃ©dito?', necesitaCredito, '| Â¿Tiene asesor email?', asesorHipotecario?.email || 'NO');
      if (necesitaCredito && asesorHipotecario?.email) {
        try {
          console.log('ğŸ“† Intentando crear evento ASESOR en Google Calendar...');
          
          // Normalizar evento
          const eventAsesorData: any = {
            summary: `ğŸ’³ AsesorÃ­a CrÃ©dito - ${clientName} (${desarrollo})`,
            description: `ğŸ‘¤ Cliente: ${clientName}
ğŸ“± TelÃ©fono: ${cleanPhone}
ğŸ  Desarrollo de interÃ©s: ${desarrollo}
ğŸ“ DirecciÃ³n: ${direccion}
ğŸ—ºï¸ GPS: ${gpsLink}
ğŸ“Š Score: ${score}/100 ${temp}
ğŸ‘¤ Vendedor asignado: ${vendedor?.name || 'Por asignar'}`,
            location: direccion,
            start: {
              dateTime: startDateTime,
              timeZone: 'America/Mexico_City'
            },
            end: {
              dateTime: endDateTime,
              timeZone: 'America/Mexico_City'
            },
            attendees: [{ email: asesorHipotecario.email }]
          };
          
          // Asegurar que no haya mezcla de date y dateTime
          if (eventAsesorData.start?.dateTime) delete eventAsesorData.start.date;
          if (eventAsesorData.end?.dateTime) delete eventAsesorData.end.date;
          
          const eventAsesor = await this.calendar.createEvent(eventAsesorData);
          console.log('ğŸ“… Evento Google Calendar ASESOR HIPOTECARIO creado:', eventAsesor);
        } catch (calError) {
          console.error('âŒ Error Calendar Asesor:', calError);
        }
      } else {
        console.log('â­ï¸ No se creÃ³ cita de asesor:', necesitaCredito ? 'Falta email de asesor' : 'No necesita crÃ©dito');
      }

      // 4. Notificar al VENDEDOR con direcciÃ³n y GPS
      if (vendedor?.phone) {
        const msgVendedor = `ğŸ””ğŸ””ğŸ”” *Â¡NUEVA CITA!* ğŸ””ğŸ””ğŸ””
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ  *${desarrollo}*
ğŸ“… *${fecha}* a las *${hora}*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ“Š *Score:* ${score}/100 ${temp}
ğŸ’³ *CrÃ©dito:* ${necesitaCredito ? 'âš ï¸ SÃ NECESITA' : 'No especificado'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccion}
ğŸ—ºï¸ ${gpsLink}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡PREPÃRATE PARA RECIBIRLO!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${vendedor.phone}`,
          msgVendedor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a vendedor');
      }

      // 5. Notificar al ASESOR HIPOTECARIO (si necesita crÃ©dito)
      if (necesitaCredito && asesorHipotecario?.phone) {
        const msgAsesor = `ğŸ”¥ğŸ”¥ğŸ”¥ *LEAD NECESITA CRÃ‰DITO* ğŸ”¥ğŸ”¥ğŸ”¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ  *${desarrollo}*
ğŸ“… *Visita:* ${fecha} a las ${hora}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ *Cliente:* ${clientName}
ğŸ“± *Tel:* ${cleanPhone}
ğŸ“Š *Score:* ${score}/100 ${temp}
ğŸ‘¤ *Vendedor:* ${vendedor?.name || 'Por asignar'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ ${direccion}
ğŸ—ºï¸ ${gpsLink}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš¡ *Â¡CONTÃCTALO PARA INICIAR TRÃMITE!* âš¡`;

        await this.twilio.sendWhatsAppMessage(
          `whatsapp:${asesorHipotecario.phone}`,
          msgAsesor
        );
        console.log('ğŸ“¤ NotificaciÃ³n enviada a asesor hipotecario');
      }

      // 6. Enviar confirmaciÃ³n al CLIENTE con info de vendedor y asesor
      let infoContactos = '';
      if (vendedor?.name) {
        infoContactos += `\nğŸ‘¤ *Vendedor:* ${vendedor.name}`;
        if (vendedor.phone) {
          infoContactos += `\nğŸ“± *Tel vendedor:* ${vendedor.phone}`;
        }
      }
      if (necesitaCredito && asesorHipotecario?.name) {
        infoContactos += `\n\nğŸ’³ *Asesor de crÃ©dito:* ${asesorHipotecario.name}`;
        if (asesorHipotecario.phone) {
          infoContactos += `\nğŸ“± *Tel asesor:* ${asesorHipotecario.phone}`;
        }
      }

      const confirmacion = `âœ… *Â¡Cita confirmada!*

ğŸ“… *Fecha:* ${fecha}
ğŸ• *Hora:* ${hora}
ğŸ  *Desarrollo:* ${desarrollo}

ğŸ“ *DirecciÃ³n:* ${direccion}
ğŸ—ºï¸ *Google Maps:* ${gpsLink}
${infoContactos}

Â¡Te esperamos! ğŸ‰`;

      await this.twilio.sendWhatsAppMessage(from, confirmacion);
      
      // Enviar pregunta de crÃ©dito como mensaje SEPARADO (mÃ¡s visible)
      await new Promise(resolve => setTimeout(resolve, 2500)); // 2.5 segundos
      
      const msgPreguntaCredito = `ğŸ’³ *IMPORTANTE* ğŸ’³

Â¿Ya tienes crÃ©dito hipotecario aprobado o te gustarÃ­a que te orientÃ¡ramos?`;
      
      await this.twilio.sendWhatsAppMessage(from, msgPreguntaCredito);
      console.log('âœ… Pregunta de crÃ©dito enviada (mensaje separado)');

      console.log('âœ… CITA COMPLETA CREADA');

    } catch (error) {
      console.error('âŒ Error en crearCitaCompleta:', error);
    }
  }

  private parseFecha(fecha: string, hora: string): Date {
    const now = new Date();
    const fechaLower = fecha.toLowerCase();
    
    let targetDate = new Date(now);

    if (fechaLower.includes('hoy')) {
      // Hoy
    } else if (fechaLower.includes('maÃ±ana')) {
      targetDate.setDate(targetDate.getDate() + 1);
    } else if (fechaLower.includes('lunes')) {
      targetDate = this.getNextDayOfWeek(1);
    } else if (fechaLower.includes('martes')) {
      targetDate = this.getNextDayOfWeek(2);
    } else if (fechaLower.includes('miÃ©rcoles') || fechaLower.includes('miercoles')) {
      targetDate = this.getNextDayOfWeek(3);
    } else if (fechaLower.includes('jueves')) {
      targetDate = this.getNextDayOfWeek(4);
    } else if (fechaLower.includes('viernes')) {
      targetDate = this.getNextDayOfWeek(5);
    } else if (fechaLower.includes('sÃ¡bado') || fechaLower.includes('sabado')) {
      targetDate = this.getNextDayOfWeek(6);
    } else if (fechaLower.includes('domingo')) {
      targetDate = this.getNextDayOfWeek(0);
    }

    // Parsear hora
    const horaMatch = hora.match(/(\d{1,2})(?::(\d{2}))?/);
    if (horaMatch) {
      let hours = parseInt(horaMatch[1]);
      const minutes = parseInt(horaMatch[2] || '0');
      
      if (hora.toLowerCase().includes('pm') && hours < 12) hours += 12;
      if (hora.toLowerCase().includes('am') && hours === 12) hours = 0;
      
      targetDate.setHours(hours, minutes, 0, 0);
    }

    return targetDate;
  }

  private getNextDayOfWeek(dayOfWeek: number): Date {
    const now = new Date();
    const currentDay = now.getDay();
    let daysUntil = dayOfWeek - currentDay;
    if (daysUntil <= 0) daysUntil += 7;
    
    const result = new Date(now);
    result.setDate(result.getDate() + daysUntil);
    return result;
  }

  // Parsear fecha a formato ISO (YYYY-MM-DD) para Supabase
  private parseFechaISO(fecha: string): string {
    const targetDate = this.parseFecha(fecha, '12:00');
    return targetDate.toISOString().split('T')[0];
  }

  // Parsear hora a formato TIME (HH:MM:SS) para Supabase
  private parseHoraISO(hora: string): string {
    const horaMatch = hora.match(/(\d{1,2})(?::(\d{2}))?/);
    if (horaMatch) {
      let hours = parseInt(horaMatch[1]);
      const minutes = horaMatch[2] || '00';
      
      if (hora.toLowerCase().includes('pm') && hours < 12) hours += 12;
      if (hora.toLowerCase().includes('am') && hours === 12) hours = 0;
      
      return `${hours.toString().padStart(2, '0')}:${minutes}:00`;
    }
    return '12:00:00';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ACTUALIZAR LEAD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  private async actualizarLead(lead: any, analysis: AIAnalysis, originalMessage: string): Promise<void> {
    const updates: any = {};
    const data = analysis.extracted_data;

    // Actualizar datos extraÃ­dos
    if (data.nombre && !lead.name) {
      updates.name = data.nombre;
    }
    if (data.desarrollo && !lead.property_interest) {
      updates.property_interest = data.desarrollo;
    }
    if (data.necesita_credito !== null && data.necesita_credito !== undefined && lead.needs_mortgage === null) {
      updates.needs_mortgage = data.necesita_credito;
    }
    if (data.num_recamaras && !lead.num_recamaras) {
      updates.num_recamaras = data.num_recamaras;
    }

    // Calcular score
    let score = lead.lead_score || 0;
    
    if (!lead.name && data.nombre) {
      score += 15;
      console.log('ğŸ“Š +15 por nombre');
    }
    if (!lead.property_interest && data.desarrollo) {
      score += 15;
      console.log('ğŸ“Š +15 por desarrollo');
    }
    if (lead.needs_mortgage === null && data.necesita_credito !== null && data.necesita_credito !== undefined) {
      score += 10;
      console.log('ğŸ“Š +10 por crÃ©dito');
    }
    if (analysis.intent === 'confirmar_cita' && data.fecha && data.hora) {
      score += 20;
      console.log('ğŸ“Š +20 por cita confirmada');
    }

    updates.lead_score = Math.min(score, 100);
    updates.lead_category = score >= 70 ? 'HOT' : score >= 40 ? 'WARM' : 'COLD';

    // Actualizar historial
    const newHistory = [
      ...(lead.conversation_history || []),
      { role: 'user', content: originalMessage, timestamp: new Date().toISOString() },
      { role: 'assistant', content: analysis.response, timestamp: new Date().toISOString() }
    ].slice(-30);

    updates.conversation_history = newHistory;
    updates.updated_at = new Date().toISOString();

    // Guardar
    const { error } = await this.supabase.client
      .from('leads')
      .update(updates)
      .eq('id', lead.id);

    if (error) {
      console.error('âŒ Error actualizando lead:', error);
    } else {
      console.log('ğŸ“ Lead actualizado:', { score: updates.lead_score, temp: updates.lead_category });
    }
  }
}
