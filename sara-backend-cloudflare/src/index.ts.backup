import { SupabaseService } from './services/supabase';
import { OpenAIService } from './services/openai';
import { TwilioService } from './services/twilio';
import { MetaWhatsAppService } from './services/meta-whatsapp';
import { CalendarService } from './services/calendar';
import { WhatsAppHandler } from './handlers/whatsapp';
import { handleTeamRoutes } from './routes/team-routes';
import { FollowupService } from './services/followupService';

export interface Env {
  SUPABASE_URL: string;
  SUPABASE_ANON_KEY: string;
  OPENAI_API_KEY: string;
  TWILIO_ACCOUNT_SID: string;
  TWILIO_AUTH_TOKEN: string;
  TWILIO_PHONE_NUMBER: string;
  GOOGLE_SERVICE_ACCOUNT_EMAIL: string;
  GOOGLE_PRIVATE_KEY: string;
  GOOGLE_CALENDAR_ID: string;
  META_PHONE_NUMBER_ID: string;
  META_ACCESS_TOKEN: string;
  GEMINI_API_KEY: string;
}

function corsResponse(body: string | null, status: number = 200, contentType: string = 'application/json'): Response {
  return new Response(body, {
    status,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Content-Type': contentType,
    },
  });
}

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);

    if (request.method === 'OPTIONS') {
      return corsResponse(null, 204);
    }

    const supabase = new SupabaseService(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API Routes - Team Members
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname.startsWith('/api/team-members')) {
      const response = await handleTeamRoutes(request, env, supabase);
      if (response) return response;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API Routes - Leads
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/api/leads' && request.method === 'GET') {
      const { data } = await supabase.client
        .from('leads')
        .select('*')
        .order('created_at', { ascending: false });
      return corsResponse(JSON.stringify(data || []));
    }

    if (url.pathname.match(/^\/api\/leads\/[^\/]+$/) && request.method === 'GET') {
      const id = url.pathname.split('/').pop();
      const { data } = await supabase.client
        .from('leads')
        .select('*')
        .eq('id', id)
        .single();
      return corsResponse(JSON.stringify(data || {}));
    }

    if (url.pathname.match(/^\/api\/leads\/[^\/]+$/) && request.method === 'PUT') {
      const id = url.pathname.split('/').pop();
      const body = await request.json() as any;
      const { data } = await supabase.client
        .from('leads')
        .update(body)
        .eq('id', id)
        .select()
        .single();
      return corsResponse(JSON.stringify(data || {}));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API Routes - Properties
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/api/properties' && request.method === 'GET') {
      const { data } = await supabase.client
        .from('properties')
        .select('*')
        .order('created_at', { ascending: false });
      return corsResponse(JSON.stringify(data || []));
    }

    if (url.pathname.startsWith('/api/properties/') && request.method === 'GET') {
      const id = url.pathname.split('/')[3];
      const { data } = await supabase.client
        .from('properties')
        .select('*')
        .eq('id', id)
        .single();
      return corsResponse(JSON.stringify(data || {}));
    }

    if (url.pathname === '/api/properties' && request.method === 'POST') {
      const body = await request.json() as any;
      const { data } = await supabase.client
        .from('properties')
        .insert([body])
        .select()
        .single();
      return corsResponse(JSON.stringify(data), 201);
    }

    if (url.pathname.startsWith('/api/properties/') && request.method === 'PUT') {
      const id = url.pathname.split('/')[3];
      const body = await request.json() as any;
      const { data } = await supabase.client
        .from('properties')
        .update(body)
        .eq('id', id)
        .select()
        .single();
      return corsResponse(JSON.stringify(data || {}));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API Routes - Dashboard
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/api/dashboard/kpis' && request.method === 'GET') {
      const { data: leads } = await supabase.client.from('leads').select('*');
      const kpis = {
        total: leads?.length || 0,
        new: leads?.filter((l: any) => l.status === 'new').length || 0,
        contacted: leads?.filter((l: any) => l.status === 'contacted').length || 0,
        qualified: leads?.filter((l: any) => l.status === 'qualified').length || 0,
        appointment_scheduled: leads?.filter((l: any) => l.status === 'appointment_scheduled').length || 0,
        converted: leads?.filter((l: any) => l.status === 'converted').length || 0
      };
      return corsResponse(JSON.stringify(kpis));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Webhook WhatsApp (Twilio)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/webhook/whatsapp' && request.method === 'POST') {
      try {
        const formData = await request.formData();
        const from = formData.get('From') as string;
        const body = formData.get('Body') as string;

        if (!from || !body) {
          return new Response('', { status: 200 });
        }

        const openai = new OpenAIService(env.OPENAI_API_KEY);
        const twilio = new TwilioService(env.TWILIO_ACCOUNT_SID, env.TWILIO_AUTH_TOKEN, env.TWILIO_PHONE_NUMBER);
        const calendar = new CalendarService(env.GOOGLE_SERVICE_ACCOUNT_EMAIL, env.GOOGLE_PRIVATE_KEY, env.GOOGLE_CALENDAR_ID);
        const handler = new WhatsAppHandler(supabase, openai, twilio, calendar);

        await handler.handleIncomingMessage(from, body, env);

        // Cancelar follow-ups cuando el lead responde
        const followupService = new FollowupService(supabase);
        await followupService.cancelarPorRespuesta('', from);

        return new Response('', { status: 200 });
      } catch (error) {
        console.error('Webhook Error:', error);
        return new Response('', { status: 200 });
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Webhook WhatsApp (Meta)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/webhook/meta' && request.method === 'GET') {
      const mode = url.searchParams.get('hub.mode');
      const token = url.searchParams.get('hub.verify_token');
      const challenge = url.searchParams.get('hub.challenge');
      
      if (mode === 'subscribe' && token === 'sara_verify_token') {
        return new Response(challenge, { status: 200 });
      }
      return new Response('Forbidden', { status: 403 });
    }

    if (url.pathname === '/webhook/meta' && request.method === 'POST') {
      try {
        const body = await request.json() as any;
        const entry = body?.entry?.[0];
        const changes = entry?.changes?.[0];
        const value = changes?.value;
        const messages = value?.messages;

        if (messages && messages.length > 0) {
          const message = messages[0];
          const from = message.from;
          const text = message.text?.body || '';

          const openai = new OpenAIService(env.OPENAI_API_KEY);
          const meta = new MetaWhatsAppService(env.META_PHONE_NUMBER_ID, env.META_ACCESS_TOKEN);
          const calendar = new CalendarService(env.GOOGLE_SERVICE_ACCOUNT_EMAIL, env.GOOGLE_PRIVATE_KEY, env.GOOGLE_CALENDAR_ID);
          const handler = new WhatsAppHandler(supabase, openai, meta as any, calendar);

          await handler.handleIncomingMessage(`whatsapp:+${from}`, text, env);

          // Cancelar follow-ups cuando el lead responde
          const followupService = new FollowupService(supabase);
          await followupService.cancelarPorRespuesta('', from);
        }

        return new Response('OK', { status: 200 });
      } catch (error) {
        console.error('Meta Webhook Error:', error);
        return new Response('OK', { status: 200 });
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEST: Verificar videos pendientes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/test-videos') {
      console.log('ğŸ§ª TEST: Forzando verificaciÃ³n de videos...');
      await verificarVideosPendientes(supabase, new MetaWhatsAppService(env.META_PHONE_NUMBER_ID, env.META_ACCESS_TOKEN), env);
      return corsResponse(JSON.stringify({ ok: true, message: 'Videos verificados' }));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEST: Verificar follow-ups pendientes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/test-followups') {
      console.log('ğŸ§ª TEST: Forzando verificaciÃ³n de follow-ups...');
      const followupService = new FollowupService(supabase);
      const meta = new MetaWhatsAppService(env.META_PHONE_NUMBER_ID, env.META_ACCESS_TOKEN);
      const result = await followupService.procesarFollowupsPendientes(async (phone, message) => {
        try {
          await meta.sendWhatsAppMessage(phone, message);
          return true;
        } catch (e) {
          console.log('Error enviando follow-up:', e);
          return false;
        }
      });
      return corsResponse(JSON.stringify({ ok: true, ...result }));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TEST: Generar video semanal manualmente
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (url.pathname === '/test-video-semanal') {
      console.log('ğŸ§ª TEST: Generando video semanal de logros...');
      const meta = new MetaWhatsAppService(env.META_PHONE_NUMBER_ID, env.META_ACCESS_TOKEN);
      await generarVideoSemanalLogros(supabase, meta, env);
      return corsResponse(JSON.stringify({ ok: true, message: 'Video semanal iniciado. El CRON lo enviarÃ¡ cuando estÃ© listo.' }));
    }

    return corsResponse(JSON.stringify({ error: 'Not Found' }), 404);
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CRON JOBS - Mensajes automÃ¡ticos
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext): Promise<void> {
    const supabase = new SupabaseService(env.SUPABASE_URL, env.SUPABASE_ANON_KEY);
    const twilio = new TwilioService(env.TWILIO_ACCOUNT_SID, env.TWILIO_AUTH_TOKEN, env.TWILIO_PHONE_NUMBER);
    const meta = new MetaWhatsAppService(env.META_PHONE_NUMBER_ID, env.META_ACCESS_TOKEN);

    const now = new Date();
    const mexicoHour = (now.getUTCHours() - 6 + 24) % 24;
    const dayOfWeek = now.getUTCDay();

    console.log(`â° Cron ejecutado: ${mexicoHour}:00 MÃ©xico, dÃ­a ${dayOfWeek}`);

    // Obtener vendedores activos
    const { data: vendedores } = await supabase.client
      .from('team_members')
      .select('*')
      .eq('role', 'vendedor')
      .eq('active', true);

    // 9am: Felicitaciones de cumpleaÃ±os
    if (mexicoHour === 9) {
      console.log('ğŸ‚ Enviando felicitaciones...');
      await enviarFelicitaciones(supabase, twilio);
    }

    // 8am L-V: Briefing matutino
    if (mexicoHour === 8 && dayOfWeek >= 1 && dayOfWeek <= 5 && vendedores) {
      console.log('ğŸ“… Enviando briefing matutino...');
      for (const v of vendedores) {
        if (!v.phone) continue;
        await enviarBriefingMatutino(supabase, twilio, v);
      }
    }

    // 7pm L-V: Recap del dÃ­a
    if (mexicoHour === 19 && dayOfWeek >= 1 && dayOfWeek <= 5 && vendedores) {
      console.log('ğŸŒ™ Enviando recap del dÃ­a...');
      for (const v of vendedores) {
        if (!v.phone) continue;
        await enviarRecapDiario(twilio, v);
      }
    }

    // Viernes 6pm: Video semanal de logros con Veo 3
    if (mexicoHour === 18 && dayOfWeek === 5) {
      console.log('ğŸ¬ Generando video semanal de logros...');
      await generarVideoSemanalLogros(supabase, meta, env);
    }

    // SÃ¡bado 12pm: Recap semanal
    if (mexicoHour === 12 && dayOfWeek === 6 && vendedores) {
      console.log('ğŸ“Š Enviando recap semanal...');
      for (const v of vendedores) {
        if (!v.phone) continue;
        await enviarRecapSemanal(supabase, twilio, v);
      }
    }

    // RECORDATORIOS DE CITAS - cada ejecuciÃ³n del cron
    console.log('ğŸ”” Verificando recordatorios de citas...');
    await enviarRecordatoriosCitas(supabase, twilio);

    // Verificar videos pendientes
    console.log('ğŸ¬ Verificando videos pendientes...');
    await verificarVideosPendientes(supabase, meta, env);

    // FOLLOW-UPS AUTOMÃTICOS
    console.log('ğŸ“¬ Procesando follow-ups pendientes...');
    const followupService = new FollowupService(supabase);
    await followupService.procesarFollowupsPendientes(async (phone, message) => {
      try {
        await meta.sendWhatsAppMessage(phone, message);
        return true;
      } catch (e) {
        console.log('Error enviando follow-up:', e);
        return false;
      }
    });

    // 10am L-V: Alertas de estancamiento
    if (mexicoHour === 10 && dayOfWeek >= 1 && dayOfWeek <= 5) {
      console.log('âš ï¸ Verificando leads estancados...');
      await verificarLeadsEstancados(supabase, twilio);
      console.log('ğŸ‘” Enviando recordatorios a asesores...');
      await recordatorioAsesores(supabase, twilio);
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES DE MENSAJES AUTOMÃTICOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function verificarLeadsEstancados(supabase: SupabaseService, twilio: TwilioService): Promise<void> {
  const prioridadStatus: Record<string, number> = {
    'scheduled': 1,
    'contacted': 2,
    'new': 3
  };
  const accionStatus: Record<string, string> = {
    'scheduled': 'pendiente confirmar visita',
    'contacted': 'en espera de respuesta',
    'new': 'sin contactar'
  };

  for (const [status, dias] of Object.entries({ 'scheduled': 2, 'contacted': 3, 'new': 1 })) {
    const fechaLimite = new Date();
    fechaLimite.setDate(fechaLimite.getDate() - dias);

    const { data: leads } = await supabase.client
      .from('leads')
      .select('*, team_members!leads_assigned_to_fkey(name, phone)')
      .eq('status', status)
      .lt('updated_at', fechaLimite.toISOString());

    if (!leads || leads.length === 0) continue;

    const porVendedor: Record<string, any[]> = {};
    for (const lead of leads) {
      const vendedor = lead.team_members;
      if (!vendedor?.phone) continue;
      if (!porVendedor[vendedor.phone]) porVendedor[vendedor.phone] = [];
      porVendedor[vendedor.phone].push(lead);
    }

    for (const [phone, leadsVendedor] of Object.entries(porVendedor)) {
      const mensaje = `âš ï¸ *ALERTA: ${leadsVendedor.length} lead(s) estancado(s)*\n\n` +
        leadsVendedor.slice(0, 5).map((l: any) => 
          `â€¢ ${l.name || 'Sin nombre'} - ${accionStatus[status]}`
        ).join('\n') +
        (leadsVendedor.length > 5 ? `\n...y ${leadsVendedor.length - 5} mÃ¡s` : '') +
        `\n\nğŸ‘‰ Actualiza su status en el CRM`;

      await twilio.sendWhatsAppMessage(phone, mensaje);
    }
  }
}

async function enviarFelicitaciones(supabase: SupabaseService, twilio: TwilioService): Promise<void> {
  const hoy = new Date();
  const mes = String(hoy.getMonth() + 1).padStart(2, '0');
  const dia = String(hoy.getDate()).padStart(2, '0');
  const fechaHoy = `${mes}-${dia}`;

  const { data: cumples } = await supabase.client
    .from('team_members')
    .select('*')
    .like('birthday', `%-${fechaHoy}`);

  for (const persona of cumples || []) {
    if (!persona.phone) continue;
    const mensaje = `ğŸ‚ *Â¡Feliz CumpleaÃ±os ${persona.name}!* ğŸ‰\n\nTodo el equipo de Santa Rita te desea un dÃ­a increÃ­ble. Â¡Que se cumplan todos tus sueÃ±os! ğŸŒŸ`;
    await twilio.sendWhatsAppMessage(persona.phone, mensaje);
  }
}

async function enviarBriefingMatutino(supabase: SupabaseService, twilio: TwilioService, vendedor: any): Promise<void> {
  const hoy = new Date().toISOString().split('T')[0];

  const { data: citasHoy } = await supabase.client
    .from('appointments')
    .select('*, leads(name, phone)')
    .eq('team_member_id', vendedor.id)
    .eq('scheduled_date', hoy)
    .eq('status', 'scheduled');

  const { data: leadsAsignados } = await supabase.client
    .from('leads')
    .select('*')
    .eq('assigned_to', vendedor.id)
    .in('status', ['new', 'contacted']);

  let mensaje = `â˜€ï¸ *Buenos dÃ­as ${vendedor.name}!*\n\n`;
  mensaje += `ğŸ“… *Tu agenda de hoy:*\n`;

  if (citasHoy && citasHoy.length > 0) {
    mensaje += citasHoy.map((c: any) => 
      `â€¢ ${c.scheduled_time} - ${c.leads?.name || 'Cliente'} en ${c.property_interest || 'Por definir'}`
    ).join('\n');
  } else {
    mensaje += `Sin citas programadas`;
  }

  mensaje += `\n\nğŸ“Š *Leads pendientes:* ${leadsAsignados?.length || 0}`;
  mensaje += `\n\nÂ¡Ã‰xito hoy! ğŸ’ª`;

  await twilio.sendWhatsAppMessage(vendedor.phone, mensaje);
}

async function enviarRecapDiario(twilio: TwilioService, vendedor: any): Promise<void> {
  const mensaje = `ğŸŒ™ *Resumen del dÃ­a, ${vendedor.name}*\n\n` +
    `Gracias por tu esfuerzo hoy. Recuerda actualizar el status de tus leads en el CRM.\n\n` +
    `Â¡Descansa y maÃ±ana con todo! ğŸ’ª`;

  await twilio.sendWhatsAppMessage(vendedor.phone, mensaje);
}

async function enviarRecapSemanal(supabase: SupabaseService, twilio: TwilioService, vendedor: any): Promise<void> {
  const mensaje = `ğŸ“Š *Resumen semanal, ${vendedor.name}*\n\n` +
    `Esta semana trabajaste duro. Revisa tus mÃ©tricas en el CRM.\n\n` +
    `Â¡Disfruta tu fin de semana! ğŸ‰`;

  await twilio.sendWhatsAppMessage(vendedor.phone, mensaje);
}

async function enviarRecordatoriosCitas(supabase: SupabaseService, twilio: TwilioService): Promise<void> {
  const ahora = new Date();
  const en24h = new Date(ahora.getTime() + 24 * 60 * 60 * 1000);
  const en2h = new Date(ahora.getTime() + 2 * 60 * 60 * 1000);

  // Recordatorio 24h antes
  const { data: citas24h } = await supabase.client
    .from('appointments')
    .select('*, leads(name, phone), team_members(name, phone)')
    .eq('status', 'scheduled')
    .eq('reminder_24h_sent', false)
    .gte('scheduled_date', ahora.toISOString().split('T')[0])
    .lte('scheduled_date', en24h.toISOString().split('T')[0]);

  for (const cita of citas24h || []) {
    const lead = cita.leads;
    if (!lead?.phone) continue;

    const fecha = cita.scheduled_date;
    const hora = cita.scheduled_time || '12:00';

    const mensaje = `ğŸ“… *Recordatorio de tu cita maÃ±ana*\n\n` +
      `Hola ${lead.name}, te recordamos tu cita:\n` +
      `ğŸ“ ${cita.property_interest || 'Santa Rita'}\n` +
      `ğŸ—“ï¸ ${fecha} a las ${hora}\n\n` +
      `Â¡Te esperamos! ğŸ `;

    await twilio.sendWhatsAppMessage(lead.phone, mensaje);
    await supabase.client
      .from('appointments')
      .update({ reminder_24h_sent: true })
      .eq('id', cita.id);
  }

  // Recordatorio 2h antes
  const { data: citas2h } = await supabase.client
    .from('appointments')
    .select('*, leads(name, phone), team_members(name, phone)')
    .eq('status', 'scheduled')
    .eq('reminder_2h_sent', false)
    .gte('scheduled_date', ahora.toISOString().split('T')[0])
    .lte('scheduled_date', en2h.toISOString().split('T')[0]);

  for (const cita of citas2h || []) {
    const lead = cita.leads;
    if (!lead?.phone) continue;

    const mensaje = `â° *Tu cita es en 2 horas*\n\n` +
      `${lead.name}, te esperamos en ${cita.property_interest || 'Santa Rita'}.\n\n` +
      `Â¿Necesitas indicaciones? Responde a este mensaje. ğŸ“`;

    await twilio.sendWhatsAppMessage(lead.phone, mensaje);
    await supabase.client
      .from('appointments')
      .update({ reminder_2h_sent: true })
      .eq('id', cita.id);
  }
}

async function recordatorioAsesores(supabase: SupabaseService, twilio: TwilioService): Promise<void> {
  const { data: vendedores } = await supabase.client
    .from('team_members')
    .select('*')
    .eq('role', 'vendedor')
    .eq('active', true);

  for (const v of vendedores || []) {
    if (!v.phone) continue;

    const { data: leadsSinContactar } = await supabase.client
      .from('leads')
      .select('*')
      .eq('assigned_to', v.id)
      .eq('status', 'new');

    if (leadsSinContactar && leadsSinContactar.length > 0) {
      const mensaje = `ğŸ‘” *Recordatorio de seguimiento*\n\n` +
        `${v.name}, tienes ${leadsSinContactar.length} lead(s) nuevos sin contactar.\n\n` +
        `RevÃ­salos en el CRM y mÃ¡rcalos como contactados.`;

      await twilio.sendWhatsAppMessage(v.phone, mensaje);
    }
  }
}

async function verificarVideosPendientes(supabase: SupabaseService, meta: MetaWhatsAppService, env: any): Promise<void> {
  const { data: pendientes } = await supabase.client
    .from('pending_videos')
    .select('*')
    .eq('sent', false)
    .limit(5);

  if (!pendientes || pendientes.length === 0) {
    console.log('ğŸ“­ No hay videos pendientes');
    return;
  }

  console.log(`ğŸ¬ Procesando ${pendientes.length} videos pendientes`);

  for (const video of pendientes) {
    console.log(`ğŸ” Verificando video: ${video.id} - ${video.lead_name}`);
    try {
      // Verificar estado de la operaciÃ³n en Google
      console.log(`ğŸ“¡ Consultando Google: ${video.operation_id}`);
      const statusResponse = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/${video.operation_id}`,
        {
          headers: { 'x-goog-api-key': env.GEMINI_API_KEY }
        }
      );

      console.log(`ğŸ“¡ Google response status: ${statusResponse.status}`);

      if (!statusResponse.ok) {
        const errorText = await statusResponse.text();
        console.log(`âš ï¸ Error verificando video ${video.id}: ${errorText}`);
        continue;
      }

      const status = await statusResponse.json() as any;
      console.log(`ğŸ“¡ Video done: ${status.done}`);
      console.log(`ğŸ“¦ Respuesta Google:`, JSON.stringify(status).substring(0, 500));

      if (status.done) {
        // Intentar mÃºltiples rutas para encontrar el URI del video
        const videoUri = 
          status.response?.generateVideoResponse?.generatedSamples?.[0]?.video?.uri ||
          status.response?.generatedSamples?.[0]?.video?.uri ||
          status.result?.videos?.[0]?.uri ||
          status.videos?.[0]?.uri;
        
        console.log(`ğŸ” URI encontrado: ${videoUri ? 'SÃ' : 'NO'}`);
        
        if (videoUri) {
          console.log(`ğŸ“¥ Video URI: ${videoUri.substring(0, 80)}...`);
          
          // âš ï¸ MARCAR COMO ENVIADO ANTES para evitar spam si el cron corre mÃºltiples veces
          await supabase.client
            .from('pending_videos')
            .update({ sent: true, completed_at: new Date().toISOString(), video_url: videoUri })
            .eq('id', video.id);
          
          try {
            // 1. Descargar video de Google (requiere API key)
            console.log(`ğŸ“¥ Descargando video de Google...`);
            const videoResponse = await fetch(videoUri, {
              headers: { 'x-goog-api-key': env.GEMINI_API_KEY }
            });
            
            if (!videoResponse.ok) {
              console.log(`âŒ Error descargando video: ${videoResponse.status}`);
              return;
            }
            
            const videoBuffer = await videoResponse.arrayBuffer();
            console.log(`âœ… Video descargado: ${videoBuffer.byteLength} bytes`);
            
            // 2. Subir a Meta
            const mediaId = await meta.uploadVideoFromBuffer(videoBuffer);
            console.log(`âœ… Video subido a Meta: ${mediaId}`);
            
            // 3. Enviar por WhatsApp
            if (video.lead_phone === 'TEAM_WEEKLY') {
              console.log('ğŸ“¤ Enviando video semanal a todo el equipo...');
              
              const { data: equipo } = await supabase.client
                .from('team_members')
                .select('phone, name')
                .in('role', ['vendedor', 'admin'])
                .eq('active', true);

              for (const miembro of equipo || []) {
                if (!miembro.phone) continue;
                try {
                  await meta.sendWhatsAppVideoById(miembro.phone, mediaId, 
                    `ğŸ¬ *Â¡Video de la semana!*\n\nğŸ† ${video.desarrollo}\n\nÂ¡Excelente trabajo equipo! ğŸ’ªğŸ”¥`);
                  console.log(`âœ… Video semanal enviado a ${miembro.name}`);
                } catch (e: any) {
                  console.log(`âš ï¸ Error enviando video a ${miembro.name}: ${e.message}`);
                }
              }
            } else {
              // Video individual (bienvenida)
              await meta.sendWhatsAppVideoById(video.lead_phone, mediaId, 
                `ğŸ¬ *Â¡${video.lead_name}, este video es para ti!*\n\nTu futuro hogar en *${video.desarrollo}* te espera.`);
              console.log(`âœ… Video enviado a ${video.lead_name}`);
            }
          } catch (downloadError: any) {
            console.log(`âŒ Error en flujo de video: ${downloadError.message}`);
          }

        } else if (status.error) {
          console.log(`âŒ Video fallido: ${status.error.message}`);
          await supabase.client
            .from('pending_videos')
            .update({ sent: true, completed_at: new Date().toISOString(), video_url: `ERROR: ${status.error.message}` })
            .eq('id', video.id);
        } else {
          console.log(`âš ï¸ Video completado pero sin URI`);
          console.log(`ğŸ“¦ Estructura completa:`, JSON.stringify(status));
          // Marcar como enviado para evitar reintentos infinitos
          await supabase.client
            .from('pending_videos')
            .update({ sent: true, completed_at: new Date().toISOString(), video_url: 'ERROR: No URI found' })
            .eq('id', video.id);
        }
      } else {
        console.log(`â³ Video ${video.id} aÃºn procesando...`);
      }
    } catch (e: any) {
      console.log(`âŒ Error procesando video ${video.id}: ${e.message}`);
      // Marcar como enviado para evitar reintentos infinitos
      await supabase.client
        .from('pending_videos')
        .update({ sent: true, completed_at: new Date().toISOString(), video_url: `ERROR: ${e.message}` })
        .eq('id', video.id);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIDEO SEMANAL DE LOGROS - Viernes 6pm
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generarVideoSemanalLogros(supabase: SupabaseService, meta: MetaWhatsAppService, env: any): Promise<void> {
  try {
    // Calcular fechas de la semana (lunes a viernes)
    const hoy = new Date();
    const inicioSemana = new Date(hoy);
    inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes
    inicioSemana.setHours(0, 0, 0, 0);
    
    const finSemana = new Date(hoy);
    finSemana.setHours(23, 59, 59, 999);

    // Obtener mÃ©tricas de la semana
    const { data: leadsNuevos } = await supabase.client
      .from('leads')
      .select('id', { count: 'exact' })
      .gte('created_at', inicioSemana.toISOString())
      .lte('created_at', finSemana.toISOString());

    const { data: citasAgendadas } = await supabase.client
      .from('appointments')
      .select('id', { count: 'exact' })
      .gte('created_at', inicioSemana.toISOString())
      .lte('created_at', finSemana.toISOString());

    const { data: cierres } = await supabase.client
      .from('leads')
      .select('id, assigned_to', { count: 'exact' })
      .eq('status', 'closed')
      .gte('status_changed_at', inicioSemana.toISOString())
      .lte('status_changed_at', finSemana.toISOString());

    // Calcular top performer
    const { data: vendedores } = await supabase.client
      .from('team_members')
      .select('id, name, phone')
      .eq('role', 'vendedor')
      .eq('active', true);

    let topPerformer = { name: 'El equipo', cierres: 0 };
    if (vendedores && cierres) {
      const cierresPorVendedor: Record<string, number> = {};
      for (const c of cierres) {
        if (c.assigned_to) {
          cierresPorVendedor[c.assigned_to] = (cierresPorVendedor[c.assigned_to] || 0) + 1;
        }
      }
      
      let maxCierres = 0;
      for (const [vendedorId, count] of Object.entries(cierresPorVendedor)) {
        if (count > maxCierres) {
          maxCierres = count;
          const vendedor = vendedores.find(v => v.id === vendedorId);
          if (vendedor) {
            topPerformer = { name: vendedor.name.split(' ')[0], cierres: count };
          }
        }
      }
    }

    const numLeads = leadsNuevos?.length || 0;
    const numCitas = citasAgendadas?.length || 0;
    const numCierres = cierres?.length || 0;

    console.log(`ğŸ“Š MÃ©tricas semana: ${numLeads} leads, ${numCitas} citas, ${numCierres} cierres`);

    // Primero enviar mensaje de texto con mÃ©tricas
    const mensajeTexto = `ğŸ† *Â¡RESUMEN SEMANAL EQUIPO SANTA RITA!*\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
      `ğŸ“Š *Esta semana logramos:*\n\n` +
      `ğŸ‘¥ *${numLeads}* leads nuevos\n` +
      `ğŸ“… *${numCitas}* citas agendadas\n` +
      `âœ… *${numCierres}* cierres\n\n` +
      `ğŸ¥‡ *Top performer:* ${topPerformer.name}${topPerformer.cierres > 0 ? ` (${topPerformer.cierres} cierres)` : ''}\n\n` +
      `Â¡Excelente trabajo equipo! ğŸ”¥\n` +
      `El video motivacional viene en camino... ğŸ¬`;

    // Enviar a todos los vendedores y admins
    const { data: equipo } = await supabase.client
      .from('team_members')
      .select('phone, name')
      .in('role', ['vendedor', 'admin'])
      .eq('active', true);

    for (const miembro of equipo || []) {
      if (!miembro.phone) continue;
      try {
        await meta.sendWhatsAppMessage(miembro.phone, mensajeTexto);
        console.log(`âœ… Resumen enviado a ${miembro.name}`);
      } catch (e) {
        console.log(`âš ï¸ Error enviando a ${miembro.name}`);
      }
    }

    // Generar video con Veo 3
    const promptVideo = `Celebratory office scene with Mexican real estate team. 
Text overlay appears: "SEMANA EXITOSA" then "${numLeads} LEADS | ${numCitas} CITAS | ${numCierres} CIERRES".
Then "TOP: ${topPerformer.name}" with trophy emoji.
Team clapping and celebrating. Professional, modern office background.
Upbeat motivational feeling. 8 seconds. No audio needed.`;

    console.log('ğŸ¬ Generando video semanal con Veo 3...');

    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/veo-3.0-fast-generate-001:predictLongRunning', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-goog-api-key': env.GEMINI_API_KEY
      },
      body: JSON.stringify({
        instances: [{
          prompt: promptVideo
        }],
        parameters: {
          aspectRatio: "9:16",
          durationSeconds: 8
        }
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.log('âš ï¸ Veo 3 error:', errorText);
      return;
    }

    const result = await response.json();
    const operationName = result.name;
    
    if (!operationName) {
      console.log('âš ï¸ No operation name para video semanal');
      return;
    }

    console.log('ğŸ¬ Video semanal en proceso:', operationName);

    // Guardar para que el CRON lo procese y envÃ­e
    // Usamos un telÃ©fono especial "TEAM_WEEKLY" para identificar que es video grupal
    await supabase.client
      .from('pending_videos')
      .insert({
        operation_id: operationName,
        lead_phone: 'TEAM_WEEKLY',
        lead_name: 'Equipo Santa Rita',
        desarrollo: `Semana: ${numLeads}L/${numCitas}C/${numCierres}V`,
        sent: false
      });

    console.log('âœ… Video semanal programado para envÃ­o');

  } catch (error) {
    console.error('âŒ Error generando video semanal:', error);
  }
}
