name = "sara-backend"
main = "src/index.ts"
compatibility_date = "2024-11-18"
compatibility_flags = ["nodejs_compat"]
# NOTE: usage_model is now configured in Cloudflare Dashboard > Worker Settings
# Set to "Standard" (formerly "Unbound") for 1000 subrequest limit instead of 50

# ═══════════════════════════════════════════════════════════════════════════
# PRODUCTION - Default environment
# Deploy: npx wrangler deploy
# URL: https://sara-backend.edson-633.workers.dev
# ═══════════════════════════════════════════════════════════════════════════

[triggers]
# Crons (máximo 5 en Cloudflare free) - HORAS EN UTC, México = UTC-6:
#
# */2 * * * *   → Cada 2 min (24/7):
#   - Recordatorios de citas (24h y 2h antes)
#   - Encuestas post-cita
#   - Follow-ups automáticos pendientes
#   - Propuestas de follow-up a vendedores
#   - Detectar no-shows
#   - Timeout confirmaciones vendedor
#   - Flujo post-visita
#   - Videos pendientes (Veo 3)
#   - Lead scoring (cada 2h, 8am-8pm MX)
#   - Re-engagement leads sin respuesta (cada hora, 9am-7pm MX L-V)
#   - Verificar pending llamadas Retell (cada 30min)
#   - Cumpleaños, alertas leads fríos/calientes (horarios fijos L-V)
#   - Follow-up 24h leads nuevos (10am + 4pm MX)
#   - Re-engagement directo leads fríos (11am + 5pm MX L-S)
#   - Coaching, nurturing, hipotecas (días específicos)
#   - Aplicar precios programados (día 1, 12 AM MX)
#
# 0 14 * * 1-5  → 2 PM UTC = 8 AM México (L-V):
#   - Reactivar ventanas 24h equipo (7:55 AM MX)
#   - Briefing matutino vendedores (template briefing_matutino)
#   - Reporte diario consolidado CEO
#   - Alertas proactivas CEO
#   - Reporte semanal CEO (lunes)
#   - Reportes semanales vendedores/asesores/marketing (lunes)
#   - Seguimiento hipotecas (mar/jue)
#   - Remarketing leads fríos (miércoles)
#   - Reactivación leads perdidos (1er lunes mes)
#   - Reportes mensuales CEO/vendedores/asesores/marketing (día 1)
#
# 0 1 * * *     → 1 AM UTC = 7 PM México (diario):
#   - Reporte diario vendedores (template reporte_vendedor)
#   - Reporte diario asesores (template reporte_asesor)
#   - Reporte diario marketing
#   - Recap semanal vendedores (sábado 2 PM MX → mexicoHour=14)
#   - Video semanal de logros (sábado)
#   - Backup diario
#
crons = ["*/2 * * * *", "0 14 * * 1-5", "0 1 * * *"]

# KV Namespace para cache (PRODUCTION)
[[kv_namespaces]]
binding = "SARA_CACHE"
id = "e4dece3a573c470dab91996f9f4879b8"

# ═══════════════════════════════════════════════════════════════════════════
# STAGING - Environment de pruebas
# Deploy: npx wrangler deploy --env staging
# URL: https://sara-backend-staging.edson-633.workers.dev
# ═══════════════════════════════════════════════════════════════════════════

[env.staging]
name = "sara-backend-staging"

# NO CRONS en staging (evita spam + límite de 5 crons en Cloudflare free)
[env.staging.triggers]
crons = []

# KV Namespace para cache (STAGING - separado de producción)
[[env.staging.kv_namespaces]]
binding = "SARA_CACHE"
id = "1b0b7ddc2dc7459fa7f9ed2e00caab36"
